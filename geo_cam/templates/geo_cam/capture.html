{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tomar foto con GPS</title>
  <style>
    :root { --glass: rgba(0,0,0,.82); }
    *{box-sizing:border-box}
    body{margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter}
    .wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    .box{width:100%;max-width:960px;aspect-ratio:9/16;background:#000;position:relative;overflow:hidden}
    video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    /* HUD */
    .hud{position:absolute;inset:0;pointer-events:none}
    .panel{position:absolute;left:14px;right:14px;bottom:14px;background:var(--glass);border-radius:14px;display:flex;gap:12px;padding:12px}
    .map{width:140px;height:140px;border-radius:10px;overflow:hidden;background:#111;flex:0 0 auto}
    .txt{font-size:13px;line-height:1.3;word-break:break-word}
    .ttl{font-weight:700;font-size:16px;margin-bottom:6px}
    /* Barra superior */
    .topbar{position:absolute;left:0;right:0;top:0;display:flex;justify-content:space-between;align-items:center;padding:10px 12px;gap:8px;pointer-events:none}
    .btn-icon{pointer-events:auto;width:40px;height:40px;border-radius:999px;display:grid;place-items:center;background:rgba(0,0,0,.55);color:#fff;border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(2px)}
    .btn-icon:active{transform:scale(.96)}
    /* Disparador */
    .bar{position:absolute;left:0;right:0;bottom:8px;display:flex;justify-content:center;padding:10px 0}
    .shot{pointer-events:auto;width:74px;height:74px;border-radius:999px;border:6px solid rgba(255,255,255,.75);background:rgba(0,0,0,.15)}
    /* Input t√≠tulo opcional */
    .title-box{position:absolute;left:16px;right:16px;top:56px;display:flex;gap:8px;pointer-events:auto}
    .input{flex:1;border-radius:10px;border:1px solid #475569;background:#0b1220;color:#fff;padding:10px 12px}
    .note{position:absolute;left:16px;right:16px;top:100px;color:#cbd5e1;font-size:12px}
    /* Toast */
    .toast{position:absolute;left:50%;bottom:90px;transform:translateX(-50%);background:rgba(0,0,0,.8);padding:10px 14px;border-radius:999px;font-size:14px;opacity:0;transition:opacity .25s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
<div class="wrap">
  <div class="box">
    <video id="v" playsinline autoplay muted></video>

    {% if titulo_required %}
      <div class="title-box">
        <input id="titulo" class="input" placeholder="T√≠tulo" value="{{ titulo_default|default:'' }}">
      </div>
      <div class="note">Ingresa un t√≠tulo para esta foto</div>
    {% endif %}

    <!-- top bar -->
    <div class="topbar">
      <!-- volver -->
      <button id="close" class="btn-icon" type="button" title="Volver" aria-label="Volver">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
      </button>
      <!-- derecha: galer√≠a + flip -->
      <div style="display:flex;gap:8px;pointer-events:auto">
        <a class="btn-icon" href="{% url 'geo_cam:gallery' %}" title="Galer√≠a" aria-label="Galer√≠a">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        </a>
        <button id="flip" class="btn-icon" type="button" title="Cambiar c√°mara" aria-label="Cambiar c√°mara">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 0 1-9 9"/><path d="M3 12a9 9 0 0 1 9-9"/><polyline points="3 3 3 9 9 9"/><polyline points="21 21 21 15 15 15"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- HUD -->
    <div class="hud">
      <div class="panel">
        <div class="map" id="mapBox"><img id="m" alt></div>
        <div class="txt">
          <div class="ttl" id="l1">‚Äî</div>
          <div id="l2">‚Äî</div>
          <div id="l3">Lat ‚Äî Long ‚Äî</div>
          <div id="l4">‚Äî</div>
          <div id="l5">‚Äî</div>
        </div>
      </div>
      <div class="bar">
        <button id="shot" class="shot" type="button" aria-label="Capturar"></button>
      </div>
    </div>

    <div id="toast" class="toast">Foto guardada ‚úì</div>
  </div>
</div>

<script>
const UPLOAD_URL = "{% url 'geo_cam:upload' %}";
const CSRF = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '';

/* TOKEN Mapbox: usa el tuyo; si lo dejas vac√≠o, el recuadro se esconde */
const MAPBOX_TOKEN = "pk.eyJ1IjoiMjY3MjQ2NzkzIiwiYSI6ImNtZ3psNmlraDE0cWMya3B4OTgxcGt4ZGEifQ.D1HvNPiOQxLHHKTG7Glqbg";  // ‚Üê PON TU TOKEN

const v = document.getElementById('v');
const m = document.getElementById('m');
const mapBox = document.getElementById('mapBox');
const toast = document.getElementById('toast');
const l1=document.getElementById('l1'), l2=document.getElementById('l2'),
      l3=document.getElementById('l3'), l4=document.getElementById('l4'), l5=document.getElementById('l5');

let stream=null, facing='environment', gps=null, addr=null, mapReady=false;

function showToast(msg="Foto guardada ‚úì"){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1200); }
function pad(n){return String(n).padStart(2,'0')}
function tzStr(d=new Date()){const off=-d.getTimezoneOffset();const s=off>=0?'+':'-';const hh=pad(Math.floor(Math.abs(off)/60));const mm=pad(Math.abs(off)%60);return `GMT ${s}${hh}:${mm}`;}
function fmtDT(d=new Date()){return new Intl.DateTimeFormat('es-CL',{weekday:'long',day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true}).format(d)}
function deg(v){return Number(v).toFixed(6)+'¬∞'}

async function startStream(){
  try{
    if(stream){stream.getTracks().forEach(t=>t.stop());}
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:facing}, audio:false});
    v.srcObject = stream; await v.play().catch(()=>{});
  }catch(e){ alert('No se pudo acceder a la c√°mara. Revisa permisos del navegador.'); }
}

async function geocode(lat,lng){
  if(!MAPBOX_TOKEN){
    addr = {title:'Ubicaci√≥n', line2:'', countryCode:''};
    mapBox.style.display='none';
    paintHUD(); return;
  }
  try{
    const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?limit=1&language=es&access_token=${encodeURIComponent(MAPBOX_TOKEN)}`;
    const r = await fetch(url,{cache:'no-store'}); const j=await r.json(); const f=j.features?.[0];
    const ctx=(f?.context||[]).reduce((m,x)=>{m[x.id.split('.')[0]]=x;return m;}, {});
    const country=(ctx.country?.text_es||ctx.country?.text||'').trim();
    const region =(ctx.region?.text_es ||ctx.region?.text ||'').trim();
    const place  =(ctx.place?.text_es  ||ctx.place?.text  ||f?.text_es||f?.text||'').trim();
    const code=(ctx.country?.short_code||'').toUpperCase();
    const title=[place,region,country].filter(Boolean).join(', ');
    const line2=f?.place_name_es||f?.place_name||'';
    addr={title,line2,countryCode:code};
  }catch{
    addr={title:'Ubicaci√≥n',line2:'',countryCode:''};
  }
  paintHUD();
}

function staticMap(lat,lng,size=320,zoom=18){
  if(!MAPBOX_TOKEN){ mapReady=false; return; }
  try{
    m.crossOrigin = "anonymous";     // para poder dibujar en canvas
    m.onload = ()=>{ mapReady=true; };
    m.onerror= ()=>{ mapReady=false; };
    // pin rojo visible
    m.src=`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/static/pin-s+ff0000(${lng},${lat})/${lng},${lat},${zoom},0/${size}x${size}@2x?access_token=${encodeURIComponent(MAPBOX_TOKEN)}`;
  }catch{ mapReady=false; }
}

function paintHUD(){
  const a=addr||{}, g=gps;
  l1.textContent = a.title || '‚Äî';
  l2.textContent = a.line2 || '‚Äî';
  l3.textContent = g ? `Lat ${deg(g.lat)} Long ${deg(g.lng)}` : 'Lat ‚Äî Long ‚Äî';
  const ts = g?.ts ? new Date(g.ts) : new Date();
  l4.textContent = fmtDT(ts);
  l5.textContent = tzStr(ts);
  if(g) staticMap(g.lat, g.lng);
}

function explainGeoErr(err){
  if(!err || typeof err.code==='undefined') return 'üìç Error de geolocalizaci√≥n';
  if(err.code===1) return 'üìç Permiso denegado (act√≠valo para este sitio)';
  if(err.code===2) return 'üìç Ubicaci√≥n no disponible (sin se√±al)';
  if(err.code===3) return 'üìç Tiempo de espera agotado';
  return 'üìç Error de geolocalizaci√≥n';
}

async function demandGPS(){
  if(!('geolocation' in navigator)){ alert('Tu navegador no soporta geolocalizaci√≥n'); return false; }
  const OPTS={enableHighAccuracy:true, maximumAge:15000, timeout:30000};
  try{
    const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,OPTS));
    gps = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy, ts: Date.now() };
    paintHUD();
    geocode(gps.lat, gps.lng);
    return true;
  }catch(e){
    alert(explainGeoErr(e));
    return false;
  }
}

/* Dibuja la placa estilo ‚Äúplantilla avanzada‚Äù */
function drawStampOnCanvas(ctx, W, H){
  const margin = Math.round(W*0.02);
  const panelH = Math.round(H*0.24);
  const panelW = Math.min(W - margin*2, Math.round(W*0.92));
  const x = margin, y = H - panelH - margin, r = Math.round(panelH*0.08);

  function rrect(x,y,w,h,rr){
    rr=Math.min(rr,w/2,h/2);
    ctx.beginPath(); ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath();
  }

  // panel transl√∫cido
  ctx.save(); ctx.globalAlpha=.85; ctx.fillStyle='#000';
  rrect(x,y,panelW,panelH,r); ctx.fill(); ctx.restore();

  const pad  = Math.round(panelH*.10);
  const mapSize = Math.min(panelH - pad*2, Math.round(panelW*.33));
  const tx = x + pad + (mapReady ? (mapSize + pad) : 0);
  let ty = y + pad;

  // mini-mapa (si carg√≥)
  if (mapReady) {
    try {
      // recorte redondeado
      ctx.save();
      rrect(x+pad, y+pad, mapSize, mapSize, 10); ctx.clip();
      ctx.drawImage(m, x+pad, y+pad, mapSize, mapSize);
      ctx.restore();
    } catch {}
  }

  const g = gps, a = addr || {};
  const ttlF = Math.max(16, Math.round(panelH*.17));
  const txtF = Math.max(12, Math.round(panelH*.14));
  const gap  = Math.max(6, Math.round(panelH*.07));

  ctx.fillStyle='#fff'; ctx.textBaseline='top';
  ctx.font = `700 ${ttlF}px system-ui,-apple-system,Segoe UI,Roboto`; ctx.fillText(a.title || 'Ubicaci√≥n', tx, ty); ty += ttlF + gap;

  ctx.font = `${txtF}px system-ui,-apple-system,Segoe UI,Roboto`; ctx.fillText(a.line2 || '‚Äî', tx, ty); ty += txtF + Math.round(gap*.6);

  if (g) {
    ctx.fillText(`Lat ${deg(g.lat)} Long ${deg(g.lng)}`, tx, ty); ty += txtF + Math.round(gap*.6);
    const ts = g.ts ? new Date(g.ts) : new Date();
    ctx.fillText(`${fmtDT(ts)} ${tzStr(ts)}`, tx, ty);
  }
}

async function captureAndUpload(){
  if(!stream || !gps){ alert('Necesitamos c√°mara y GPS activos'); return; }

  const W0 = v.videoWidth || 1080, H0 = v.videoHeight || 1920;
  const maxSide = 1600, s = Math.min(1, maxSide / Math.max(W0, H0));
  const W = Math.round(W0*s), H = Math.round(H0*s);

  const c=document.createElement('canvas'); c.width=W; c.height=H;
  const ctx=c.getContext('2d');
  ctx.drawImage(v,0,0,W,H);
  drawStampOnCanvas(ctx, W, H);

  const blob = await new Promise(res=>c.toBlob(res,'image/jpeg',0.9));
  const file = new File([blob], `foto_${Date.now()}.jpg`, {type:'image/jpeg'});

  const fd = new FormData();
  if (CSRF) fd.append('csrfmiddlewaretoken', CSRF);
  fd.append('imagen', file);

  {% if titulo_required %}
    const t = (document.getElementById('titulo')?.value || '').trim();
    if(!t){ alert('Ingresa un t√≠tulo'); return; }
    fd.append('titulo_manual', t);
  {% else %}
    {% if titulo_default %} fd.append('titulo_manual', "{{ titulo_default|escapejs }}"); {% endif %}
  {% endif %}

  fd.append('lat', gps.lat); fd.append('lng', gps.lng);
  if(Number.isFinite(gps.acc)) fd.append('acc', Math.round(gps.acc));
  fd.append('client_taken_at', new Date().toISOString());

  const r = await fetch(UPLOAD_URL, {
    method:'POST',
    body:fd,
    cache:'no-store',
    credentials:'same-origin',
    headers: CSRF ? { 'X-CSRFToken': CSRF } : {}
  });

  let j=null; try{ j = await r.json(); }catch{}
  if(r.ok && j && j.ok){
    showToast();
    // nos quedamos en c√°mara
  }else{
    const msg = (j && j.error) ? j.error : `HTTP ${r.status}`;
    alert('No se pudo enviar la foto: ' + msg);
  }
}

/* Controles */
document.getElementById('flip').addEventListener('click', async ()=>{ facing = (facing==='environment'?'user':'environment'); await startStream(); });
document.getElementById('shot').addEventListener('click', captureAndUpload);
document.getElementById('close').addEventListener('click', ()=>history.back());

/* Init */
(async function(){ await startStream(); await demandGPS(); })();
</script>
</body>
</html>