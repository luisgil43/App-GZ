{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <title>Tomar foto con GPS</title>
  <style>
    :root { --glass: rgba(0,0,0,.82); }
    body{margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter}
    .wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    .box{width:100%;max-width:960px;aspect-ratio:9/16;background:#000;position:relative;overflow:hidden}
    video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}
    .hud{position:absolute;inset:0;pointer-events:none}
    .panel{position:absolute;left:16px;right:16px;bottom:16px;background:var(--glass);border-radius:14px;display:flex;gap:12px;padding:12px}
    .map{width:120px;height:120px;border-radius:10px;overflow:hidden;background:#111;flex:0 0 auto}
    .txt{font-size:13px;line-height:1.25}
    .ttl{font-weight:700;font-size:16px;margin-bottom:6px}
    .topbar{position:absolute;left:0;right:0;top:0;display:flex;justify-content:space-between;align-items:center;padding:12px 14px;gap:8px;pointer-events:none}
    .icons-right{display:flex;gap:8px}
    .btn-icon{pointer-events:auto;width:40px;height:40px;border-radius:999px;display:grid;place-items:center;background:rgba(0,0,0,.55);color:#fff;border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(2px)}
    .btn-icon:active{transform:scale(.96)}
    .bar{position:absolute;left:0;right:0;bottom:8px;display:flex;justify-content:center;padding:10px 0}
    .shot{pointer-events:auto;width:74px;height:74px;border-radius:999px;border:6px solid rgba(255,255,255,.75);background:rgba(0,0,0,.15)}
    .title-box{position:absolute;left:16px;right:16px;top:56px;display:flex;gap:8px;pointer-events:auto}
    .input{flex:1;border-radius:10px;border:1px solid #475569;background:#0b1220;color:#fff;padding:10px 12px}
    .note{position:absolute;left:16px;right:16px;top:100px;color:#cbd5e1;font-size:12px}

        /* === Overlay de previsualizaciÃ³n === */
    .preview {
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:16px;
      box-sizing:border-box;
      background:rgba(0,0,0,0.92);
      z-index:20;
    }
    .preview.hidden {
      display:none;
    }
    .preview img {
      max-width:100%;
      max-height:calc(100% - 90px);
      object-fit:contain;
      border-radius:14px;
      box-shadow:0 18px 40px rgba(0,0,0,.6);
      border:1px solid rgba(148,163,184,.3);
    }
    .preview-actions {
      margin-top:16px;
      display:flex;
      gap:10px;
    }
    .preview-btn {
      border:none;
      border-radius:999px;
      padding:10px 18px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }
    .preview-btn.primary {
      background:#22c55e;
      color:#022c22;
    }
    .preview-btn.secondary {
      background:#0f172a;
      color:#e5e7eb;
      border:1px solid #1f2937;
    }
    .preview-btn:active {
      transform:scale(.97);
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="box">
    <video id="v" playsinline autoplay muted></video>

    {% if titulo_required %}
      <div class="title-box">
        <input id="titulo" class="input" placeholder="TÃ­tulo" value="{{ titulo_default|default:'' }}">
      </div>
      <div class="note">Ingresa un tÃ­tulo para esta foto</div>
    {% endif %}

    <div class="topbar">
      {% if next_url %}
        <a class="btn-icon" href="{{ next_url|urlencode }}" title="Volver" aria-label="Volver">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"></path></svg>
        </a>
      {% else %}
        <button id="close" class="btn-icon" type="button" title="Volver" aria-label="Volver">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"></path></svg>
        </button>
      {% endif %}

      <div class="icons-right">
        <a class="btn-icon" href="{% url 'geo_cam:gallery' %}" title="GalerÃ­a" aria-label="GalerÃ­a">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>
          </svg>
        </a>
        <button id="flip" class="btn-icon" type="button" title="Cambiar cÃ¡mara" aria-label="Cambiar cÃ¡mara">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 0 1-9 9"></path><path d="M3 12a9 9 0 0 1 9-9"></path><polyline points="3 3 3 9 9 9"></polyline><polyline points="21 21 21 15 15 15"></polyline>
          </svg>
        </button>
      </div>
    </div>

        <!-- Overlay de previsualizaciÃ³n despuÃ©s de capturar -->
    <div id="previewOverlay" class="preview hidden">
      <img id="previewImg" alt="PrevisualizaciÃ³n" />

      <div class="preview-actions">
        <button type="button" id="btnRetake" class="preview-btn secondary">
          ðŸ”„ Tomar otra
        </button>
        <button type="button" id="btnUse" class="preview-btn primary">
          âœ… Usar
        </button>
      </div>
    </div>

    <div class="hud">
      <div class="panel" id="hudPanel">
        <div class="map" id="mapBox"><img id="m" alt></div>
        <div class="txt">
          <div class="ttl" id="l1">â€”</div>
          <div id="l2">â€”</div>
          <div id="l3">Lat â€” Long â€”</div>
          <div id="l4">â€”</div>
          <div id="l5">â€”</div>
        </div>
      </div>
      <div class="bar">
        <button id="shot" class="shot" type="button" aria-label="Capturar"></button>
      </div>
    </div>
  </div>
</div>

<script>
/* CSRF desde meta (o cookie si no vino) */
const CSRF = (document.querySelector('meta[name="csrf-token"]')?.content && "{{ csrf_token }}" !== "NOTPROVIDED")
  ? document.querySelector('meta[name="csrf-token"]').content
  : ((document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || "");

/* endpoint + GOOGLE KEY (navegador) */
const UPLOAD_URL = "{% url 'geo_cam:upload' %}";
const GOOGLE_KEY = "{{ google_key|default:'' }}";

const v = document.getElementById('v');
const m = document.getElementById('m');
const mapBox = document.getElementById('mapBox');
const l1 = document.getElementById('l1'), l2 = document.getElementById('l2'),
      l3 = document.getElementById('l3'), l4 = document.getElementById('l4'), l5 = document.getElementById('l5');

const previewOverlay = document.getElementById('previewOverlay');
const previewImg = document.getElementById('previewImg');
const btnRetake = document.getElementById('btnRetake');
const btnUse = document.getElementById('btnUse');

let stream = null, facing = 'environment', gps = null, addr = null, mapReady = false, lastBlob = null;

function pad(n){return String(n).padStart(2,'0')}
function tzStr(d=new Date()){const off=-d.getTimezoneOffset();const s=off>=0?'+':'-';const hh=pad(Math.floor(Math.abs(off)/60));const mm=pad(Math.abs(off)%60);return `GMT ${s}${hh}:${mm}`;}
function fmtDT(d=new Date()){return new Intl.DateTimeFormat('es-CL',{weekday:'long',day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true}).format(d)}
function deg(v){return Number(v).toFixed(6)+'Â°'}

/* ===== CÃ¡mara ===== */
async function startStream(){
  try{
    if(stream){stream.getTracks().forEach(t=>t.stop());}
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facing }, audio:false });
    }catch{
      stream = await navigator.mediaDevices.getUserMedia({ video: true, audio:false });
    }
    v.srcObject = stream; await v.play().catch(()=>{});
  }catch(e){
    alert('No se pudo acceder a la cÃ¡mara. Revisa permisos del navegador.');
  }
}

/* ===== Geocoding vÃ­a PROXY del backend ===== */
async function geocode(lat,lng){
  try{
    const r = await fetch(`/geo-cam/geocode/?lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}`, {
      cache:'no-store', credentials:'same-origin'
    });
    const j = await r.json();
    if (j.status !== "OK") {
      console.warn("Geocoding proxy status:", j.status, j.error_message || "");
      addr = {title:'UbicaciÃ³n', line2:''};
      paintHUD();
      return;
    }
    const best = j.results?.[0];
    const line2 = (best?.formatted_address || "").slice(0,120);
    let city="", region="", country="";
    (best?.address_components||[]).forEach(c=>{
      if(c.types.includes("locality")) city=c.long_name;
      if(c.types.includes("administrative_area_level_1")) region=c.long_name;
      if(c.types.includes("country")) country=c.long_name;
    });
    const title=[city,region,country].filter(Boolean).join(", ");
    addr={title: title || "UbicaciÃ³n", line2};
  }catch(e){
    console.error("Geocoding proxy fetch error:", e);
    addr={title:'UbicaciÃ³n', line2:''};
  }
  paintHUD();
}

/* ===== Static Maps con marcador (URLSearchParams correcto) ===== */
function staticMap(lat, lng){
  if(!GOOGLE_KEY){
    mapReady=false; if(mapBox) mapBox.style.display='none'; return;
  }

  const url = new URL("https://maps.googleapis.com/maps/api/staticmap");
  url.searchParams.set("center", `${lat},${lng}`);
  url.searchParams.set("zoom", "18");
  url.searchParams.set("size", "240x240"); // 120x120@2x
  url.searchParams.set("scale", "2");
  url.searchParams.set("maptype", "satellite");
  url.searchParams.set("key", GOOGLE_KEY);
  // el pin rojo por defecto
  url.searchParams.append("markers", `${lat},${lng}`);
  // cache-buster para Safari/iOS
  url.searchParams.set("cb", String(Date.now()));

  try{
    // NUNCA poner crossorigin con Static Maps (no hay CORS)
    m.removeAttribute('crossorigin');
    m.onload  = ()=>{ mapReady=true; };
    m.onerror = ()=>{
      mapReady=false;
      url.searchParams.set("maptype", "roadmap"); // fallback
      m.src = url.toString();
    };
    console.log("STATIC MAP URL =>", url.toString());
    m.src = url.toString();
  }catch(e){
    console.error("Static map error:", e);
    mapReady=false;
  }
}

function paintHUD(){
  const a=addr||{}, g=gps;
  l1.textContent = a.title || 'UbicaciÃ³n';
  l2.textContent = a.line2 || 'â€”';
  l3.textContent = g ? `Lat ${deg(g.lat)} Long ${deg(g.lng)}` : 'Lat â€” Long â€”';
  const ts = g?.ts ? new Date(g.ts) : new Date();
  l4.textContent = fmtDT(ts);
  l5.textContent = tzStr(ts);
  if(g) staticMap(g.lat, g.lng);
}

function explainGeoErr(err){
  if(!err || typeof err.code==='undefined') return 'ðŸ“ Error de geolocalizaciÃ³n';
  if(err.code===1) return 'ðŸ“ Permiso denegado (actÃ­valo para este sitio)';
  if(err.code===2) return 'ðŸ“ UbicaciÃ³n no disponible (sin seÃ±al)';
  if(err.code===3) return 'ðŸ“ Tiempo de espera agotado';
  return 'ðŸ“ Error de geolocalizaciÃ³n';
}

async function demandGPS(){
  if(!('geolocation' in navigator)){ alert('Tu navegador no soporta geolocalizaciÃ³n'); return false; }
  const OPTS={enableHighAccuracy:true, maximumAge:15000, timeout:30000};
  try{
    const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,OPTS));
    gps = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy, ts: Date.now() };
    paintHUD();
    geocode(gps.lat, gps.lng);
    return true;
  }catch(e){
    alert(explainGeoErr(e));
    return false;
  }
}

/* ===== Sello en canvas (SIN dibujar el <img> del mapa para no taint) ===== */
function drawStampOnCanvas(ctx, W, H){
  const margin = Math.round(W*0.02);
  const panelH = Math.round(H*0.24);
  const panelW = Math.min(W - margin*2, Math.round(W*0.92));
  const panelX = margin, panelY = H - panelH - margin, radius = Math.round(panelH*0.08);

  function rrect(x,y,w,h,r){
    const rr=Math.min(r,w/2,h/2);
    ctx.beginPath(); ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath();
  }

  // Panel
  ctx.save(); ctx.globalAlpha=.85; ctx.fillStyle='#000';
  rrect(panelX,panelY,panelW,panelH,radius); ctx.fill(); ctx.restore();

  const pad  = Math.round(panelH*.10);
  const mapSize = Math.min(panelH - pad*2, Math.round(panelW*.30));
  const textX = panelX + pad + (/* NO usamos mapa en canvas */ 0);
  let y = panelY + pad;

  // (IMPORTANTE) No dibujar m (Google Static Maps) para no contaminar el canvas.
  // Si quieres estampar un "placeholder" visual, dibujamos un cuadrito con un punto:
  ctx.save();
  ctx.strokeStyle = '#334155';
  ctx.lineWidth = 2;
  ctx.fillStyle = '#0f172a';
  ctx.beginPath();
  ctx.roundRect(panelX+pad, panelY+pad, mapSize, mapSize, 8);
  ctx.fill(); ctx.stroke();
  // punto rojo centrado para indicar la posiciÃ³n
  if (gps){
    ctx.beginPath();
    ctx.arc(panelX+pad+mapSize/2, panelY+pad+mapSize/2, Math.max(4, Math.round(mapSize*0.06)), 0, Math.PI*2);
    ctx.fillStyle = '#ef4444';
    ctx.fill();
  }
  ctx.restore();

  const g = gps, a = addr || {};
  const ttlF = Math.max(16, Math.round(panelH*.17));
  const txtF = Math.max(12, Math.round(panelH*.14));
  const gap  = Math.max(6, Math.round(panelH*.07));

  ctx.fillStyle='#fff'; ctx.textBaseline='top';
  ctx.font = `700 ${ttlF}px system-ui,-apple-system,Segoe UI,Roboto`;
  ctx.fillText(a.title || 'UbicaciÃ³n', textX + (mapSize + pad), y); y += ttlF + gap;

  ctx.font = `${txtF}px system-ui,-apple-system,Segoe UI,Roboto`;
  ctx.fillText(a.line2 || 'â€”', textX + (mapSize + pad), y); y += txtF + Math.round(gap*.6);

  if (g) {
    ctx.fillText(`Lat ${deg(g.lat)} Long ${deg(g.lng)}`, textX + (mapSize + pad), y); y += txtF + Math.round(gap*.6);
    const ts = g.ts ? new Date(g.ts) : new Date();
    ctx.fillText(`${fmtDT(ts)} ${tzStr(ts)}`, textX + (mapSize + pad), y);
  }
}

/* ===== Capturar y subir ===== */
function setPreviewMode(on) {
  const hud = document.querySelector('.hud');
  const bar = document.querySelector('.bar');

  if (on) {
    previewOverlay.classList.remove('hidden');
    if (hud) hud.style.opacity = '0';
    if (bar) bar.style.opacity = '0';

    // Apagar cÃ¡mara mientras se muestra la preview
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
  } else {
    previewOverlay.classList.add('hidden');
    if (hud) hud.style.opacity = '';
    if (bar) bar.style.opacity = '';

    lastBlob = null;

    // Volver a encender la cÃ¡mara
    if (!stream) {
      startStream();
    }
  }
}

async function captureOnly() {
  if (!gps) {
    alert('Necesitamos la ubicaciÃ³n (GPS) activa antes de capturar.');
    return;
  }

  if (!stream) {
    alert('No hay cÃ¡mara activa. Intentando iniciarla de nuevo...');
    await startStream();
    if (!stream) return;
  }

  const W0 = v.videoWidth || 1080;
  const H0 = v.videoHeight || 1920;
  const maxSide = 1600;
  const s = Math.min(1, maxSide / Math.max(W0, H0));
  const W = Math.round(W0 * s);
  const H = Math.round(H0 * s);

  const c = document.createElement('canvas');
  c.width = W;
  c.height = H;
  const ctx = c.getContext('2d');

  // Foto base + sello
  ctx.drawImage(v, 0, 0, W, H);
  drawStampOnCanvas(ctx, W, H);

  const blob = await new Promise(res => c.toBlob(res, 'image/jpeg', 0.9));
  if (!blob) {
    alert('No se pudo generar la imagen.');
    return;
  }

  lastBlob = blob;

  // Mostrar la previsualizaciÃ³n
  const reader = new FileReader();
  reader.onload = () => {
    previewImg.src = reader.result;
    setPreviewMode(true);
  };
  reader.readAsDataURL(blob);
}

async function uploadCurrent() {
  if (!lastBlob) {
    alert('No hay foto capturada todavÃ­a.');
    return;
  }

  const fd = new FormData();

  // Nombre de archivo amigable
  const ts = gps && gps.ts ? new Date(gps.ts) : new Date();
  const yyyy = ts.getFullYear();
  const mm = String(ts.getMonth() + 1).padStart(2, '0');
  const dd = String(ts.getDate()).padStart(2, '0');
  const hh = String(ts.getHours()).padStart(2, '0');
  const mi = String(ts.getMinutes()).padStart(2, '0');
  const ss = String(ts.getSeconds()).padStart(2, '0');
  const filename = `geo_${yyyy}${mm}${dd}_${hh}${mi}${ss}.jpg`;

  // OJO: el backend espera el campo "imagen"
  fd.append('imagen', lastBlob, filename);

  const tituloInput = document.getElementById('titulo');
  if (tituloInput) {
    fd.append('titulo_manual', tituloInput.value || '');
  }

  // Metadatos GPS que tu vista ya soporta
  if (gps) {
    fd.append('lat', gps.lat);
    fd.append('lng', gps.lng);
    if (Number.isFinite(gps.acc)) {
      fd.append('acc', Math.round(gps.acc));
    }
    fd.append('client_taken_at', new Date().toISOString());
  }

  const r = await fetch(UPLOAD_URL, {
    method: 'POST',
    body: fd,
    cache: 'no-store',
    credentials: 'same-origin',
    headers: { 'X-CSRFToken': CSRF }
  });

  let j = null;
  try {
    j = await r.json();
  } catch (e) {}

  if (r.ok && j && j.ok) {
    alert('Foto guardada en tu galerÃ­a');
    setPreviewMode(false);
  } else {
    const msg = (j && j.error) ? j.error : `HTTP ${r.status}`;
    alert('No se pudo enviar la foto: ' + msg);
  }
}

/* ===== Listeners ===== */
/* ===== Listeners ===== */
document.getElementById('flip').addEventListener('click', async () => {
  facing = (facing === 'environment' ? 'user' : 'environment');
  await startStream();
});

const closeBtn = document.getElementById('close');
if (closeBtn) closeBtn.addEventListener('click', () => history.back());

// El botÃ³n grande ahora solo CAPTURA y muestra la preview
document.getElementById('shot').addEventListener('click', captureOnly);

// Botones del overlay de previsualizaciÃ³n
btnRetake.addEventListener('click', () => {
  setPreviewMode(false);  // oculta overlay y reactiva la cÃ¡mara
});

btnUse.addEventListener('click', () => {
  uploadCurrent();        // envÃ­a la foto al backend
});

/* ===== Init ===== */
(async function init(){
  await startStream();
  await demandGPS();
})();
</script>
</body>
</html>