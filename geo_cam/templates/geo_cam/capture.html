{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tomar foto con GPS</title>
  <style>
    body{margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter}
    .wrap{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
    .box{width:100%;max-width:960px;aspect-ratio:9/16;background:#000;position:relative;overflow:hidden}
    video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .hud{position:absolute;inset:0;pointer-events:none}
    .panel{position:absolute;left:16px;right:16px;bottom:16px;background:rgba(0,0,0,.82);border-radius:14px;display:flex;gap:12px;padding:12px}
    .map{width:120px;height:120px;border-radius:10px;overflow:hidden;background:#111;flex:0 0 auto}
    .txt{font-size:13px;line-height:1.25}
    .ttl{font-weight:700;font-size:16px;margin-bottom:6px}
    .bar{position:absolute;left:0;right:0;bottom:0;display:flex;gap:12px;justify-content:center;padding:14px}
    .btn{pointer-events:auto;border:none;border-radius:999px;padding:12px 18px;background:#334155;color:#fff;font-weight:600}
    .shot{pointer-events:auto;width:78px;height:78px;border-radius:999px;border:6px solid rgba(255,255,255,.75);background:rgba(0,0,0,.15)}
    .title-box{position:absolute;left:16px;right:16px;top:16px;display:flex;gap:8px;pointer-events:auto}
    .input{flex:1;border-radius:10px;border:1px solid #475569;background:#0b1220;color:#fff;padding:10px 12px}
    .note{position:absolute;left:16px;right:16px;top:60px;color:#cbd5e1;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <div class="box">
    <video id="v" playsinline autoplay muted></video>

    {% if titulo_required %}
      <div class="title-box">
        <input id="titulo" class="input" placeholder="Título" value="{{ titulo_default|default:'' }}">
      </div>
      <div class="note">Ingresa un título para esta foto</div>
    {% endif %}

    <div class="hud">
      <div class="panel">
        <div class="map"><img id="m" alt></div>
        <div class="txt">
          <div class="ttl" id="l1">—</div>
          <div id="l2">—</div>
          <div id="l3">Lat — Long —</div>
          <div id="l4">—</div>
          <div id="l5">—</div>
        </div>
      </div>
      <div class="bar">
        {% if next_url %}
          <a class="btn" href="{{ next_url|urlencode }}">Volver</a>
        {% else %}
          <button id="close" class="btn" type="button">Cerrar</button>
        {% endif %}
        <button id="shot" class="shot" type="button" aria-label="Capturar"></button>
        <button id="flip" class="btn" type="button">Cambiar cámara</button>
      </div>
    </div>
  </div>
</div>

<script>
{% if next_url %}
  const NEXT = "{{ next_url|escapejs }}";
{% else %}
  const NEXT = "";
{% endif %}

const UPLOAD_URL = "{% url 'geo_cam:upload' %}";   // <— endpoint de esta misma app
const CSRF = (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || '';

const MAPBOX_TOKEN = ""; // opcional; si lo dejas vacío, se omite el mapa estático
const v = document.getElementById('v');
const m = document.getElementById('m');
const l1=document.getElementById('l1'), l2=document.getElementById('l2'),
      l3=document.getElementById('l3'), l4=document.getElementById('l4'), l5=document.getElementById('l5');

let stream=null, facing='environment', gps=null, addr=null;

function pad(n){return String(n).padStart(2,'0')}
function tzStr(d=new Date()){const off=-d.getTimezoneOffset();const s=off>=0?'+':'-';const hh=pad(Math.floor(Math.abs(off)/60));const mm=pad(Math.abs(off)%60);return `GMT ${s}${hh}:${mm}`;}
function fmtDT(d=new Date()){return new Intl.DateTimeFormat('es-CL',{weekday:'long',day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true}).format(d)}
function deg(v){return Number(v).toFixed(6)+'°'}

async function startStream(){
  try{
    if(stream){stream.getTracks().forEach(t=>t.stop());}
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:facing}, audio:false});
    v.srcObject = stream; await v.play().catch(()=>{});
  }catch(e){ alert('No se pudo acceder a la cámara. Revisa permisos del navegador.'); }
}

async function geocode(lat,lng){
  if(!MAPBOX_TOKEN){ addr = {title:'Ubicación', line2:'', countryCode:''}; paintHUD(); return; }
  try{
    const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?limit=1&language=es&access_token=${encodeURIComponent(MAPBOX_TOKEN)}`;
    const r = await fetch(url,{cache:'no-store'}); const j=await r.json(); const f=j.features?.[0];
    const ctx=(f?.context||[]).reduce((m,x)=>{m[x.id.split('.')[0]]=x;return m;}, {});
    const country=(ctx.country?.text_es||ctx.country?.text||'').trim();
    const region =(ctx.region?.text_es ||ctx.region?.text ||'').trim();
    const place  =(ctx.place?.text_es  ||ctx.place?.text  ||f?.text_es||f?.text||'').trim();
    const code=(ctx.country?.short_code||'').toUpperCase();
    const title=[place,region,country].filter(Boolean).join(', ');
    const line2=f?.place_name_es||f?.place_name||'';
    addr={title,line2,countryCode:code};
  }catch{ addr={title:'Ubicación',line2:'',countryCode:''}; }
  paintHUD();
}

function staticMap(lat,lng,size=240,zoom=18){
  if(!MAPBOX_TOKEN){ m.removeAttribute('src'); return; }
  m.src=`https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v12/static/pin-s+ff0000(${lng},${lat})/${lng},${lat},${zoom},0/${size}x${size}@2x?access_token=${encodeURIComponent(MAPBOX_TOKEN)}`;
}

function paintHUD(){
  const a=addr||{}, g=gps;
  l1.textContent = a.title || '—';
  l2.textContent = a.line2 || '—';
  l3.textContent = g ? `Lat ${deg(g.lat)} Long ${deg(g.lng)}` : 'Lat — Long —';
  const ts = g?.ts ? new Date(g.ts) : new Date();
  l4.textContent = fmtDT(ts);
  l5.textContent = tzStr(ts);
  if(g) staticMap(g.lat, g.lng);
}

function explainGeoErr(err){
  if(!err || typeof err.code==='undefined') return '📍 Error de geolocalización';
  if(err.code===1) return '📍 Permiso denegado (actívalo para este sitio)';
  if(err.code===2) return '📍 Ubicación no disponible (sin señal)';
  if(err.code===3) return '📍 Tiempo de espera agotado';
  return '📍 Error de geolocalización';
}

async function demandGPS(){
  if(!('geolocation' in navigator)){ alert('Tu navegador no soporta geolocalización'); return false; }
  const OPTS={enableHighAccuracy:true, maximumAge:15000, timeout:30000};
  try{
    const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,OPTS));
    gps = { lat: pos.coords.latitude, lng: pos.coords.longitude, acc: pos.coords.accuracy, ts: Date.now() };
    paintHUD();
    geocode(gps.lat, gps.lng);
    return true;
  }catch(e){
    alert(explainGeoErr(e));
    return false;
  }
}

async function captureAndUpload(){
  if(!stream || !gps){ alert('Necesitamos cámara y GPS activos'); return; }

  const W = v.videoWidth || 1080, H = v.videoHeight || 1920;
  const c=document.createElement('canvas'); c.width=W; c.height=H;
  c.getContext('2d').drawImage(v,0,0,W,H);

  const blob = await new Promise(res=>c.toBlob(res,'image/jpeg',0.9));
  const file = new File([blob], `foto_${Date.now()}.jpg`, {type:'image/jpeg'});

  const fd = new FormData();
  if (CSRF) fd.append('csrfmiddlewaretoken', CSRF);
  fd.append('imagen', file);

  {% if titulo_required %}
    const t = (document.getElementById('titulo')?.value || '').trim();
    if(!t){ alert('Ingresa un título'); return; }
    fd.append('titulo_manual', t);
  {% else %}
    {% if titulo_default %} fd.append('titulo_manual', "{{ titulo_default|escapejs }}"); {% endif %}
  {% endif %}

  fd.append('lat', gps.lat);
  fd.append('lng', gps.lng);
  if(Number.isFinite(gps.acc)) fd.append('acc', Math.round(gps.acc));
  fd.append('client_taken_at', new Date().toISOString());

  const r = await fetch(UPLOAD_URL, { method:'POST', body:fd, cache:'no-store' });
  let j=null; try{ j = await r.json(); }catch{}

  if(r.ok && j && j.ok){
    if(NEXT){ window.location.href = NEXT; }
    else { alert('Foto enviada'); }
  }else{
    alert((j && j.error) ? j.error : 'No se pudo enviar la foto');
  }
}

document.getElementById('flip').addEventListener('click', async ()=>{
  facing = (facing==='environment'?'user':'environment');
  await startStream();
});
document.getElementById('shot').addEventListener('click', captureAndUpload);
const closeBtn = document.getElementById('close');
if(closeBtn) closeBtn.addEventListener('click', ()=>history.back());

(async function init(){
  await startStream();
  await demandGPS();
})();
</script>
</body>
</html>