{% extends "dashboard_admin/base.html" %}
{% load widget_tweaks %}

{% block dashboard_content %}
<div class="max-w-5xl mx-auto bg-white p-6 rounded-xl shadow">
  <h2 class="text-xl font-bold text-gray-800 mb-4">
    Carga Masiva de Liquidaciones
  </h2>

  <!-- FORMULARIO PRINCIPAL (solo para subir/preview) -->
  <form method="post" enctype="multipart/form-data" class="space-y-4">
    {% csrf_token %}

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-semibold text-gray-700">Mes</label>
        {{ form.mes|add_class:"w-full rounded-xl border-gray-300 px-4 py-2 shadow-sm focus:ring-2 focus:ring-green-500" }}
      </div>

      <div>
        <label class="block text-sm font-semibold text-gray-700">A√±o</label>
        {{ form.a√±o|add_class:"w-full rounded-xl border-gray-300 px-4 py-2 shadow-sm focus:ring-2 focus:ring-green-500" }}
      </div>
    </div>

    <div>
      <label class="block text-sm font-semibold text-gray-700">
        Archivos PDF (puede ser uno con todas las liquidaciones)
      </label>
      {{ form.archivos|add_class:"w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" }}
      <p class="mt-1 text-xs text-gray-500">
        Puedes subir un √∫nico PDF con todas las liquidaciones o varios PDFs.
        El sistema leer√° el RUT y nombre desde cada p√°gina, sin importar el formato del RUT.
      </p>
    </div>

    <div class="flex items-center justify-between mt-4">
      <a href="{% url 'liquidaciones:admin_lista' %}"
         class="inline-flex items-center gap-1 text-sm text-gray-600 hover:text-gray-800">
        ‚Üê Volver
      </a>

      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm shadow">
        üì§ Subir Liquidaciones (Preview)
      </button>
    </div>
  </form>

  <!-- PREVIEW / RESUMEN -->
  {% if resumen %}
    <div class="mt-8 bg-white border rounded-xl p-4 shadow space-y-4">
      <h3 class="text-lg font-semibold text-gray-800">üìä Resumen de carga</h3>

      <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 text-sm mb-4">
        <div class="p-3 rounded-xl bg-slate-100">
          <div class="text-xs text-slate-500">Archivos PDF</div>
          <div class="text-2xl font-semibold">{{ resumen.total_archivos }}</div>
        </div>
        <div class="p-3 rounded-xl bg-slate-100">
          <div class="text-xs text-slate-500">P√°ginas procesadas</div>
          <div class="text-2xl font-semibold">{{ resumen.total_paginas }}</div>
        </div>
        <div class="p-3 rounded-xl bg-green-100">
          <div class="text-xs text-green-700">Asociadas</div>
          <div class="text-2xl font-semibold">{{ resumen.total_asociadas }}</div>
        </div>
        <div class="p-3 rounded-xl bg-red-100">
          <div class="text-xs text-red-700">No asociadas</div>
          <div class="text-2xl font-semibold">{{ resumen.total_no_asociadas }}</div>
        </div>
      </div>

      {% if not resumen.confirmado %}
        <!-- Botones de Cancelar / Cargar (solo en preview) -->
        <div class="flex justify-end gap-3 mb-4">
          <a href="{% url 'liquidaciones:carga_masiva' %}"
             class="px-4 py-2 rounded-full border text-sm text-gray-700 hover:bg-slate-100">
            Cancelar
          </a>
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="confirmar" value="1">
            <button type="submit"
                    class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
              ‚úÖ Cargar liquidaciones
            </button>
          </form>
        </div>
      {% endif %}

      {% if asociadas %}
        <div class="mt-2">
          <h4 class="text-sm font-bold text-gray-700 mb-2">
            ‚úÖ Liquidaciones asociadas{% if not resumen.confirmado %} (preview){% endif %}
          </h4>
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs sm:text-sm border">
              <thead class="bg-slate-100">
                <tr>
                  <th class="px-2 py-1 border">Archivo</th>
                  <th class="px-2 py-1 border">P√°g.</th>
                  <th class="px-2 py-1 border">RUT</th>
                  <th class="px-2 py-1 border">Nombre</th>
                  <th class="px-2 py-1 border">Usuario</th>
                  <th class="px-2 py-1 border">PDF</th>
                </tr>
              </thead>
              <tbody>
                {% for item in asociadas %}
                  <tr class="hover:bg-slate-50">
                    <td class="px-2 py-1 border">{{ item.archivo }}</td>
                    <td class="px-2 py-1 border text-center">{{ item.pagina }}</td>
                    <td class="px-2 py-1 border whitespace-nowrap">{{ item.rut }}</td>
                    <td class="px-2 py-1 border">{{ item.nombre }}</td>
                    <td class="px-2 py-1 border">
                      {{ item.usuario.get_full_name|default:item.usuario.username }}
                    </td>
                    <td class="px-2 py-1 border text-center">
                      {% if not resumen.confirmado %}
                        <!-- PREVIEW: ver PDF desde la sesi√≥n -->
                        <a href="{% url 'liquidaciones:preview_pdf_carga_masiva' item.preview_index %}"
                           target="_blank"
                           class="text-blue-600 underline">
                          Ver PDF
                        </a>
                      {% else %}
                        <!-- CONFIRMADO: ver PDF real guardado -->
                        {% if item.liquidacion and item.liquidacion.archivo_pdf_liquidacion %}
                          <a href="{{ item.liquidacion.archivo_pdf_liquidacion.url }}"
                             target="_blank"
                             class="text-blue-600 underline">
                            Ver PDF
                          </a>
                        {% else %}
                          <span class="text-slate-400">Sin archivo</span>
                        {% endif %}
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}

      {% if no_asociadas %}
        <div class="mt-6">
          <h4 class="text-sm font-bold text-gray-700 mb-2">
            ‚ö†Ô∏è P√°ginas no asociadas
          </h4>
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs sm:text-sm border">
              <thead class="bg-slate-100">
                <tr>
                  <th class="px-2 py-1 border">Archivo</th>
                  <th class="px-2 py-1 border">P√°g.</th>
                  <th class="px-2 py-1 border">RUT</th>
                  <th class="px-2 py-1 border">Nombre</th>
                  <th class="px-2 py-1 border">Motivo</th>
                </tr>
              </thead>
              <tbody>
                {% for item in no_asociadas %}
                  <tr class="hover:bg-slate-50">
                    <td class="px-2 py-1 border">{{ item.archivo }}</td>
                    <td class="px-2 py-1 border text-center">{{ item.pagina }}</td>
                    <td class="px-2 py-1 border">{{ item.rut|default:"‚Äî" }}</td>
                    <td class="px-2 py-1 border">{{ item.nombre|default:"‚Äî" }}</td>
                    <td class="px-2 py-1 border text-red-600">
                      {{ item.motivo }}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>
{% endblock %}