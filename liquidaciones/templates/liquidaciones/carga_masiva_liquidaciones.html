{% extends "dashboard_admin/base.html" %}
{% load widget_tweaks %}

{% block dashboard_content %}
<div class="max-w-5xl mx-auto bg-white p-6 rounded-xl shadow">
  <h2 class="text-xl font-bold text-gray-800 mb-4">
    Carga Masiva de Liquidaciones
  </h2>

  {# üî¥ BLOQUE PARA MOSTRAR ERRORES DEL FORMULARIO #}
  {% if form.errors %}
    <div class="mb-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
      <p class="font-semibold mb-1">Hay errores en el formulario:</p>
      {% if form.non_field_errors %}
        {% for error in form.non_field_errors %}
          <div>‚Ä¢ {{ error }}</div>
        {% endfor %}
      {% endif %}
      {% for field in form %}
        {% for error in field.errors %}
          <div>‚Ä¢ {{ field.label }}: {{ error }}</div>
        {% endfor %}
      {% endfor %}
    </div>
  {% endif %}

  <!-- FORMULARIO PRINCIPAL (solo archivos, el sistema detecta mes/a√±o) -->
  <form method="post" enctype="multipart/form-data" class="space-y-4">
    {% csrf_token %}

    <div>
      <label class="block text-sm font-semibold text-gray-700">
        Archivos PDF (puede ser uno con todas las liquidaciones)
      </label>
      <input
  type="file"
  name="archivos"
  id="id_archivos"
  multiple
  accept="application/pdf"
  class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"
/>
      <p class="mt-1 text-xs text-gray-500">
        Puedes subir un √∫nico PDF con todas las liquidaciones o varios PDFs.
        El sistema detectar√° autom√°ticamente el mes y el a√±o desde cada p√°gina,
        y asociar√° a cada trabajador seg√∫n su RUT (en cualquier formato).
      </p>
    </div>

    <div class="flex items-center justify-between mt-4">
      <a href="{% url 'liquidaciones:admin_lista' %}"
         class="inline-flex items-center gap-1 text-sm text-gray-600 hover:text-gray-800">
        ‚Üê Volver
      </a>

      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm shadow">
        üì§ Subir Liquidaciones (Preview)
      </button>
    </div>
  </form>

  <!-- PREVIEW / RESUMEN -->
  {% if resumen %}
    <div class="mt-8 bg-white border rounded-xl p-4 shadow space-y-4">
      <h3 class="text-lg font-semibold text-gray-800">üìä Resumen de carga</h3>

      <div class="grid grid-cols-1 sm:grid-cols-5 gap-4 text-sm mb-4">
        <div class="p-3 rounded-xl bg-slate-100">
          <div class="text-xs text-slate-500">Archivos PDF</div>
          <div class="text-2xl font-semibold">{{ resumen.total_archivos }}</div>
        </div>
        <div class="p-3 rounded-xl bg-slate-100">
          <div class="text-xs text-slate-500">P√°ginas procesadas</div>
          <div class="text-2xl font-semibold">{{ resumen.total_paginas }}</div>
        </div>
        <div class="p-3 rounded-xl bg-green-100">
          <div class="text-xs text-green-700">Asociadas</div>
          <div class="text-2xl font-semibold">{{ resumen.total_asociadas }}</div>
        </div>
        <div class="p-3 rounded-xl bg-red-100">
          <div class="text-xs text-red-700">No asociadas</div>
          <div class="text-2xl font-semibold">{{ resumen.total_no_asociadas }}</div>
        </div>
        <div class="p-3 rounded-xl {% if resumen.duplicados %}bg-amber-100{% else %}bg-slate-100{% endif %}">
          <div class="text-xs {% if resumen.duplicados %}text-amber-700{% else %}text-slate-500{% endif %}">
            Duplicadas (ya exist√≠a liquidaci√≥n mismo mes/a√±o)
          </div>
          <div class="text-2xl font-semibold">{{ resumen.duplicados }}</div>
        </div>
      </div>

      {% if not resumen.confirmado %}
        <!-- Botones de Cancelar / Cargar (solo en preview) -->
        <div class="flex flex-col gap-2 mb-4">
          {% if resumen.duplicados %}
            <p class="text-xs text-amber-700">
              ‚ö† Se encontraron {{ resumen.duplicados }} liquidaciones que ya existen para el mismo trabajador y mes/a√±o.
              Elige si quieres cargar solo las nuevas o reemplazar tambi√©n las existentes.
            </p>
          {% endif %}

          <div class="flex justify-end gap-3">
            <a href="{% url 'liquidaciones:carga_masiva' %}"
               class="px-4 py-2 rounded-full border text-sm text-gray-700 hover:bg-slate-100">
              Cancelar
            </a>

            {% if resumen.duplicados %}
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="confirmar" value="1">
                <input type="hidden" name="modo" value="solo_nuevas">
                <button type="submit"
                        class="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-full text-sm shadow">
                  ‚úÖ Cargar solo nuevas
                </button>
              </form>
            {% endif %}

            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="confirmar" value="1">
              <input type="hidden" name="modo" value="reemplazar">
              <button type="submit"
                      class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
                ‚úÖ Cargar liquidaciones{% if resumen.duplicados %} (incluye reemplazo){% endif %}
              </button>
            </form>
          </div>
        </div>
      {% endif %}

      {% if asociadas %}
        <div class="mt-2">
          <h4 class="text-sm font-bold text-gray-700 mb-2">
            ‚úÖ Liquidaciones asociadas{% if not resumen.confirmado %} (preview){% endif %}
          </h4>
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs sm:text-sm border">
              <thead class="bg-slate-100">
                <tr>
                  <th class="px-2 py-1 border">Archivo</th>
                  <th class="px-2 py-1 border">P√°g.</th>
                  <th class="px-2 py-1 border">RUT</th>
                  <th class="px-2 py-1 border">Nombre</th>
                  <th class="px-2 py-1 border">Mes</th>
                  <th class="px-2 py-1 border">A√±o</th>
                  <th class="px-2 py-1 border">Usuario</th>
                  <th class="px-2 py-1 border">Estado</th>
                  <th class="px-2 py-1 border">PDF</th>
                </tr>
              </thead>
              <tbody>
                {% for item in asociadas %}
                  <tr class="hover:bg-slate-50">
                    <td class="px-2 py-1 border">{{ item.archivo }}</td>
                    <td class="px-2 py-1 border text-center">{{ item.pagina }}</td>
                    <td class="px-2 py-1 border whitespace-nowrap">{{ item.rut }}</td>
                    <td class="px-2 py-1 border">{{ item.nombre }}</td>
                    <td class="px-2 py-1 border text-center">{{ item.mes }}</td>
                    <td class="px-2 py-1 border text-center">{{ item.a√±o }}</td>
                    <td class="px-2 py-1 border">
                      {{ item.usuario.get_full_name|default:item.usuario.username }}
                    </td>
                    <td class="px-2 py-1 border text-xs">
                      {% if item.ya_existe %}
                        <span class="text-amber-700">Ya exist√≠a (duplicada)</span>
                      {% else %}
                        <span class="text-green-700">Nueva</span>
                      {% endif %}
                    </td>
                    <td class="px-2 py-1 border text-center">
                      {% if not resumen.confirmado %}
                        <!-- PREVIEW: ver PDF desde la sesi√≥n -->
                        <a href="{% url 'liquidaciones:preview_pdf_carga_masiva' item.preview_index %}"
                           target="_blank"
                           class="text-blue-600 underline">
                          Ver PDF
                        </a>
                      {% else %}
                        <!-- CONFIRMADO: ver PDF real guardado -->
                        {% if item.liquidacion and item.liquidacion.archivo_pdf_liquidacion %}
                          <a href="{{ item.liquidacion.archivo_pdf_liquidacion.url }}"
                             target="_blank"
                             class="text-blue-600 underline">
                            Ver PDF
                          </a>
                        {% else %}
                          <span class="text-slate-400">Sin archivo</span>
                        {% endif %}
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}

      {% if no_asociadas %}
        <div class="mt-6">
          <h4 class="text-sm font-bold text-gray-700 mb-2">
            ‚ö†Ô∏è P√°ginas no asociadas
          </h4>
          <div class="overflow-x-auto">
            <table class="min-w-full text-xs sm:text-sm border">
              <thead class="bg-slate-100">
                <tr>
                  <th class="px-2 py-1 border">Archivo</th>
                  <th class="px-2 py-1 border">P√°g.</th>
                  <th class="px-2 py-1 border">RUT</th>
                  <th class="px-2 py-1 border">Nombre</th>
                  <th class="px-2 py-1 border">Mes</th>
                  <th class="px-2 py-1 border">A√±o</th>
                  <th class="px-2 py-1 border">Motivo</th>
                </tr>
              </thead>
              <tbody>
                {% for item in no_asociadas %}
                  <tr class="hover:bg-slate-50">
                    <td class="px-2 py-1 border">{{ item.archivo }}</td>
                    <td class="px-2 py-1 border text-center">{{ item.pagina }}</td>
                    <td class="px-2 py-1 border">{{ item.rut|default:"‚Äî" }}</td>
                    <td class="px-2 py-1 border">{{ item.nombre|default:"‚Äî" }}</td>
                    <td class="px-2 py-1 border text-center">
                      {{ item.mes|default:"‚Äî" }}
                    </td>
                    <td class="px-2 py-1 border text-center">
                      {{ item.a√±o|default:"‚Äî" }}
                    </td>
                    <td class="px-2 py-1 border text-red-600">
                      {{ item.motivo }}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>
{% endblock %}