{% extends 'dashboard/base.html' %}

{% block content %}
<div class="bg-white shadow mt-3 -mx-3 sm:mx-0 rounded-none sm:rounded-2xl px-3 py-4 sm:p-6">

  <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4">
    üßæ Mis Liquidaciones de Sueldo
  </h1>

  {# --- Filtros --- #}
  <form id="form-filtros"
        method="get"
        class="mb-3 text-sm">

    <div class="inline-flex flex-wrap items-end gap-3 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3">

      <!-- Mes -->
      <div class="w-full sm:w-40">
        <label class="text-xs text-gray-600">Mes</label>
        <select name="mes"
                class="border rounded-lg px-3 py-2 w-full">
          <option value="">Todos</option>
          {% for m in MESES %}
            <option value="{{ m.0 }}" {% if filtros.mes == m.0|stringformat:"s" %}selected{% endif %}>
              {{ m.1 }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- A√±o -->
      <div class="w-full sm:w-40">
        <label class="text-xs text-gray-600">A√±o</label>
        <select name="anio"
                class="border rounded-lg px-3 py-2 w-full">
          <option value="">Todos</option>
          {% for anio in ANIOS %}
            <option value="{{ anio }}" {% if filtros.anio == anio|stringformat:"s" %}selected{% endif %}>
              {{ anio }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Estado -->
      <div class="w-full sm:w-48">
        <label class="text-xs text-gray-600">Estado</label>
        <select name="estado"
                class="border rounded-lg px-3 py-2 w-full">
          <option value="">Todos</option>
          <option value="firmada"   {% if filtros.estado == 'firmada' %}selected{% endif %}>Firmada</option>
          <option value="pendiente" {% if filtros.estado == 'pendiente' %}selected{% endif %}>Pendiente de firma</option>
        </select>
      </div>

      <!-- Bot√≥n limpiar -->
      <div class="w-full sm:w-auto flex items-center gap-2">
        <a href="{% url 'liquidaciones:listar' %}"
           class="px-4 py-2 rounded-lg bg-red-100 hover:bg-red-200 text-red-600 text-sm font-medium whitespace-nowrap shadow">
          ‚ùå Limpiar
        </a>
      </div>

      <!-- Mantener cantidad actual -->
      <input type="hidden" name="cantidad" value="{{ cantidad }}">
    </div>
  </form>

  <!-- Tabla -->
   <div class="overflow-x-auto">
    <table class="table-auto w-full text-sm min-w-full sm:min-w-[1200px]" style="white-space: nowrap;">
      <thead class="bg-gray-100 text-gray-800">
        <tr>
          <th class="px-4 py-2 text-left">Mes</th>
          <th class="px-4 py-2 text-left">A√±o</th>
          <th class="px-4 py-2 text-left">Liquidaci√≥n sin firmar</th>
          <th class="px-4 py-2 text-left">Estado</th>
          <th class="px-4 py-2 text-left">Acciones</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-300">
        {% for liquidacion in pagina %}
        <tr class="hover:bg-gray-50 transition">
          <td class="px-4 py-2">{{ liquidacion.mes }}</td>
          <td class="px-4 py-2">{{ liquidacion.a√±o }}</td>

          <td class="px-4 py-2">
            {% if liquidacion.archivo_pdf_liquidacion %}
              <a href="{% url 'liquidaciones:ver_pdf' liquidacion.id %}"
                 target="_blank"
                 class="text-blue-600 hover:underline">
                üìÑ Ver PDF
              </a>
            {% else %}
              <span class="text-red-500 italic">No disponible</span>
            {% endif %}
          </td>

           <td class="px-4 py-2">
            {# Estado basado en si existe pdf_firmado #}
            {% if liquidacion.pdf_firmado and liquidacion.pdf_firmado.url %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 text-xs font-semibold">
                Firmada{% if liquidacion.fecha_firma %} el {{ liquidacion.fecha_firma|date:"d/m/Y H:i" }}{% endif %}
              </span>
            {% else %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-rose-100 text-rose-700 text-xs font-semibold">
                Pendiente de firma
              </span>
            {% endif %}
          </td>


          <td class="px-4 py-2">
            {% if liquidacion.pdf_firmado and liquidacion.pdf_firmado.url %}
              <a href="{% url 'liquidaciones:descargar_pdf' liquidacion.id %}"
                 target="_blank"
                 class="text-blue-600 hover:underline">
                ‚¨áÔ∏è Descargar
              </a>
            {% elif liquidacion.archivo_pdf_liquidacion %}
              <a href="{% url 'liquidaciones:firmar_liquidacion' liquidacion.pk %}"
                 class="text-blue-600 hover:underline">
                ‚úçÔ∏è Firmar
              </a>
            {% else %}
              <span class="text-red-500 italic">No disponible</span>
            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="px-4 py-6 text-center text-gray-500">
            No hay liquidaciones registradas.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# Barra inferior: selector de cantidad + paginaci√≥n dentro de la tarjeta #}
  <div class="mt-4 flex flex-col gap-3 text-sm">

    {# Selector de cantidad #}
    <form method="get" class="flex flex-wrap items-center gap-2">
      <label for="cantidad" class="text-sm font-medium text-gray-700">Mostrar:</label>
      <select name="cantidad" id="cantidad" onchange="this.form.submit()" class="border rounded-lg px-3 py-1">
        <option value="10"  {% if cantidad == '10' %}selected{% endif %}>10</option>
        <option value="20"  {% if cantidad == '20' %}selected{% endif %}>20</option>
        <option value="50"  {% if cantidad == '50' %}selected{% endif %}>50</option>
        <option value="100" {% if cantidad == '100' %}selected{% endif %}>100</option>
      </select>

      <!-- mantener filtros al cambiar cantidad -->
      <input type="hidden" name="mes"    value="{{ filtros.mes }}">
      <input type="hidden" name="anio"   value="{{ filtros.anio }}">
      <input type="hidden" name="estado" value="{{ filtros.estado }}">
    </form>

    {# Paginaci√≥n CENTRADA #}
    <div class="flex justify-center gap-2 text-sm">
      {% if pagina.has_previous %}
        <a href="?page=1&cantidad={{ cantidad }}&mes={{ filtros.mes }}&anio={{ filtros.anio }}&estado={{ filtros.estado }}"
           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">¬´ Primero</a>
        <a href="?page={{ pagina.previous_page_number }}&cantidad={{ cantidad }}&mes={{ filtros.mes }}&anio={{ filtros.anio }}&estado={{ filtros.estado }}"
           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">‚Äπ Anterior</a>
      {% endif %}

      <span class="px-3 py-1">
        P√°gina {{ pagina.number }} de {{ pagina.paginator.num_pages }}
      </span>

      {% if pagina.has_next %}
        <a href="?page={{ pagina.next_page_number }}&cantidad={{ cantidad }}&mes={{ filtros.mes }}&anio={{ filtros.anio }}&estado={{ filtros.estado }}"
           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Siguiente ‚Ä∫</a>
        <a href="?page={{ pagina.paginator.num_pages }}&cantidad={{ cantidad }}&mes={{ filtros.mes }}&anio={{ filtros.anio }}&estado={{ filtros.estado }}"
           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">√öltimo ¬ª</a>
      {% endif %}
    </div>

  </div>

</div>

{# Autosubmit sencillo de los filtros (como en contratos) #}
<script>
  (function () {
    const form = document.getElementById('form-filtros');
    if (!form) return;
    const selects = form.querySelectorAll('select');

    selects.forEach(el => {
      el.addEventListener('change', () => {
        form.requestSubmit();
      });
    });
  })();
</script>

{% endblock %}