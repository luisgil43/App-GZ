{% extends 'dashboard_admin/base.html' %}

{% block dashboard_content %}
<div class="bg-white shadow mt-3 -mx-3 sm:mx-0 rounded-none sm:rounded-2xl px-3 py-4 sm:p-6">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-3">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">
      üí∏ Liquidaciones de Sueldo
    </h1>

    <div class="flex flex-wrap gap-2">
      <a href="{% url 'liquidaciones:crear' %}"
         class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl text-center">
        ‚ûï A√±adir Liquidaci√≥n
      </a>
      <a href="{% url 'liquidaciones:carga_masiva' %}"
         class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-center">
        üì• Cargar Liquidaciones Masiva
      </a>
    </div>
  </div>

  <!-- Filtros (tipo Excel, auto-submit) -->
  <form id="form-filtros"
        method="get"
        class="mb-3 text-sm">

    <div class="inline-flex flex-wrap items-end gap-3 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 w-full">

      <!-- Nombre -->
      <div class="w-full sm:w-72">
        <label class="text-xs text-gray-600">Nombre</label>
        <input type="text"
               name="nombre"
               value="{{ filtros.nombre }}"
               placeholder="Nombre o apellido"
               class="border rounded-lg px-3 py-2 w-full"
               autocomplete="off">
      </div>

      <!-- Mes -->
      <div class="w-full sm:w-48">
        <label class="text-xs text-gray-600">Mes</label>
        <select name="mes"
                class="border rounded-lg px-3 py-2 w-full">
          <option value="">Todos</option>
          {% for mes in meses %}
            <option value="{{ mes }}" {% if filtros.mes == mes %}selected{% endif %}>{{ mes }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- A√±o -->
      <div class="w-full sm:w-40">
        <label class="text-xs text-gray-600">A√±o</label>
        <select name="anio"
                class="border rounded-lg px-3 py-2 w-full">
          <option value="">Todos</option>
          {% for a√±o in a√±os %}
            <option value="{{ a√±o }}" {% if filtros.anio|default:'' == a√±o|stringformat:"s" %}selected{% endif %}>
              {{ a√±o }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Firmado -->
      <div class="w-full sm:w-40">
        <label class="text-xs text-gray-600">Firmado</label>
        <select name="firmado"
                class="border rounded-lg px-3 py-2 w-full">
          <option value="">Todos</option>
          <option value="si" {% if filtros.firmado == 'si' %}selected{% endif %}>Firmadas</option>
          <option value="no" {% if filtros.firmado == 'no' %}selected{% endif %}>No firmadas</option>
        </select>
      </div>

      <!-- Bot√≥n Limpiar -->
      <div class="w-full sm:w-auto flex items-center gap-2">
        <a href="{{ request.path }}"
           class="px-4 py-2 rounded-lg bg-red-100 hover:bg-red-200 text-red-600 text-sm font-medium whitespace-nowrap shadow">
          ‚ùå Limpiar
        </a>
      </div>

      <!-- Mantener cantidad actual -->
      <input type="hidden" name="cantidad" value="{{ cantidad }}">
    </div>
  </form>

  <!-- Tabla -->
  <div class="overflow-x-auto">
    <table class="table-auto w-full text-sm min-w-full sm:min-w-[900px]" style="white-space: nowrap;">
      <thead class="bg-gray-100 text-gray-800 font-semibold text-left">
        <tr>
          <th class="px-4 py-3">Nombre y Apellido</th>
          <th class="px-4 py-3">Mes</th>
          <th class="px-4 py-3">A√±o</th>
          <th class="px-4 py-3">Liquidaci√≥n sin firmar</th>
          <th class="px-4 py-3 text-center">Firmado</th>
          <th class="px-4 py-3">Fecha Firma</th>
          <th class="px-4 py-3">Liquidaci√≥n firmada</th>
          <th class="px-4 py-3">Acciones</th>
        </tr>
      </thead>

      <tbody class="bg-white">
        {% for l in pagina %}
        <tr class="border-t hover:bg-gray-50 transition">
          <td class="px-4 py-3">{{ l.tecnico.get_full_name }}</td>
          <td class="px-4 py-3">{{ l.mes }}</td>
          <td class="px-4 py-3">{{ l.a√±o }}</td>

          <!-- PDF sin firmar -->
          <td class="px-4 py-3 text-center">
            {% if l.archivo_pdf_liquidacion %}
              <a href="{% url 'liquidaciones:ver_pdf_admin' l.id %}"
                 target="_blank"
                 class="text-blue-600 hover:underline">
                üìÑ Ver PDF
              </a>
            {% else %}
              <span class="text-red-500 italic">No disponible</span>
            {% endif %}
          </td>

          <!-- Firmado -->
          <td class="px-4 py-3 text-center">
            {% if l.firmada %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-100 text-emerald-800 text-xs font-semibold">
                S√≠
              </span>
            {% else %}
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-red-100 text-red-800 text-xs font-semibold">
                No
              </span>
            {% endif %}
          </td>

          <!-- Fecha firma -->
          <td class="px-4 py-3">
            {% if l.fecha_firma %}
              {{ l.fecha_firma|date:"Y-m-d" }}
            {% else %}
              ‚Äî
            {% endif %}
          </td>

          <!-- PDF firmado -->
          <td class="px-4 py-3">
            {% if l.pdf_firmado %}
              <a href="{% url 'liquidaciones:ver_pdf_firmado_admin' l.id %}"
                 target="_blank"
                 class="text-blue-600 hover:underline">
                ‚¨áÔ∏è Descargar
              </a>
            {% else %}
              <span class="text-red-500 italic">No disponible</span>
            {% endif %}
          </td>

          <!-- Acciones -->
          <td class="px-4 py-3">
            <div class="flex flex-col sm:flex-row gap-2">
              <a href="{% url 'liquidaciones:editar' l.id %}"
                 class="text-indigo-600 hover:underline">
                üñäÔ∏è Editar
              </a>
              <a href="{% url 'liquidaciones:eliminar' l.id %}"
                 class="text-red-600 hover:underline">
                üóëÔ∏è Eliminar
              </a>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="px-4 py-6 text-center text-gray-500">
            No hay liquidaciones registradas.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Selector de cantidad -->
  <form method="get" class="mt-4 flex flex-wrap items-center gap-2">
    <label for="cantidad" class="text-sm font-medium text-gray-700">Mostrar:</label>
    <select name="cantidad" id="cantidad" onchange="this.form.submit()" class="border rounded-lg px-3 py-1">
      <option value="10"  {% if cantidad == '10' %}selected{% endif %}>10</option>
      <option value="20"  {% if cantidad == '20' %}selected{% endif %}>20</option>
      <option value="50"  {% if cantidad == '50' %}selected{% endif %}>50</option>
      <option value="100" {% if cantidad == '100' %}selected{% endif %}>100</option>
    </select>

    <!-- Mantener filtros al cambiar cantidad -->
    <input type="hidden" name="nombre"  value="{{ filtros.nombre }}">
    <input type="hidden" name="mes"     value="{{ filtros.mes }}">
    <input type="hidden" name="anio"    value="{{ filtros.anio }}">
    <input type="hidden" name="firmado" value="{{ filtros.firmado }}">
  </form>

  <!-- Paginaci√≥n -->
  <div class="mt-3 flex justify-center gap-2 text-sm">
    {% if pagina.has_previous %}
      <a href="?page=1&cantidad={{ cantidad }}&nombre={{ filtros.nombre }}&mes={{ filtros.mes }}&anio={{ filtros.anio }}&firmado={{ filtros.firmado }}"
         class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">¬´ Primero</a>
      <a href="?page={{ pagina.previous_page_number }}&cantidad={{ cantidad }}&nombre={{ filtros.nombre }}&mes={{ filtros.mes }}&anio={{ filtros.anio }}&firmado={{ filtros.firmado }}"
         class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">‚Äπ Anterior</a>
    {% endif %}

    <span class="px-3 py-1">
      P√°gina {{ pagina.number }} de {{ pagina.paginator.num_pages }}
    </span>

    {% if pagina.has_next %}
      <a href="?page={{ pagina.next_page_number }}&cantidad={{ cantidad }}&nombre={{ filtros.nombre }}&mes={{ filtros.mes }}&anio={{ filtros.anio }}&firmado={{ filtros.firmado }}"
         class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Siguiente ‚Ä∫</a>
      <a href="?page={{ pagina.paginator.num_pages }}&cantidad={{ cantidad }}&nombre={{ filtros.nombre }}&mes={{ filtros.mes }}&anio={{ filtros.anio }}&firmado={{ filtros.firmado }}"
         class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">√öltimo ¬ª</a>
    {% endif %}
  </div>

</div>

{# === Filtros autom√°ticos tipo Hyperlink (sin bot√≥n) === #}
<script>
(function () {
  const form = document.getElementById('form-filtros');
  if (!form) return;

  const isTouch    = matchMedia('(pointer:coarse)').matches;
  const textInputs = form.querySelectorAll('input[type="text"]');
  const selects    = form.querySelectorAll('select');
  const KEY        = 'liq_admin_filtros_focus_v1';

  function rememberCaret(el) {
    try {
      const pos = typeof el.selectionStart === 'number'
        ? el.selectionStart
        : (el.value || '').length;
      sessionStorage.setItem(KEY, JSON.stringify({ name: el.name, pos }));
    } catch (_) {}
  }

  function submitNow(fromEl) {
    rememberCaret(fromEl);
    form.requestSubmit();
  }

  // Inputs de texto (debounce en desktop)
  textInputs.forEach(el => {
    if (isTouch) {
      el.addEventListener('blur', () => submitNow(el));
      el.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          submitNow(el);
        }
      });
    } else {
      let t, composing = false;
      function doSubmit() {
        clearTimeout(t);
        t = setTimeout(() => {
          if (!composing) submitNow(el);
        }, 700);
      }
      el.addEventListener('compositionstart', () => composing = true);
      el.addEventListener('compositionend', () => { composing = false; doSubmit(); });
      el.addEventListener('input', doSubmit);
      el.addEventListener('change', doSubmit);
      el.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          submitNow(el);
        }
      });
    }
  });

  // Selects => submit inmediato
  selects.forEach(el => {
    el.addEventListener('change', () => submitNow(el));
  });

  // Restaurar foco/caret
  function restoreCaret() {
    try {
      const data = JSON.parse(sessionStorage.getItem(KEY) || 'null');
      if (!data) return;
      const el = form.elements[data.name];
      if (!el) return;

      el.focus({ preventScroll: true });
      const len = (el.value || '').length;
      const p   = Math.min((data.pos ?? len), len);

      if (typeof el.setSelectionRange === 'function') {
        el.setSelectionRange(p, p);
      }
    } catch (_) {}
  }

  window.addEventListener('DOMContentLoaded', () => {
    restoreCaret();
    requestAnimationFrame(restoreCaret);
  });
  window.addEventListener('pageshow', restoreCaret);
})();
</script>
{% endblock %}