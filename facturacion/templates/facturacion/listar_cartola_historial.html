{% extends "dashboard_admin/base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Historial Cartola{% endblock %}

{% block dashboard_content %}
<div class="bg-white shadow mt-3 -mx-3 sm:mx-0 rounded-none sm:rounded-2xl px-3 py-4 sm:p-6">

<style>
  .tabla-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  table { white-space: nowrap; min-width: 1200px; }

  .excel-header-btn{ width:100%; justify-content:center; font-size:0.875rem; }
  .excel-header-btn .excel-arrow{ font-size:0.65rem; margin-left:2px; }
  .excel-header-btn:hover .excel-arrow{ color:#111827; }
  .excel-col-filtered .excel-header-btn{ background:#e0f2fe; border-radius:999px; }
  .excel-col-filtered .excel-arrow{ color:#2563eb !important; }

  .excel-panel{
    position:fixed; z-index:50; width:260px; background:#fff;
    border-radius:0.75rem; border:1px solid #d1d5db;
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    padding:0.75rem; font-size:0.8rem;
  }
  .excel-panel h3{ font-weight:600; margin-bottom:0.5rem; }
  .excel-panel small{ font-size:0.7rem; color:#6b7280; }
  .excel-panel .excel-options{
    max-height:180px; overflow-y:auto; border:1px solid #e5e7eb;
    border-radius:0.5rem; padding:0.25rem 0.5rem; margin-top:0.25rem;
    background:#f9fafb;
  }
</style>

<div class="flex flex-col sm:flex-row justify-start items-start sm:items-center mb-4 gap-2">
  <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">üìö Historial Cartola</h2>

  <div class="flex gap-2 flex-wrap">
    <a href="{% url 'facturacion:listar_cartola' %}"
       class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded-full text-sm shadow">
      ‚¨ÖÔ∏è Volver a Cartola
    </a>
    <button type="button"
            id="btnDevolverCartola"
            disabled
            class="px-3 py-2 text-sm rounded-full shadow border bg-white opacity-50 cursor-not-allowed">
      ‚Ü©Ô∏è Devolver a Cartola
    </button>

    <button type="button"
            id="btnExcelClearAll"
            class="px-3 py-2 text-sm border rounded-full bg-white hover:bg-blue-50 shadow">
      ‚ùå Limpiar filtros
    </button>
  <a href="{% url 'facturacion:exportar_cartola_historial' %}?{{ full_qs }}"
   class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm shadow">
  üì• Export to Excel
</a>
  </div>
</div>

<!-- ‚úÖ Zona tabla con excel_global_json (servidor) -->
<div id="cartolaZone" data-excel-global='{{ excel_global_json|safe }}'>
  <div class="tabla-responsive overflow-x-auto">
    <table class="table-auto w-full text-sm"
           style="white-space: nowrap;"
           data-columns-table="gz-cartola-historial"
           id="tabla-cartola">
      <thead class="bg-gray-100 text-gray-800 font-semibold text-center">
        <tr>
          <th class="p-2 border">
            <input type="checkbox" id="chkSelectAll" class="w-4 h-4">
          </th>

          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Usuario</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Fecha</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Fecha real del gasto</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Proyecto</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Categor√≠a</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Tipo</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>RUT factura</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Tipo de documento</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>N¬∞ Documento</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Observaciones</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>N¬∞ Transferencia</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Comprobante</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border text-right" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Cargos</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border text-right" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Abonos</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
          <th class="p-2 border" data-excel-col>
            <button type="button" class="excel-header-btn flex items-center gap-1">
              <span>Status</span><span class="excel-arrow text-gray-500">‚ñº</span>
            </button>
          </th>
        </tr>
      </thead>

      <tbody class="text-center">
        {% for mov in pagina %}
        <tr class="border-t">
          <td class="p-2 border">
            <input type="checkbox"
                   class="chk-row w-4 h-4"
                   value="{{ mov.id }}">
          </td>

          <td class="p-2 border">{{ mov.usuario }}</td>

          <td class="p-2 border" data-excel-value="{{ mov.fecha|date:'d-m-Y' }}">
            {{ mov.fecha|date:"d-m-Y" }}
          </td>

          <td class="p-2 border"
              data-excel-value="{% if mov.fecha_transaccion %}{{ mov.fecha_transaccion|date:'d-m-Y' }}{% else %}{{ mov.fecha|date:'d-m-Y' }}{% endif %}">
            {% if mov.fecha_transaccion %}
              {{ mov.fecha_transaccion|date:"d-m-Y" }}
            {% else %}
              {{ mov.fecha|date:"d-m-Y" }}
            {% endif %}
          </td>

          <td class="p-2 border">{{ mov.proyecto }}</td>
          <td class="p-2 border">{{ mov.tipo.categoria|title }}</td>
          <td class="p-2 border">{{ mov.tipo }}</td>

          <td class="p-2 border" data-excel-value="{{ mov.rut_factura|default:'‚Äî' }}">{{ mov.rut_factura|default:"‚Äî" }}</td>
          <td class="p-2 border" data-excel-value="{{ mov.tipo_doc|default:'‚Äî' }}">{{ mov.tipo_doc|default:"‚Äî" }}</td>
          <td class="p-2 border" data-excel-value="{{ mov.numero_doc|default:'‚Äî' }}">{{ mov.numero_doc|default:"‚Äî" }}</td>

          <td class="p-2 border" data-excel-value="{{ mov.observaciones|default:'(Vac√≠as)' }}">{{ mov.observaciones }}</td>

          <td class="p-2 border" data-excel-value="{{ mov.numero_transferencia|default:'‚Äî' }}">{{ mov.numero_transferencia|default:"‚Äî" }}</td>

          <td class="p-2 border" data-excel-value="{% if mov.comprobante %}Ver{% else %}‚Äî{% endif %}">
            {% if mov.comprobante %}
              <a href="{{ mov.comprobante.url }}" target="_blank" class="text-blue-600 underline">Ver</a>
            {% else %}
              ‚Äî
            {% endif %}
          </td>

          <td class="p-2 border text-right" data-excel-value="{{ mov.cargos|default:0|formato_clp }}">
            {{ mov.cargos|default:0|formato_clp }}
          </td>

          <td class="p-2 border text-right" data-excel-value="{{ mov.abonos|default:0|formato_clp }}">
            {{ mov.abonos|default:0|formato_clp }}
          </td>

          <td class="p-2 border" data-excel-value="{{ mov.get_status_display }}">
            {{ mov.get_status_display }}
          </td>
        </tr>
        {% empty %}
        <tr data-empty-row="1">
          <td colspan="16" class="p-4 text-center">No hay registros en historial.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ‚úÖ Selector de cantidad + preserva excel_filters -->
  <form method="get" class="flex items-center gap-2 mt-4">
    <label for="cantidad" class="text-sm font-medium text-gray-700">Mostrar:</label>
    <select name="cantidad" id="cantidad" onchange="this.form.submit()" class="border rounded-lg px-3 py-1">
      <option value="5"   {% if cantidad == '5' %}selected{% endif %}>5</option>
      <option value="10"  {% if cantidad == '10' %}selected{% endif %}>10</option>
      <option value="20"  {% if cantidad == '20' %}selected{% endif %}>20</option>
      <option value="50"  {% if cantidad == '50' %}selected{% endif %}>50</option>
      <option value="100" {% if cantidad == '100' %}selected{% endif %}>100</option>
    </select>

    {% if request.GET.excel_filters %}
      <input type="hidden" name="excel_filters" value="{{ request.GET.excel_filters }}">
    {% endif %}
  </form>

  <!-- ‚úÖ Paginaci√≥n (preserva cantidad + excel_filters) -->
  <div class="mt-4 flex justify-center gap-2 text-sm flex-wrap">
    {% if pagina.has_previous %}
      <a href="?page=1&cantidad={{ cantidad }}{% if request.GET.excel_filters %}&excel_filters={{ request.GET.excel_filters|urlencode }}{% endif %}"
         class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">¬´ Primero</a>
      <a href="?page={{ pagina.previous_page_number }}&cantidad={{ cantidad }}{% if request.GET.excel_filters %}&excel_filters={{ request.GET.excel_filters|urlencode }}{% endif %}"
         class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">‚Äπ Anterior</a>
    {% endif %}

    <span class="px-3 py-1">P√°gina {{ pagina.number }} de {{ pagina.paginator.num_pages }}</span>

    {% if pagina.has_next %}
      <a href="?page={{ pagina.next_page_number }}&cantidad={{ cantidad }}{% if request.GET.excel_filters %}&excel_filters={{ request.GET.excel_filters|urlencode }}{% endif %}"
         class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Siguiente ‚Ä∫</a>
      <a href="?page={{ pagina.paginator.num_pages }}&cantidad={{ cantidad }}{% if request.GET.excel_filters %}&excel_filters={{ request.GET.excel_filters|urlencode }}{% endif %}"
         class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">√öltimo ¬ª</a>
    {% endif %}
  </div>
</div>

<!-- Panel flotante tipo Excel -->
<div id="excelFilterPanel" class="excel-panel hidden">
  <h3 id="excelPanelTitle">Columna</h3>
  <small>Filtrar valores</small>

  <div class="mt-2">
    <input id="excelFilterSearch" type="text" placeholder="Buscar..."
           class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs">
  </div>

  <div class="mt-2 excel-options" id="excelFilterOptions"></div>

  <div class="mt-3 flex justify-end gap-2">
    <button type="button" id="excelFilterClearAll" class="px-2 py-1 border rounded-md text-xs">Limpiar</button>
    <button type="button" id="excelFilterApply" class="px-2 py-1 bg-blue-600 text-white rounded-md text-xs">Aplicar</button>
  </div>
</div>

<!-- ‚úÖ Devolver a Cartola (tu l√≥gica, intacta) -->
<script>
(function () {
  const btn = document.getElementById('btnDevolverCartola');
  const chkAll = document.getElementById('chkSelectAll');
  const table = document.getElementById('tabla-cartola');

  function getRowChecks() {
    return Array.from(table.querySelectorAll('input.chk-row'));
  }

  function getSelectedIds() {
    return getRowChecks().filter(c => c.checked).map(c => c.value);
  }

  function updateButtonState() {
    const selected = getSelectedIds().length > 0;
    btn.disabled = !selected;

    if (selected) {
      btn.classList.remove('opacity-50', 'cursor-not-allowed');
      btn.classList.add('hover:bg-blue-50');
    } else {
      btn.classList.add('opacity-50', 'cursor-not-allowed');
      btn.classList.remove('hover:bg-blue-50');
    }
  }

  chkAll.addEventListener('change', () => {
    const checks = getRowChecks();
    checks.forEach(c => c.checked = chkAll.checked);
    updateButtonState();
  });

  table.addEventListener('change', (e) => {
    if (e.target && e.target.classList.contains('chk-row')) {
      const checks = getRowChecks();
      const allChecked = checks.length > 0 && checks.every(c => c.checked);
      chkAll.checked = allChecked;
      updateButtonState();
    }
  });

  btn.addEventListener('click', async () => {
    const ids = getSelectedIds();
    if (!ids.length) return;

    btn.disabled = true;

    try {
      const csrf = (document.cookie.match(/csrftoken=([^;]+)/) || [])[1];

      const form = new FormData();
      ids.forEach(id => form.append('ids[]', id));

      const res = await fetch("{% url 'facturacion:devolver_a_cartola' %}", {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          ...(csrf ? {"X-CSRFToken": csrf} : {})
        },
        body: form
      });

      const data = await res.json();
      if (!data.ok) {
        alert(data.error || "No se pudo devolver.");
        updateButtonState();
        return;
      }

      window.location.reload();
    } catch (err) {
      console.error(err);
      alert("Error inesperado al devolver.");
      updateButtonState();
    }
  });

  updateButtonState();
})();
</script>

<!-- ‚úÖ FILTROS EXCEL (MISMA L√ìGICA QUE CARTOLA, ADAPTADA A HISTORIAL) -->
<script>
(function(){
  const zona = document.getElementById('cartolaZone');
  if(!zona) return;

  /* =================== Helpers guardar / cargar filtros Excel =================== */

  function getStorageKey(){
    return 'gzExcelFilters:historial:' + location.pathname;
  }

  function loadExcelFiltersFromStorage(){
    try{
      const raw = sessionStorage.getItem(getStorageKey());
      if(!raw) return {};
      const obj = JSON.parse(raw);
      const result = {};
      Object.entries(obj).forEach(([col, arr])=>{
        result[col] = new Set(arr);
      });
      return result;
    }catch(_){
      return {};
    }
  }

  function saveExcelFiltersToStorage(active){
    try{
      const plain = {};
      Object.entries(active).forEach(([col, set])=>{
        if(set && set.size) plain[col] = Array.from(set);
      });
      sessionStorage.setItem(getStorageKey(), JSON.stringify(plain));
    }catch(_){}
  }

  function parseExcelFiltersFromUrl(){
    try{
      const u = new URL(location.href);
      const raw = u.searchParams.get('excel_filters');
      if(!raw) return null;
      const obj = JSON.parse(raw);
      const result = {};
      Object.entries(obj).forEach(([col, arr])=>{
        result[col] = new Set(arr);
      });
      return result;
    }catch(_){
      return null;
    }
  }

  /* =================== Excel globals desde el servidor =================== */

  function loadExcelGlobalFromZona(){
    try{
      const raw = zona.dataset.excelGlobal || '{}';
      return JSON.parse(raw);
    }catch(_){
      return {};
    }
  }

  let excelGlobalValues = loadExcelGlobalFromZona();

  /* ======== Estado filtros tipo Excel ======== */
  const excel = {
    panel: document.getElementById('excelFilterPanel'),
    titleEl: document.getElementById('excelPanelTitle'),
    searchInput: document.getElementById('excelFilterSearch'),
    optsBox: document.getElementById('excelFilterOptions'),
    btnApply: document.getElementById('excelFilterApply'),
    btnClearCol: document.getElementById('excelFilterClearAll'),
    btnClearAllTop: document.getElementById('btnExcelClearAll'),
    table: null,
    tbody: null,
    headers: [],
    allRows: [],
    distinctValues: {},
    // ‚úÖ prioridad: URL -> storage
    activeFilters: (parseExcelFiltersFromUrl() || loadExcelFiltersFromStorage()),
    currentColIndex: null,
    panelEventsBound: false
  };

  // expuesto por si quieres serializar o debug
  window.excel_historial = excel;

  function excelGetCellValue(td){
    if(!td) return '(Vac√≠as)';
    let text = '';
    if (td.dataset && td.dataset.excelValue){
      text = td.dataset.excelValue;
    } else {
      text = (td.textContent || '');
    }
    text = (text || '').trim();
    return text || '(Vac√≠as)';
  }

  function excelBuildDistinctValues(){
    excel.distinctValues = {};

    // 1) valores globales del servidor (para no depender solo de la p√°gina actual)
    if (excelGlobalValues){
      Object.entries(excelGlobalValues).forEach(([idx, arr])=>{
        excel.distinctValues[idx] = new Set(arr);
      });
    }

    // 2) valores de la p√°gina actual (por si faltan en global)
    excel.allRows.forEach(row=>{
      Array.from(row.cells).forEach((td, idx)=>{
        if(!excel.distinctValues[idx]) excel.distinctValues[idx] = new Set();
        excel.distinctValues[idx].add(excelGetCellValue(td));
      });
    });
  }

  function excelUpdateHeaderStates(){
    excel.headers.forEach((th, idx)=>{
      if(!th.hasAttribute('data-excel-col')) return;
      const hasFilter = !!(excel.activeFilters[idx] && excel.activeFilters[idx].size > 0);
      th.classList.toggle('excel-col-filtered', hasFilter);
    });
  }

  function excelApplyFilters(){
    let visibleCount = 0;

    const emptyRow = excel.tbody ? excel.tbody.querySelector('tr[data-empty-row="1"]') : null;
    if (emptyRow) emptyRow.style.display = 'none';

    excel.allRows.forEach(row => {
      if (row.dataset && row.dataset.emptyRow === "1") {
        row.style.display = 'none';
        return;
      }

      let visible = true;

      for (const [colIndexStr, values] of Object.entries(excel.activeFilters)) {
        const idx = parseInt(colIndexStr, 10);
        if (!values || values.size === 0) continue;

        const cell = row.cells[idx];
        const text = excelGetCellValue(cell);

        if (!values.has(text)) {
          visible = false;
          break;
        }
      }

      row.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    });

    if (emptyRow) {
      emptyRow.style.display = (visibleCount === 0) ? '' : 'none';
    }

    excelUpdateHeaderStates();
    saveExcelFiltersToStorage(excel.activeFilters);
  }

  function excelClearAllFilters(){
    excel.activeFilters = {};
    excelApplyFilters();
    if(excel.panel) excel.panel.classList.add('hidden');
    // ‚úÖ limpiar url param para que no quede ‚Äúpegado‚Äù
    try{
      const u = new URL(location.href);
      u.searchParams.delete('excel_filters');
      history.replaceState(null,'',u.toString());
    }catch(_){}
  }

function excelFilterOptionList(query){
  if(!excel.optsBox) return;

  const q = (query || '').trim().toLowerCase();
  let visible = 0;

  excel.optsBox.querySelectorAll('label[data-option-label]').forEach(lbl=>{
    const cb = lbl.querySelector('input[type="checkbox"][data-value]');
    const val = ((cb && cb.dataset && cb.dataset.value) ? cb.dataset.value : (lbl.textContent || '')).toLowerCase();

    const show = !q || val.includes(q);
    lbl.style.display = show ? '' : 'none';
    if(show) visible++;
  });

  let msg = excel.optsBox.querySelector('[data-no-match="1"]');
  if(!msg){
    msg = document.createElement('div');
    msg.dataset.noMatch = "1";
    msg.className = "mt-2 text-xs text-gray-500";
    msg.textContent = "No hay resultados.";
    excel.optsBox.appendChild(msg);
  }
  msg.style.display = (q && visible === 0) ? '' : 'none';

  if(excel.btnApply){
    excel.btnApply.disabled = (q && visible === 0);
    excel.btnApply.classList.toggle('opacity-50', excel.btnApply.disabled);
    excel.btnApply.classList.toggle('cursor-not-allowed', excel.btnApply.disabled);
  }
}

  function excelRenderOptions(colIndex){
    if(!excel.optsBox) return;
    excel.optsBox.innerHTML = '';

    const valuesSet = excel.distinctValues[colIndex] || new Set();
    const values = Array.from(valuesSet).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
    const selected = excel.activeFilters[colIndex];

    // select all
    const allLabel = document.createElement('label');
    allLabel.className = 'flex items-center gap-1 mb-1 text-xs';
    const allCb = document.createElement('input');
    allCb.type = 'checkbox';
    allCb.dataset.selectAll = '1';
    allCb.checked = !selected || selected.size === values.length;

    allCb.addEventListener('change', ()=>{
      const q = (excel.searchInput?.value || '').trim().toLowerCase();
      const onlyVisible = !!q;

      const optionLabels = excel.optsBox.querySelectorAll('label[data-option-label]');
      optionLabels.forEach(lbl=>{
        if (onlyVisible && lbl.style.display === 'none') return;
        const cb = lbl.querySelector('input[type="checkbox"][data-value]');
        if(cb) cb.checked = allCb.checked;
      });
    });

    allLabel.appendChild(allCb);
    allLabel.appendChild(document.createTextNode(' (Seleccionar todo)'));
    excel.optsBox.appendChild(allLabel);

    values.forEach(val=>{
      const label = document.createElement('label');
      label.className = 'flex items-center gap-1 text-xs mt-0.5';
      label.dataset.optionLabel = '1';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.value = val;
      cb.checked = !selected || selected.has(val);

      label.appendChild(cb);
      label.appendChild(document.createTextNode(' ' + val));
      excel.optsBox.appendChild(label);
    });
  }

  function excelOpenForHeader(th){
    if(!excel.panel) return;

    excel.currentColIndex = parseInt(th.dataset.excelIndex, 10);
    excel.titleEl.textContent = th.innerText.trim();

    excelBuildDistinctValues();
    excelRenderOptions(excel.currentColIndex);

    const rect = th.getBoundingClientRect();
    const panelWidth  = excel.panel.offsetWidth || 260;
    const panelHeight = excel.panel.offsetHeight || 220;

    let left = rect.left + (rect.width - panelWidth) / 2;
    let top  = rect.bottom + 4;

    const minLeft = 8;
    const maxLeft = window.innerWidth - panelWidth - 8;
    if (left < minLeft) left = minLeft;
    if (left > maxLeft) left = maxLeft;

    const maxTop = window.innerHeight - panelHeight - 8;
    if (top > maxTop) top = maxTop;

    excel.panel.style.left = left + 'px';
    excel.panel.style.top  = top + 'px';

    excel.panel.classList.remove('hidden');
    excel.searchInput.value = '';
    excelFilterOptionList('');
    excel.searchInput.focus();
  }

  function excelBindPanelEventsOnce(){
  if(excel.panelEventsBound || !excel.panel) return;

  excel.searchInput.addEventListener('input', ()=>{
    excelFilterOptionList(excel.searchInput.value);
  });

  excel.searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      if (excel.btnApply && !excel.btnApply.disabled) excel.btnApply.click();
    }
  });

  excel.searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      e.preventDefault();
      excel.panel.classList.add('hidden');
    }
  });

  // ‚úÖ limpiar SOLO columna actual
  if (excel.btnClearCol) {
    excel.btnClearCol.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();

      if (excel.currentColIndex == null) {
        excel.panel.classList.add('hidden');
        return;
      }

      delete excel.activeFilters[excel.currentColIndex];

      excel.searchInput.value = '';
      excelBuildDistinctValues();
      excelRenderOptions(excel.currentColIndex);
      excelFilterOptionList('');

      excelApplyFilters();
      excel.panel.classList.add('hidden');

      updateUrlWithExcelFilters();
    });
  }

  // ‚úÖ aplicar columna actual
  excel.btnApply.addEventListener('click', ()=>{
    if(excel.currentColIndex == null){
      excel.panel.classList.add('hidden');
      return;
    }

    const q = (excel.searchInput?.value || '').trim().toLowerCase();

    // checkboxes visibles (si hay q) o todos (si no hay q)
    let chosenCheckboxes = [];

    if(q){
      const visibleLabels = Array.from(excel.optsBox.querySelectorAll('label[data-option-label]'))
        .filter(lbl => lbl.style.display !== 'none');

      chosenCheckboxes = visibleLabels
        .map(lbl => lbl.querySelector('input[type="checkbox"][data-value]'))
        .filter(Boolean);
    } else {
      chosenCheckboxes = Array.from(excel.optsBox.querySelectorAll('input[type="checkbox"][data-value]'));
    }

    // valores seleccionados (en el universo elegido)
    const selected = new Set();
    chosenCheckboxes.forEach(cb=>{
      if(cb.checked) selected.add(cb.dataset.value);
    });

    // universo completo de la columna (toda la data)
    const fullSet = excel.distinctValues[excel.currentColIndex] || new Set();

    // ‚úÖ universo visible cuando hay b√∫squeda (lo que est√°s viendo en el panel)
    const visibleUniverse = q
      ? new Set(chosenCheckboxes.map(cb => cb.dataset.value))
      : null;

    // L√≥gica:
    // - si no eliges nada -> sin filtro
    // - si NO hay b√∫squeda y eliges todo el fullSet -> sin filtro (comportamiento excel)
    // - si HAY b√∫squeda y eliges todo lo visible -> S√ç debe quedar filtro (porque est√°s filtrando por b√∫squeda)
    if(selected.size === 0){
      delete excel.activeFilters[excel.currentColIndex];
    } else if(!q && selected.size === fullSet.size){
      delete excel.activeFilters[excel.currentColIndex];
    } else if(q && visibleUniverse && selected.size === visibleUniverse.size){
      // ‚úÖ aplica filtro aunque sea "todo lo visible"
      excel.activeFilters[excel.currentColIndex] = selected;
    } else {
      excel.activeFilters[excel.currentColIndex] = selected;
    }

    excelApplyFilters();
    excel.panel.classList.add('hidden');
    updateUrlWithExcelFilters();
  });

  document.addEventListener('click', (e)=>{
    if(excel.panel.classList.contains('hidden')) return;
    if(excel.panel.contains(e.target)) return;
    if(e.target.closest('.excel-header-btn')) return;
    excel.panel.classList.add('hidden');
  });

  excel.panelEventsBound = true;
}
  function updateUrlWithExcelFilters(){
    try{
      const u = new URL(location.href);

      // serializar filtros activos
      const plain = {};
      Object.entries(excel.activeFilters).forEach(([col, set])=>{
        if(set && set.size) plain[col] = Array.from(set);
      });

      if(Object.keys(plain).length){
        u.searchParams.set('excel_filters', JSON.stringify(plain));
      }else{
        u.searchParams.delete('excel_filters');
      }

      // importante: si est√°s en page>1 y cambias filtros, te conviene resetear a 1
      // pero en historial normalmente filtras sobre la p√°gina actual, as√≠ que no tocamos page aqu√≠
      history.replaceState(null,'',u.toString());
    }catch(_){}
  }

  function initExcelFilters(){
    excelBindPanelEventsOnce();

    const table = zona.querySelector('#tabla-cartola');
    if(!table) return;

    excel.table   = table;
    excel.tbody   = table.querySelector('tbody');
    excel.headers = table.querySelectorAll('thead th');
    excel.allRows = Array.from(excel.tbody.rows);

    excelGlobalValues = loadExcelGlobalFromZona();

    excelBuildDistinctValues();
    excelApplyFilters();

    excel.headers.forEach((th, idx)=>{
      if(th.hasAttribute('data-excel-col')){
        th.dataset.excelIndex = idx;

        const btn = th.querySelector('.excel-header-btn');
        if(btn){
          btn.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            excelOpenForHeader(th);
          });
        }
      }
    });

    // al iniciar, dejar URL alineada a lo que haya en storage/url
    updateUrlWithExcelFilters();
  }

  // bot√≥n global ‚ÄúLimpiar filtros‚Äù
  if(excel.btnClearAllTop){
    excel.btnClearAllTop.addEventListener('click', (e)=>{
      e.preventDefault();
      excelClearAllFilters();
    });
  }

  initExcelFilters();

  // ‚úÖ Antes de navegar por paginaci√≥n, inyectar excel_filters actual al href (para que no se pierdan)
  document.addEventListener('click', (e)=>{
    const a = e.target.closest('a[href]');
    if(!a) return;
    if(!a.getAttribute('href').includes('page=')) return;

    // solo afecta links internos con page=
    try{
      const u = new URL(a.href, location.href);

      const plain = {};
      Object.entries(excel.activeFilters).forEach(([col, set])=>{
        if(set && set.size) plain[col] = Array.from(set);
      });

      if(Object.keys(plain).length){
        u.searchParams.set('excel_filters', JSON.stringify(plain));
      }else{
        u.searchParams.delete('excel_filters');
      }

      // preservar cantidad si existe en la URL actual
      const cur = new URL(location.href);
      const cantidad = cur.searchParams.get('cantidad');
      if(cantidad && !u.searchParams.get('cantidad')){
        u.searchParams.set('cantidad', cantidad);
      }

      a.href = u.toString();
    }catch(_){}
  });

})();
</script>

</div>
{% endblock %}