{% extends "dashboard_admin/base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Cartola de Movimientos{% endblock %}

{% block dashboard_content %}
<div class="bg-white shadow mt-3 -mx-3 sm:mx-0 rounded-none sm:rounded-2xl px-3 py-4 sm:p-6">
<style>
  .campo-filtro {
    border: 2px solid #1f2937;
    padding: 0.25rem 0.75rem;
    border-radius: 0.75rem;
    font-size: 0.875rem;
    height: 2.25rem;
    width: 100%;
    background-color: white;
    transition: border-color 0.2s ease-in-out;
  }
  .campo-filtro:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
    outline: none;
  }
  .tabla-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  table {
    white-space: nowrap;
    min-width: 1200px;
  }

  /* ====== Cabecera tipo Excel (filtros por columna) ====== */
  .excel-header-btn{
    width:100%;
    justify-content:center;
    font-size:0.875rem;
  }
  .excel-header-btn .excel-arrow{
    font-size:0.65rem;
    margin-left:2px;
  }
  .excel-header-btn:hover .excel-arrow{
    color:#111827;
  }
  .excel-panel{
    position:fixed;
    z-index:50;
    width:260px;
    background:#fff;
    border-radius:0.75rem;
    border:1px solid #d1d5db;
    box-shadow:0 10px 30px rgba(0,0,0,.15);
    padding:0.75rem;
    font-size:0.8rem;
  }
  .excel-panel h3{
    font-weight:600;
    margin-bottom:0.5rem;
  }
  .excel-panel small{
    font-size:0.7rem;
    color:#6b7280;
  }
  .excel-panel .excel-options{
    max-height:180px;
    overflow-y:auto;
    border:1px solid #e5e7eb;
    border-radius:0.5rem;
    padding:0.25rem 0.5rem;
    margin-top:0.25rem;
    background:#f9fafb;
  }
  .excel-col-filtered .excel-header-btn{
    background:#e0f2fe;
    border-radius:999px;
  }
  .excel-col-filtered .excel-arrow{
    color:#2563eb !important;
  }
</style>

<!-- T√≠tulo y botones -->
<div class="flex flex-col sm:flex-row justify-start items-start sm:items-center mb-4 gap-2">
  <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">üìë Cartola de Movimientos</h2>
  <div class="flex gap-2">
    <a href="{% url 'facturacion:crear_tipo' %}"
       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
      + Crear Tipo
    </a>
    <a href="{% url 'facturacion:crear_proyecto' %}"
       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
      + Crear Proyecto
    </a>
    <a href="{% url 'facturacion:registrar_abono' %}"
       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
      + Registrar Abono
    </a>
    <a href="{% url 'facturacion:exportar_cartola_finanzas' %}{% if full_qs %}?{{ full_qs }}{% endif %}"
       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm shadow">
      üì• Export to Excel
    </a>
    <button type="button"
        id="btnEnviarHistorial"
        disabled
        class="bg-gray-300 text-white px-4 py-2 rounded-full text-sm shadow cursor-not-allowed">
  üì¶ Enviar a Historial
</button>
<a href="{% url 'facturacion:listar_cartola_historial' %}"
   class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-full text-sm shadow">
  üìö Ver Historial
</a>
  </div>
</div>


<!-- Selector de columnas (igual) -->
<div class="flex justify-start mb-2">
  <details class="relative">
    <summary class="cursor-pointer text-sm text-gray-700 px-3 py-1 border rounded-full bg-gray-50 hover:bg-gray-100 select-none">
      ‚öôÔ∏è Columnas
    </summary>

    <div id="columnToggles" class="absolute left-0 mt-1 w-64 bg-white border rounded-xl shadow-lg p-3 z-10">
      <p class="text-xs text-gray-500 mb-2">Mostrar / ocultar columnas</p>

      <!-- Master checkbox -->
      <label class="flex items-center gap-2 mb-2 pb-2 border-b">
        <input type="checkbox" id="col-toggle-all" checked>
        <span class="font-semibold text-xs">Mostrar todas</span>
      </label>

      <div class="space-y-1 text-sm">
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="0" checked>
          <span>Usuario</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="1" checked>
          <span>Fecha</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="2" checked>
          <span>Fecha real del gasto</span>
        </label>
        <label class="flex items-center gap-2">
  <input type="checkbox" class="col-toggle" data-col="3" checked>
  <span>Veh√≠culo</span>
</label>
<label class="flex items-center gap-2">
  <input type="checkbox" class="col-toggle" data-col="4" checked>
  <span>Hora servicio</span>
</label>
<label class="flex items-center gap-2">
  <input type="checkbox" class="col-toggle" data-col="5" checked>
  <span>Kilometraje servicio</span>
</label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="6" checked>
          <span>Proyecto</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="7" checked>
          <span>Categor√≠a</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="8" checked>
          <span>Tipo</span>
        </label>

        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="9" checked>
          <span>RUT Factura</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="10" checked>
          <span>Tipo de Documento</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="11" checked>
          <span>N¬∞ Documento</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="12" checked>
          <span>Observaciones</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="13" checked>
          <span>N¬∞ Transferencia</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="14" checked>
          <span>Comprobante</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="15" checked>
          <span>Cargos</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="16" checked>
          <span>Abonos</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="17" checked>
          <span>Status</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="18" checked>
          <span>Acciones</span>
        </label>
      </div>
    </div>
  </details>
</div>

<!-- ‚úÖ Bot√≥n global de filtros Excel -->
<div class="flex justify-start mb-2">
  <button type="button"
          id="btnExcelClearAll"
          class="px-3 py-1 text-xs border rounded-full bg-white hover:bg-blue-50">
    ‚ùå Limpiar filtros
  </button>
</div>

<!-- ‚úÖ Zona tabla con excel_global_json (servidor) -->
<div id="cartolaZone" data-excel-global='{{ excel_global_json|safe }}'>
  <!-- Tabla responsive -->
  <div class="tabla-responsive overflow-x-auto">
    <table class="table-auto w-full text-sm min-w-full sm:min-w-[1200px]"
           style="white-space: nowrap;"
           data-columns-table="gz-cartola"
           id="tabla-cartola">
   <thead class="bg-gray-100 text-gray-800 font-semibold text-center">
  <tr>
    <th class="p-2 border">
      <input type="checkbox" id="chkAllHistorial">
    </th>

    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Usuario</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Fecha</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Fecha real del gasto</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <!-- ‚úÖ NUEVAS -->
    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Veh√≠culo</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Hora servicio</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border text-right" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Kilometraje servicio</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Proyecto</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Categor√≠a</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Tipo</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>RUT factura</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Tipo de documento</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>N√∫mero de documento</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Observaciones</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>N¬∞ Transferencia</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Comprobante</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border text-right" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Cargos</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border text-right" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Abonos</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border" data-excel-col>
      <button type="button" class="excel-header-btn flex items-center gap-1">
        <span>Status</span><span class="excel-arrow text-gray-500">‚ñº</span>
      </button>
    </th>

    <th class="p-2 border">Acciones</th>
  </tr>
</thead>

      <tbody class="text-center">
        {% for mov in pagina %}
        <tr class="border-t">
          <td class="p-2 border">
  <input type="checkbox" class="chkHistorial" value="{{ mov.id }}">
</td>
          <td class="p-2 border" data-excel-value="{{ mov.usuario }}">{{ mov.usuario }}</td>

          <!-- Fecha -->
          <td class="p-2 border" data-excel-value="{{ mov.fecha|date:'d-m-Y' }}">
            {{ mov.fecha|date:"d-m-Y" }}
          </td>

          <!-- Fecha real del gasto (si no hay, cae a fecha normal) -->
          <td class="p-2 border-b border-gray-200"
              data-excel-value="{% if mov.fecha_transaccion %}{{ mov.fecha_transaccion|date:'d-m-Y' }}{% else %}{{ mov.fecha|date:'d-m-Y' }}{% endif %}">
            {% if mov.fecha_transaccion %}
              {{ mov.fecha_transaccion|date:"d-m-Y" }}
            {% else %}
              {{ mov.fecha|date:"d-m-Y" }}
            {% endif %}
          </td>
          <!-- ‚úÖ NUEVOS CAMPOS FLOTA -->
<td class="p-2 border"
    data-excel-value="{% if mov.vehiculo_flota %}{{ mov.vehiculo_flota }}{% else %}‚Äî{% endif %}">
  {% if mov.vehiculo_flota %}{{ mov.vehiculo_flota }}{% else %}‚Äî{% endif %}
</td>

<td class="p-2 border"
    data-excel-value="{% if mov.hora_servicio_flota %}{{ mov.hora_servicio_flota|time:'H:i' }}{% else %}‚Äî{% endif %}">
  {% if mov.hora_servicio_flota %}{{ mov.hora_servicio_flota|time:"H:i" }}{% else %}‚Äî{% endif %}
</td>

<td class="p-2 border-b border-gray-200 text-right"
    data-excel-value="{% if mov.kilometraje_servicio_flota %}{{ mov.kilometraje_servicio_flota|miles }} KM{% else %}‚Äî{% endif %}">
  {% if mov.kilometraje_servicio_flota %}
    {{ mov.kilometraje_servicio_flota|miles }} KM
  {% else %}
    ‚Äî
  {% endif %}
</td>
          <td class="p-2 border" data-excel-value="{{ mov.proyecto }}">{{ mov.proyecto }}</td>
          <td class="p-2 border" data-excel-value="{{ mov.tipo.categoria|title }}">{{ mov.tipo.categoria|title }}</td>
          <td class="p-2 border" data-excel-value="{{ mov.tipo }}">{{ mov.tipo }}</td>

          <td class="p-2 border" data-excel-value="{{ mov.rut_factura|default:'‚Äî' }}">{{ mov.rut_factura|default:"‚Äî" }}</td>
          <td class="p-2 border" data-excel-value="{{ mov.tipo_doc|default:'‚Äî' }}">{{ mov.tipo_doc|default:"‚Äî" }}</td>
          <td class="p-2 border" data-excel-value="{{ mov.numero_doc|default:'‚Äî' }}">{{ mov.numero_doc|default:"‚Äî" }}</td>

          <td class="p-2 border" data-excel-value="{{ mov.observaciones|default:'(Vac√≠as)' }}">
            {{ mov.observaciones|default:"(Vac√≠as)" }}
          </td>

          <td class="p-2 border" data-excel-value="{{ mov.numero_transferencia|default:'‚Äî' }}">
            {{ mov.numero_transferencia|default:"‚Äî" }}
          </td>

          <!-- Comprobante -->
          <td class="p-2 border" data-excel-value="{% if mov.comprobante %}Ver{% else %}‚Äî{% endif %}">
            {% if mov.comprobante %}
              <a href="{{ mov.comprobante.url }}" target="_blank" class="text-blue-600 underline">Ver</a>
            {% else %}
              ‚Äî
            {% endif %}
          </td>

          <td class="p-2 border text-right" data-excel-value="{{ mov.cargos|default:0|formato_clp }}">
            {{ mov.cargos|default:0|formato_clp }}
          </td>

          <td class="p-2 border text-right" data-excel-value="{{ mov.abonos|default:0|formato_clp }}">
            {{ mov.abonos|default:0|formato_clp }}
          </td>

          <!-- Status (valor limpio para filtro Excel) -->
          <td class="p-2 border text-sm" data-excel-value="{{ mov.get_status_display }}">
            <div class="flex flex-col gap-1 text-left leading-tight">
              {% if mov.status == 'pendiente_supervisor' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                  ‚è≥ Pendiente aprobaci√≥n del Supervisor
                </span>
              {% elif mov.status == 'aprobado_supervisor' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                  ‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br>
                  ‚è≥ Pendiente aprobaci√≥n del PM
                </span>
              {% elif mov.status == 'rechazado_supervisor' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                  ‚ùå Rechazado por Supervisor
                </span>
              {% elif mov.status == 'aprobado_pm' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                  ‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br>
                  ‚úÖ PM: {{ mov.aprobado_por_pm.get_full_name }} <br>
                  ‚è≥ Pendiente aprobaci√≥n de Finanzas
                </span>
              {% elif mov.status == 'rechazado_pm' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                  ‚ùå Rechazado por PM
                </span>
              {% elif mov.status == 'aprobado_finanzas' %}
                <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">
                  ‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br>
                  ‚úÖ PM: {{ mov.aprobado_por_pm.get_full_name }} <br>
                  ‚úÖ Finanzas: {{ mov.aprobado_por_finanzas.get_full_name }}
                </span>
              {% elif mov.status == 'rechazado_finanzas' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                  ‚ùå Rechazado por Finanzas
                </span>
              {% elif mov.status == 'pendiente_abono_usuario' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                  ‚è≥ Pendiente aprobaci√≥n del Usuario
                </span>
              {% elif mov.status == 'aprobado_abono_usuario' %}
                <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">
                  ‚úÖ Abono aprobado por Usuario
                </span>
              {% elif mov.status == 'rechazado_abono_usuario' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                  ‚ùå Abono rechazado por Usuario
                </span>
              {% else %}
                {{ mov.get_status_display }}
              {% endif %}

              {% if 'rechazado' in mov.status and mov.motivo_rechazo %}
                <div class="mt-1 text-xs text-red-700 whitespace-pre-wrap break-words editable-motivo"
                     style="word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; max-width: 100%;">
                  <strong>Motivo:</strong> <span class="motivo-text">{{ mov.motivo_rechazo }}</span>
                </div>
              {% endif %}
            </div>
          </td>

          <!-- Acciones (igual) -->
          <td class="p-2 border">
            {# SUPERUSUARIO #}
            {% if user.is_superuser %}
              <a href="{% url 'facturacion:editar_movimiento' mov.id %}?next={{ request.get_full_path|urlencode }}"
                 class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-blue-200 transition">
                ‚úèÔ∏è Editar
              </a>
              <a href="{% url 'facturacion:eliminar_movimiento' mov.id %}?next={{ request.get_full_path|urlencode }}"
                 class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">
                üóëÔ∏è Eliminar
              </a>

              {% if mov.tipo.categoria != "abono" %}
                {% if mov.status == 'pendiente_supervisor' or mov.status == 'aprobado_supervisor' or mov.status == 'aprobado_pm' %}
                  <a href="#"
                     class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
                     data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">
                    ‚úÖ Aprobar gasto
                  </a>
                  <a href="#" onclick="return abrirModalRechazo({{ mov.id }});"
                     class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">
                    ‚ùå Rechazar gasto
                  </a>
                {% endif %}
              {% endif %}
            {% endif %}

            {# NO SUPERUSUARIO (gastos, no abonos) #}
            {% if not user.is_superuser and mov.tipo.categoria != "abono" %}

              {# Supervisor #}
              {% if user.es_supervisor and mov.status == "pendiente_supervisor" %}
                <a href="#"
                   class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
                   data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">
                  ‚úÖ Aprobar gasto
                </a>
                <a href="#" onclick="return abrirModalRechazo({{ mov.id }});"
                   class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">
                  ‚ùå Rechazar gasto
                </a>
              {% endif %}

              {# PM #}
              {% if user.es_pm and mov.status == "aprobado_supervisor" %}
                <a href="#"
                   class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
                   data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">
                  ‚úÖ Aprobar gasto
                </a>
                <a href="#" onclick="return abrirModalRechazo({{ mov.id }});"
                   class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">
                  ‚ùå Rechazar gasto
                </a>
              {% endif %}

              {# Finanzas #}
              {% if user.es_facturacion and mov.status == "aprobado_pm" %}
                <a href="#"
                   class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
                   data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">
                  ‚úÖ Aprobar gasto
                </a>
                <a href="#" onclick="return abrirModalRechazo({{ mov.id }});"
                   class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">
                  ‚ùå Rechazar gasto
                </a>
              {% endif %}

            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr data-empty-row="1">
          <td colspan="20" class="p-4 text-center">No hay movimientos registrados.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Selector de cantidad (igual) -->
  <form method="get" class="flex items-center gap-2 mt-4">
    <label for="cantidad" class="text-sm font-medium text-gray-700">Mostrar:</label>
    <select name="cantidad" id="cantidad" onchange="this.form.submit()" class="border rounded-lg px-3 py-1">
      <option value="5"   {% if cantidad == '5' %}selected{% endif %}>5</option>
      <option value="10"  {% if cantidad == '10' %}selected{% endif %}>10</option>
      <option value="20"  {% if cantidad == '20' %}selected{% endif %}>20</option>
      <option value="50"  {% if cantidad == '50' %}selected{% endif %}>50</option>
      <option value="100" {% if cantidad == '100' %}selected{% endif %}>100</option>
    </select>

    <!-- Preservar filtros actuales (igual) -->
    <input type="hidden" name="usuario"     value="{{ filtros.usuario }}">
    <input type="hidden" name="fecha"       value="{{ filtros.fecha }}">
    <input type="hidden" name="fecha_real"  value="{{ filtros.fecha_real }}">
    <input type="hidden" name="proyecto"    value="{{ filtros.proyecto }}">
    <input type="hidden" name="categoria"   value="{{ filtros.categoria }}">
    <input type="hidden" name="tipo"        value="{{ filtros.tipo }}">
    <input type="hidden" name="rut_factura" value="{{ filtros.rut_factura }}">
    <input type="hidden" name="estado"      value="{{ filtros.estado }}">
    <input type="hidden" name="hora_servicio" value="{{ filtros.hora_servicio }}">
    <input type="hidden" name="kilometraje_servicio" value="{{ filtros.kilometraje_servicio }}">

    <!-- ‚úÖ preservar filtros excel si vienen por GET (en recarga normal) -->
    {% if request.GET.excel_filters %}
      <input type="hidden" name="excel_filters" value="{{ request.GET.excel_filters }}">
    {% endif %}
  </form>

  <!-- Paginaci√≥n (igual) -->
  <div class="mt-4 flex justify-center gap-2 text-sm flex-wrap">
  {% if pagina.has_previous %}
    <a href="?page=1{% if base_qs %}&{{ base_qs }}{% endif %}"
       class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">¬´ Primero</a>
    <a href="?page={{ pagina.previous_page_number }}{% if base_qs %}&{{ base_qs }}{% endif %}"
       class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">‚Äπ Anterior</a>
  {% endif %}

  <span class="px-3 py-1">P√°gina {{ pagina.number }} de {{ pagina.paginator.num_pages }}</span>

  {% if pagina.has_next %}
    <a href="?page={{ pagina.next_page_number }}{% if base_qs %}&{{ base_qs }}{% endif %}"
       class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Siguiente ‚Ä∫</a>
    <a href="?page={{ pagina.paginator.num_pages }}{% if base_qs %}&{{ base_qs }}{% endif %}"
       class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">√öltimo ¬ª</a>
  {% endif %}
</div>
</div>

<!-- Modal de rechazo (igual) -->
<div id="modalRechazo" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6">
    <h2 class="text-lg font-bold text-gray-800 mb-4">Motivo del Rechazo</h2>
    <form id="formRechazo" method="POST" action="">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.get_full_path }}">
      <textarea name="motivo_rechazo" rows="4" required
                class="w-full border rounded-lg p-2 mb-4"
                placeholder="Escribe el motivo del rechazo"></textarea>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="cerrarModalRechazo()"
                class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Rechazar</button>
      </div>
    </form>
  </div>
</div>


<!-- ‚úÖ Modal bonito (reutilizable) -->
<div id="modalNice" class="fixed inset-0 hidden items-center justify-center z-[60]">
  <!-- overlay -->
  <div class="absolute inset-0 bg-black/50"></div>

  <!-- card -->
  <div class="relative bg-white w-full max-w-md mx-4 rounded-2xl shadow-2xl border border-gray-100 overflow-hidden">
    <div id="modalNiceBar" class="h-1.5 bg-blue-600"></div>

    <div class="p-6">
      <div class="flex items-start gap-3">
        <div id="modalNiceIcon"
             class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center bg-blue-50 text-blue-700">
          <!-- icon -->
          <span id="modalNiceIconChar" class="text-lg">‚ÑπÔ∏è</span>
        </div>

        <div class="flex-1">
          <h3 id="modalNiceTitle" class="text-lg font-bold text-gray-900">Mensaje</h3>
          <p id="modalNiceMsg" class="mt-1 text-sm text-gray-700 leading-relaxed"></p>
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-2">
        <button type="button"
                onclick="closeNiceModal()"
                class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm font-semibold">
          Cerrar
        </button>
        <button type="button"
                id="modalNiceOk"
                onclick="closeNiceModal()"
                class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold">
          Aceptar
        </button>
      </div>
    </div>
  </div>
</div>



<script>
  function abrirModalRechazo(id) {
    const modal = document.getElementById('modalRechazo');
    const form  = document.getElementById('formRechazo');

    form.action = `/facturacion/cartola/rechazar/${id}/`;

    const nextInput = form.querySelector('input[name="next"]');
    if (nextInput) {
      nextInput.value = location.pathname + location.search;
    }

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    return false;
  }

  function cerrarModalRechazo() {
    const modal = document.getElementById('modalRechazo');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
</script>

<!-- ‚úÖ Panel flotante tipo Excel -->
<div id="excelFilterPanel" class="excel-panel hidden">
  <h3 id="excelPanelTitle">Columna</h3>
  <small>Filtrar valores</small>

  <div class="mt-2">
    <input id="excelFilterSearch"
           type="text"
           placeholder="Buscar..."
           class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs">
  </div>

  <div class="mt-2 excel-options" id="excelFilterOptions">
    <!-- opciones din√°micas -->
  </div>

  <div class="mt-3 flex justify-end gap-2">
    <button type="button"
            id="excelFilterClearAll"
            class="px-2 py-1 border rounded-md text-xs">
      Limpiar
    </button>
    <button type="button"
            id="excelFilterApply"
            class="px-2 py-1 bg-blue-600 text-white rounded-md text-xs">
      Aplicar
    </button>
  </div>
</div>

<!-- Filtros + paginaci√≥n por AJAX (tu script, con ajuste para mantener excel_filters) -->
<script>
(function () {
  const form = document.getElementById('form-filtros');
  let zone = document.getElementById('cartolaZone');
  if (!form || !zone) return;

  function qsFromForm() {
    const fd = new FormData(form);
    const params = new URLSearchParams(fd);

    // Eliminar par√°metros vac√≠os
    form.querySelectorAll('input[type="text"], select').forEach(el => {
      const v = (el.value || '').trim();
      if (v === '') params.delete(el.name);
    });

    // ‚úÖ Incluir filtros Excel en querystring
    if (window.excel && window.excel.activeFilters) {
      const plain = {};
      Object.entries(window.excel.activeFilters).forEach(([col, set]) => {
        if (set && set.size) plain[col] = Array.from(set);
      });
      if (Object.keys(plain).length) {
        params.set('excel_filters', JSON.stringify(plain));
      } else {
        params.delete('excel_filters');
      }
    }

    return params;
  }

  async function refreshList(extraParams = {}) {
    // guardar foco y caret
    const active = document.activeElement;
    const activeName = active && active.name;
    const caretPos = (active && active.selectionStart) ?? null;

    const params = qsFromForm();
    Object.entries(extraParams).forEach(([k, v]) => params.set(k, v));

    const url = `${location.pathname}?${params.toString()}`;
    const res = await fetch(url, { headers: { 'X-Requested-With': 'fetch' }});
    const html = await res.text();

    const doc = new DOMParser().parseFromString(html, 'text/html');
    const newZone = doc.querySelector('#cartolaZone');
    if (!newZone) { location.href = url; return; }

    zone.replaceWith(newZone);
    zone = document.getElementById('cartolaZone');
    wirePagination(zone);

    // ‚úÖ re-aplicar columnas si est√° disponible
    if (window.reApplyCartolaColumns) {
      window.reApplyCartolaColumns();
    }

    // ‚úÖ re-enganchar aprobar si est√° disponible
    if (window.engancharAprobarCartola) {
      window.engancharAprobarCartola();
    }

    // ‚úÖ reiniciar filtros excel
    if (window.initExcelFiltersGZ) {
      window.initExcelFiltersGZ();
    }

    // ‚úÖ RE-ENGANCHAR HISTORIAL (ESTO FALTABA)
    if (window.bindHistorialControls) {
      window.bindHistorialControls();
    }

    // restaurar foco/caret
    if (activeName) {
      const again = form.querySelector(`[name="${activeName}"]`);
      if (again) {
        again.focus();
        if (caretPos !== null && again.setSelectionRange) {
          const end = again.value.length;
          const pos = Math.min(caretPos, end);
          again.setSelectionRange(pos, pos);
        }
      }
    }

    // actualizar URL
    history.replaceState(null, '', url);
  }

  function wirePagination(scope) {
    (scope || document).querySelectorAll('a[href*="page="]').forEach(a => {
      a.addEventListener('click', (ev) => {
        ev.preventDefault();
        const u = new URL(a.href, location.href);
        const page = u.searchParams.get('page') || '1';
        refreshList({ page });
      });
    });
  }
  wirePagination(zone);

  // Debounce
  let t;
  const debouncedRefresh = (extra = {}) => {
    clearTimeout(t);
    t = setTimeout(() => refreshList({ page: 1, ...extra }), 300);
  };

  // Autofiltrado
  form.addEventListener('input', (e) => {
    if (e.target.matches('input[type="text"], select')) debouncedRefresh();
  });
  form.addEventListener('change', (e) => {
    if (e.target.matches('input[type="text"], select')) debouncedRefresh();
  });
  form.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.matches('input[type="text"]')) {
      e.preventDefault();
      refreshList({ page: 1 });
    }
  });

  // Exponer refreshList por si lo quieres desde otros scripts
  window.refreshCartolaList = refreshList;
})();
</script>
<!-- Mantener scroll horizontal (igual) -->
<script>
/* ====== Mantener scroll horizontal en Cartola (GZ Services) ====== */
(function () {
  const KEY = 'gz-cartola-scrollX:' + location.pathname;

  function getBox() {
    return document.querySelector('#cartolaZone .tabla-responsive');
  }

  function saveX(x){
    try { sessionStorage.setItem(KEY, String(x)); } catch(_) {}
  }
  function readX(){
    try { return Number(sessionStorage.getItem(KEY) || 0); } catch(_) { return 0; }
  }

  function attachSaver(box){
    if (!box || box.__hasScrollSaver) return;
    box.__hasScrollSaver = true;
    let t = null;
    box.addEventListener('scroll', () => {
      if (t) return;
      t = setTimeout(() => { t = null; saveX(box.scrollLeft); }, 120);
    }, { passive: true });
  }

  function restoreNow(){
    const box = getBox();
    if (!box) return;
    requestAnimationFrame(() => {
      box.scrollLeft = readX();
    });
    attachSaver(box);
  }

  // 1) Al cargar
  document.addEventListener('DOMContentLoaded', restoreNow);

  // 2) Si #cartolaZone se reemplaza por AJAX, volver a aplicar
  const zone = document.getElementById('cartolaZone');
  if (zone) {
    const mo = new MutationObserver((muts) => {
      for (const m of muts) {
        if (m.type === 'childList' && (m.addedNodes.length || m.removedNodes.length)) {
          setTimeout(restoreNow, 0);
          break;
        }
      }
    });
    mo.observe(zone.parentNode || zone, { childList: true, subtree: true });
  }

  // 3) Antes de salir/recargar
  window.addEventListener('beforeunload', () => {
    const box = getBox();
    if (box) saveX(box.scrollLeft);
  });
})();
</script>

<!-- Gesti√≥n de columnas con localStorage (igual) -->
<script>
(function () {
  const panel = document.getElementById('columnToggles');
  if (!panel) return;

  function getTable() {
    return document.querySelector('[data-columns-table]') ||
           document.querySelector('#cartolaZone table') ||
           document.querySelector('table');
  }

  const firstTable = getTable();
  const tableId = (firstTable && firstTable.dataset.columnsTable) || location.pathname;
  const STORAGE_KEY = 'cols:' + tableId;

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return {};
      const obj = JSON.parse(raw);
      return obj && typeof obj === 'object' ? obj : {};
    } catch (e) {
      return {};
    }
  }

  function saveState(state) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {}
  }

  function applyVisibility() {
    const table = getTable();
    if (!table) return;

    const state = loadState();

    const theadCells = table.querySelectorAll('thead tr th');
    theadCells.forEach((th, idx) => {
      const visible = state[idx] !== false;
      th.style.display = visible ? '' : 'none';
    });

    table.querySelectorAll('tbody tr').forEach((tr) => {
      const tds = tr.querySelectorAll('td');
      tds.forEach((td, idx) => {
        const visible = state[idx] !== false;
        td.style.display = visible ? '' : 'none';
      });
    });

    const checks = panel.querySelectorAll('.col-toggle');
    const master = panel.querySelector('#col-toggle-all');
    let allOn = true;

    checks.forEach((cb) => {
      const idx = parseInt(cb.dataset.col || '0', 10);
      const visible = state[idx] !== false;
      cb.checked = visible;
      if (!visible) allOn = false;
    });

    if (master) {
      master.checked = allOn;
    }
  }

  function bindToggles() {
    const checks = panel.querySelectorAll('.col-toggle');
    const master = panel.querySelector('#col-toggle-all');

    checks.forEach((cb) => {
      cb.addEventListener('change', () => {
        const idx = parseInt(cb.dataset.col || '0', 10);
        const state = loadState();
        state[idx] = cb.checked;
        saveState(state);
        applyVisibility();
      });
    });

    if (master) {
      master.addEventListener('change', () => {
        const val = master.checked;
        const state = loadState();

        checks.forEach((cb) => {
          const idx = parseInt(cb.dataset.col || '0', 10);
          cb.checked = val;
          state[idx] = val;
        });

        saveState(state);
        applyVisibility();
      });
    }
  }

  function bindOutsideClickToClose() {
    const details = panel.closest('details');
    if (!details) return;

    document.addEventListener('click', (e) => {
      if (!details.open) return;
      if (details.contains(e.target)) return;
      details.open = false;
    });
  }

  bindToggles();
  applyVisibility();
  bindOutsideClickToClose();

  // Exponer para re-aplicar despu√©s de AJAX
  window.reApplyCartolaColumns = applyVisibility;
})();
</script>

<!-- Aprobar por AJAX (igual) -->
<script>
(function () {
  function engancharAprobarCartola() {
    document.querySelectorAll('.js-approve').forEach(btn => {
      if (btn.__hasApproveHandler) return;
      btn.__hasApproveHandler = true;

      btn.addEventListener('click', async (e) => {
        e.preventDefault();

        const url = btn.dataset.url;
        const row = btn.closest('tr');
        if (!url || !row) return;

        if (btn.dataset.loading === '1') return;
        btn.dataset.loading = '1';

        const originalText = btn.textContent;
        btn.textContent    = 'Aprobando...';

        try {
          const fd = new FormData();
          fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');

          const resp = await fetch(url, {
            method: 'POST',
            body: fd,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
            },
          });

          let data = {};
          try {
            data = await resp.json();
          } catch (_) {}

          if (!resp.ok || !data.ok) {
            const msg = (data && data.error) || 'No se pudo aprobar el movimiento.';
            openNiceModal({
  title: "No se pudo aprobar",
  message: msg,
  type: "error"
});
            btn.textContent     = originalText;
            btn.dataset.loading = '';
            return;
          }

          row.style.transition = 'opacity 0.2s ease';
          row.style.opacity    = '0.4';
          setTimeout(() => {
            row.remove();
          }, 200);

          // ‚úÖ Re-aplicar filtros Excel sobre lo que queda visible en la p√°gina
          if (window.excel && window.excel.table && window.excel.tbody){
            window.excel.allRows = Array.from(window.excel.tbody.rows);
            window.excelApplyFiltersGZ && window.excelApplyFiltersGZ();
          }

        } catch (err) {
          console.error(err);
     openNiceModal({
  title: "Error de red",
  message: "No se pudo aprobar el movimiento. Revisa tu conexi√≥n e int√©ntalo nuevamente.",
  type: "error"
});
          btn.textContent     = originalText;
          btn.dataset.loading = '';
        }
      });
    });
  }

  document.addEventListener('DOMContentLoaded', engancharAprobarCartola);
  window.engancharAprobarCartola = engancharAprobarCartola;
})();
</script>

<script>
(function(){
  const zona = document.getElementById('cartolaZone');
  if(!zona) return;

  /* =================== Helpers guardar / cargar filtros Excel =================== */

  function loadExcelFilters(){
    try{
      const key = 'gzExcelFilters:' + location.pathname;
      const raw = sessionStorage.getItem(key);
      if(!raw) return {};
      const obj = JSON.parse(raw);
      const result = {};
      Object.entries(obj).forEach(([col, arr])=>{
        result[col] = new Set(arr);
      });
      return result;
    }catch(_){
      return {};
    }
  }

  function saveExcelFilters(active){
    try{
      const key = 'gzExcelFilters:' + location.pathname;
      const plain = {};
      Object.entries(active).forEach(([col, set])=>{
        plain[col] = Array.from(set);
      });
      sessionStorage.setItem(key, JSON.stringify(plain));
    }catch(_){}
  }

  /* =================== Excel globals desde el servidor =================== */

  function loadExcelGlobalFromZona(){
    try{
      const raw = zona.dataset.excelGlobal || '{}';
      return JSON.parse(raw);
    }catch(_){
      return {};
    }
  }

  let excelGlobalValues = loadExcelGlobalFromZona();

  /* ======== Estado filtros tipo Excel ======== */
  const excel = {
    panel: document.getElementById('excelFilterPanel'),
    titleEl: document.getElementById('excelPanelTitle'),
    searchInput: document.getElementById('excelFilterSearch'),
    optsBox: document.getElementById('excelFilterOptions'),
    btnApply: document.getElementById('excelFilterApply'),
    btnClearAll: document.getElementById('excelFilterClearAll'),
    table: null,
    tbody: null,
    headers: [],
    allRows: [],
    distinctValues: {},
    activeFilters: loadExcelFilters(),
    currentColIndex: null,
    panelEventsBound: false
  };

  window.excel = excel; // ‚úÖ para que el refreshList pueda serializarlos

  // ‚úÖ Normalizador (evita fallos por &nbsp;, saltos de l√≠nea, dobles espacios, may√∫sculas)
  function normalizeValue(s){
    s = (s ?? '').toString();
    s = s.replace(/\u00A0/g, ' ');     // NBSP -> espacio normal
    s = s.replace(/\s+/g, ' ');        // colapsar espacios/saltos de l√≠nea
    s = s.trim().toLowerCase();
    return s;
  }

  function excelGetCellValue(td){
    if(!td) return '(Vac√≠as)';
    let text = '';
    if (td.dataset && td.dataset.excelValue){
      text = td.dataset.excelValue;
    } else {
      text = (td.textContent || '');
    }
    text = (text || '').replace(/\u00A0/g, ' ').trim();
    return text || '(Vac√≠as)';
  }

  function excelBuildDistinctValues(){
    excel.distinctValues = {};

    if (excelGlobalValues){
      Object.entries(excelGlobalValues).forEach(([idx, arr])=>{
        excel.distinctValues[idx] = new Set(arr);
      });
    }

    excel.allRows.forEach(row=>{
      Array.from(row.cells).forEach((td, idx)=>{
        if(!excel.distinctValues[idx]) excel.distinctValues[idx] = new Set();
        excel.distinctValues[idx].add(excelGetCellValue(td));
      });
    });
  }

  function excelUpdateHeaderStates(){
    if(!excel.headers) return;
    excel.headers.forEach((th, idx)=>{
      if(!th.hasAttribute('data-excel-col')) return;
      const hasFilter = !!(excel.activeFilters[idx] && excel.activeFilters[idx].size > 0);
      th.classList.toggle('excel-col-filtered', hasFilter);
    });
  }

  function excelApplyFilters(){
    let visibleCount = 0;

    // ‚úÖ cache de valores normalizados por columna (para comparar r√°pido y sin ‚Äúmismatch‚Äù)
    const normCache = {};
    Object.entries(excel.activeFilters).forEach(([colIndexStr, values])=>{
      if(values && values.size){
        normCache[colIndexStr] = new Set(Array.from(values).map(normalizeValue));
      }
    });

    const emptyRow = excel.tbody ? excel.tbody.querySelector('tr[data-empty-row="1"]') : null;
    if (emptyRow) emptyRow.style.display = 'none';

    excel.allRows.forEach(row => {
      if (row.dataset && row.dataset.emptyRow === "1") {
        row.style.display = 'none';
        return;
      }

      let visible = true;

      for (const [colIndexStr, values] of Object.entries(excel.activeFilters)) {
        const idx = parseInt(colIndexStr, 10);
        if (!values || values.size === 0) continue;

        const cell = row.cells[idx];
        const raw = excelGetCellValue(cell);
        const t = normalizeValue(raw);

        const allowed = normCache[colIndexStr];
        if (allowed && !allowed.has(t)) {
          visible = false;
          break;
        }
      }

      row.style.display = visible ? '' : 'none';
      if (visible) visibleCount++;
    });

    if (emptyRow) {
      emptyRow.style.display = (visibleCount === 0) ? '' : 'none';
    }

    excelUpdateHeaderStates();
    saveExcelFilters(excel.activeFilters);
  }

  window.excelApplyFiltersGZ = excelApplyFilters;

  // ‚úÖ Helper: refrescar servidor (para que el filtro aplique a TODAS las p√°ginas)
  async function refreshServerToPage1(){
    if (window.refreshCartolaList) {
      await window.refreshCartolaList({ page: 1 });
    } else {
      // fallback (si no est√° el ajax activo)
      const params = new URLSearchParams(location.search);
      params.set('page', '1');

      if (window.excel && window.excel.activeFilters) {
        const plain = {};
        Object.entries(window.excel.activeFilters).forEach(([col, set]) => {
          if (set && set.size) plain[col] = Array.from(set);
        });
        if (Object.keys(plain).length) {
          params.set('excel_filters', JSON.stringify(plain));
        } else {
          params.delete('excel_filters');
        }
      }

      location.href = `${location.pathname}?${params.toString()}`;
    }
  }

  function excelClearAll(){
    excel.activeFilters = {};
    excelApplyFilters();
    if(excel.panel) excel.panel.classList.add('hidden');

    // ‚úÖ IMPORTANTE: aplicar filtro a todo el dataset (server) y volver a page 1
    refreshServerToPage1();
  }

  function excelFilterOptionList(query){
    if(!excel.optsBox) return;

    const q = (query || '').trim().toLowerCase();
    let visible = 0;

    excel.optsBox.querySelectorAll('label[data-option-label]').forEach(lbl=>{
      const text = (lbl.textContent || '').toLowerCase();
      const show = !q || text.includes(q);
      lbl.style.display = show ? '' : 'none';
      if(show) visible++;
    });

    let msg = excel.optsBox.querySelector('[data-no-match="1"]');
    if(!msg){
      msg = document.createElement('div');
      msg.dataset.noMatch = "1";
      msg.className = "mt-2 text-xs text-gray-500";
      msg.textContent = "No hay resultados.";
      excel.optsBox.appendChild(msg);
    }
    msg.style.display = (q && visible === 0) ? '' : 'none';

    if(excel.btnApply){
      excel.btnApply.disabled = (q && visible === 0);
      excel.btnApply.classList.toggle('opacity-50', excel.btnApply.disabled);
      excel.btnApply.classList.toggle('cursor-not-allowed', excel.btnApply.disabled);
    }
  }

  function excelRenderOptions(colIndex){
    if(!excel.optsBox) return;
    excel.optsBox.innerHTML = '';

    const valuesSet = excel.distinctValues[colIndex] || new Set();
    const values = Array.from(valuesSet).sort((a,b)=>a.localeCompare(b,'es',{sensitivity:'base'}));
    const selected = excel.activeFilters[colIndex];

    const allLabel = document.createElement('label');
    allLabel.className = 'flex items-center gap-1 mb-1 text-xs';
    const allCb = document.createElement('input');
    allCb.type = 'checkbox';
    allCb.dataset.selectAll = '1';
    allCb.checked = !selected || selected.size === values.length;

    allCb.addEventListener('change', ()=>{
      const q = (excel.searchInput?.value || '').trim().toLowerCase();
      const onlyVisible = !!q;

      const optionLabels = excel.optsBox.querySelectorAll('label[data-option-label]');
      optionLabels.forEach(lbl=>{
        if (onlyVisible && lbl.style.display === 'none') return;
        const cb = lbl.querySelector('input[type="checkbox"][data-value]');
        if(cb) cb.checked = allCb.checked;
      });
    });

    allLabel.appendChild(allCb);
    allLabel.appendChild(document.createTextNode(' (Seleccionar todo)'));
    excel.optsBox.appendChild(allLabel);

    values.forEach(val=>{
      const label = document.createElement('label');
      label.className = 'flex items-center gap-1 text-xs mt-0.5';
      label.dataset.optionLabel = '1';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.value = val;
      cb.checked = !selected || selected.has(val);

      label.appendChild(cb);
      label.appendChild(document.createTextNode(' ' + val));
      excel.optsBox.appendChild(label);
    });
  }

  function excelOpenForHeader(th){
    if(!excel.panel) return;

    excel.currentColIndex = parseInt(th.dataset.excelIndex, 10);
    excel.titleEl.textContent = th.innerText.trim();

    excelBuildDistinctValues();
    excelRenderOptions(excel.currentColIndex);

    const rect = th.getBoundingClientRect();
    const panelWidth  = excel.panel.offsetWidth || 260;
    const panelHeight = excel.panel.offsetHeight || 220;

    let left = rect.left + (rect.width - panelWidth) / 2;
    let top  = rect.bottom + 4;

    const minLeft = 8;
    const maxLeft = window.innerWidth - panelWidth - 8;
    if (left < minLeft) left = minLeft;
    if (left > maxLeft) left = maxLeft;

    const maxTop = window.innerHeight - panelHeight - 8;
    if (top > maxTop) top = maxTop;

    excel.panel.style.left = left + 'px';
    excel.panel.style.top  = top + 'px';

    excel.panel.classList.remove('hidden');
    excel.searchInput.value = '';
    excelFilterOptionList('');
    excel.searchInput.focus();
  }

  function excelBindPanelEventsOnce(){
    if(excel.panelEventsBound || !excel.panel) return;

    excel.searchInput.addEventListener('input', ()=>{
      excelFilterOptionList(excel.searchInput.value);
    });

    excel.searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (excel.btnApply && !excel.btnApply.disabled) excel.btnApply.click();
      }
    });

    excel.searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        excel.panel.classList.add('hidden');
      }
    });

    // ‚úÖ CLEAR: limpia SOLO la columna actual
    if (excel.btnClearAll) {
      excel.btnClearAll.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        if (excel.currentColIndex == null) {
          excel.panel.classList.add('hidden');
          return;
        }

        delete excel.activeFilters[excel.currentColIndex];

        excel.searchInput.value = '';
        excelBuildDistinctValues();
        excelRenderOptions(excel.currentColIndex);
        excelFilterOptionList('');

        excelApplyFilters();
        excel.panel.classList.add('hidden');

        // ‚úÖ IMPORTANTE: aplicar filtro a todo el dataset (server) y volver a page 1
        refreshServerToPage1();
      });
    }

    // ‚úÖ APPLY: aplica filtro SOLO a la columna actual
    excel.btnApply.addEventListener('click', ()=>{
      if(excel.currentColIndex == null){
        excel.panel.classList.add('hidden');
        return;
      }

      const q = (excel.searchInput?.value || '').trim().toLowerCase();

      let chosenCheckboxes = [];

      if(q){
        const visibleLabels = Array.from(excel.optsBox.querySelectorAll('label[data-option-label]'))
          .filter(lbl => lbl.style.display !== 'none');

        chosenCheckboxes = visibleLabels
          .map(lbl => lbl.querySelector('input[type="checkbox"][data-value]'))
          .filter(Boolean);
      }else{
        chosenCheckboxes = Array.from(excel.optsBox.querySelectorAll('input[type="checkbox"][data-value]'));
      }

      const selected = new Set();
      chosenCheckboxes.forEach(cb=>{
        if(cb.checked) selected.add(cb.dataset.value);
      });

      const fullSet = excel.distinctValues[excel.currentColIndex] || new Set();

      if(!q){
        if(selected.size === 0 || selected.size === fullSet.size){
          delete excel.activeFilters[excel.currentColIndex];
        }else{
          excel.activeFilters[excel.currentColIndex] = selected;
        }
      }else{
        if(selected.size === 0){
          delete excel.activeFilters[excel.currentColIndex];
        }else{
          if(selected.size === fullSet.size){
            delete excel.activeFilters[excel.currentColIndex];
          }else{
            excel.activeFilters[excel.currentColIndex] = selected;
          }
        }
      }

      excelApplyFilters();
      excel.panel.classList.add('hidden');

      // ‚úÖ IMPORTANTE: aplicar filtro a todo el dataset (server) y volver a page 1
      refreshServerToPage1();
    });

    document.addEventListener('click', (e)=>{
      if(excel.panel.classList.contains('hidden')) return;
      if(excel.panel.contains(e.target)) return;
      if(e.target.closest('.excel-header-btn')) return;
      excel.panel.classList.add('hidden');
    });

    excel.panelEventsBound = true;
  }

  function initExcelFilters(){
    excelBindPanelEventsOnce();

    const table = zona.querySelector('#tabla-cartola');
    if(!table) return;

    excel.table   = table;
    excel.tbody   = table.querySelector('tbody');
    excel.headers = table.querySelectorAll('thead th');
    excel.allRows = Array.from(excel.tbody.rows);

    excelGlobalValues = loadExcelGlobalFromZona(); // por si cambi√≥ con AJAX

    excelBuildDistinctValues();
    excelApplyFilters();

    excel.headers.forEach((th, idx)=>{
      if(th.hasAttribute('data-excel-col')){
        th.dataset.excelIndex = idx;
        const btn = th.querySelector('.excel-header-btn');
        if(btn){
          btn.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            excelOpenForHeader(th);
          });
        }
      }
    });
  }

  window.initExcelFiltersGZ = initExcelFilters;

  // Bot√≥n global ‚ÄúLimpiar filtros (Excel)‚Äù
  const btnClear = document.getElementById('btnExcelClearAll');
  if(btnClear){
    btnClear.addEventListener('click', (e)=>{
      e.preventDefault();
      excelClearAll();
    });
  }

  // Inicial
  initExcelFilters();
})();
</script>
<script>
(function(){
  function bindHistorialControls(){
    const zone = document.getElementById('cartolaZone');
    if(!zone) return;

    const btn = document.getElementById('btnEnviarHistorial');
    const all = zone.querySelector('#chkAllHistorial');

    function getRowChecks(){
      return Array.from(zone.querySelectorAll('.chkHistorial'));
    }

    function isRowVisible(chk){
      const tr = chk.closest('tr');
      if(!tr) return true;
      return tr.style.display !== 'none';
    }

    function updateBtn(){
      if(!btn) return;
      const any = getRowChecks().some(c => c.checked && isRowVisible(c));
      btn.disabled = !any;
      btn.className = any
        ? 'bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-full text-sm shadow'
        : 'bg-gray-300 text-white px-4 py-2 rounded-full text-sm shadow cursor-not-allowed';
    }

    // ‚úÖ evitar doble bind PERO POR ZONE (no por btn)
    if(zone.__histBound) {
      updateBtn();
      return;
    }
    zone.__histBound = true;

    if(all){
      all.addEventListener('change', ()=>{
        const checks = getRowChecks();
        checks.forEach(c => {
          if(isRowVisible(c)) c.checked = all.checked;
        });
        updateBtn();
      });
    }

    zone.addEventListener('change', (e)=>{
      if(e.target && e.target.classList.contains('chkHistorial')){
        updateBtn();

        // sincroniza "select all" si corresponde (solo visibles)
        if(all){
          const visibles = getRowChecks().filter(isRowVisible);
          const allOn = visibles.length && visibles.every(c => c.checked);
          all.checked = !!allOn;
        }
      }
    });

    if(btn && !btn.__histClickBound){
      btn.__histClickBound = true;

      btn.addEventListener('click', async ()=>{
        const ids = getRowChecks()
          .filter(c => c.checked && isRowVisible(c))
          .map(c => c.value);

        if(!ids.length) return;

        btn.disabled = true;
        const original = btn.textContent;
        btn.textContent = 'Enviando...';

        const fd = new FormData();
        fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        ids.forEach(id => fd.append('ids[]', id));

        try{
          const resp = await fetch("{% url 'facturacion:enviar_a_historial' %}", {
            method: "POST",
            body: fd,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });

          const data = await resp.json().catch(()=> ({}));

          if (!resp.ok || !data.ok) {
            const code = (data && data.code) ? String(data.code) : "";
            const raw = (data && (data.error || data.detail)) ? String(data.error || data.detail) : "";

            if (code === "NO_APROBADO_FINANZAS") {
              openNiceModal({
                title: "No se puede enviar al historial",
                message: "No se puede enviar al historial porque el/los movimiento(s) seleccionado(s) a√∫n no est√°n Aprobados por Finanzas.",
                type: "warning"
              });
              btn.textContent = original;
              updateBtn();
              return;
            }

            openNiceModal({
              title: "No se pudo enviar",
              message: raw || "No se pudo enviar al historial. Int√©ntalo nuevamente.",
              type: "error"
            });

            btn.textContent = original;
            updateBtn();
            return;
          }

          // refresca tabla
          if(window.refreshCartolaList){
            await window.refreshCartolaList({ page: 1 });
          }else{
            location.reload();
          }

        }catch(err){
          console.error(err);
          openNiceModal({
            title: "Error de red",
            message: "No se pudo enviar a historial. Revisa tu conexi√≥n e int√©ntalo de nuevo.",
            type: "error"
          });
        }finally{
          btn.textContent = btn.textContent === 'Enviando...' ? 'üì¶ Enviar a Historial' : btn.textContent;
          updateBtn();
        }
      });
    }

    updateBtn();
  }

  document.addEventListener('DOMContentLoaded', bindHistorialControls);
  window.bindHistorialControls = bindHistorialControls;
})();
</script>

<script>
  function openNiceModal({ title="Mensaje", message="", type="info" } = {}) {
    const modal = document.getElementById('modalNice');
    const titleEl = document.getElementById('modalNiceTitle');
    const msgEl = document.getElementById('modalNiceMsg');
    const bar = document.getElementById('modalNiceBar');
    const iconWrap = document.getElementById('modalNiceIcon');
    const iconChar = document.getElementById('modalNiceIconChar');

    titleEl.textContent = title;
    msgEl.textContent = message;

    // estilos por tipo
    const map = {
      info:   { bar:'bg-blue-600',  wrap:'bg-blue-50 text-blue-700',  icon:'‚ÑπÔ∏è' },
      success:{ bar:'bg-green-600', wrap:'bg-green-50 text-green-700', icon:'‚úÖ' },
      warning:{ bar:'bg-yellow-500',wrap:'bg-yellow-50 text-yellow-800',icon:'‚ö†Ô∏è' },
      error:  { bar:'bg-red-600',   wrap:'bg-red-50 text-red-700',    icon:'‚ùå' },
    };
    const s = map[type] || map.info;

    bar.className = 'h-1.5 ' + s.bar;
    iconWrap.className = 'flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center ' + s.wrap;
    iconChar.textContent = s.icon;

    modal.classList.remove('hidden');
    modal.classList.add('flex');

    // cerrar con ESC
    modal.__escHandler = (e) => {
      if (e.key === 'Escape') closeNiceModal();
    };
    document.addEventListener('keydown', modal.__escHandler);

    // cerrar al click afuera
    modal.__clickHandler = (e) => {
      if (e.target === modal || e.target.classList.contains('bg-black/50')) closeNiceModal();
    };
    modal.addEventListener('click', modal.__clickHandler);
  }

  function closeNiceModal() {
    const modal = document.getElementById('modalNice');
    if (!modal) return;
    modal.classList.add('hidden');
    modal.classList.remove('flex');

    if (modal.__escHandler) document.removeEventListener('keydown', modal.__escHandler);
    modal.__escHandler = null;

    if (modal.__clickHandler) modal.removeEventListener('click', modal.__clickHandler);
    modal.__clickHandler = null;
  }
</script>
</div>
{% endblock %}