{% extends "dashboard_admin/base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Cartola de Movimientos{% endblock %}

{% block dashboard_content %}
<div class="bg-white shadow mt-3 -mx-3 sm:mx-0 rounded-none sm:rounded-2xl px-3 py-4 sm:p-6">
<style>
  .campo-filtro {
    border: 2px solid #1f2937;
    padding: 0.25rem 0.75rem;
    border-radius: 0.75rem;
    font-size: 0.875rem;
    height: 2.25rem;
    width: 100%;
    background-color: white;
    transition: border-color 0.2s ease-in-out;
  }
  .campo-filtro:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
    outline: none;
  }
  .tabla-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  table {
    white-space: nowrap;
    min-width: 1200px;
  }
</style>

<!-- T√≠tulo y botones -->
<div class="flex flex-col sm:flex-row justify-start items-start sm:items-center mb-4 gap-2">
  <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">üìë Cartola de Movimientos</h2>
  <div class="flex gap-2">
    <a href="{% url 'facturacion:crear_tipo' %}"
       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
      + Crear Tipo
    </a>
    <a href="{% url 'facturacion:crear_proyecto' %}"
       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
      + Crear Proyecto
    </a>
    <a href="{% url 'facturacion:registrar_abono' %}"
       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full text-sm shadow">
      + Registrar Abono
    </a>
    <a href="{% url 'facturacion:exportar_cartola_finanzas' %}"
       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm shadow">
      üì• Export to Excel
    </a>
  </div>
</div>

<!-- Filtros -->
<form id="form-filtros"
      method="get"
      class="mb-3 text-base">

  <div class="inline-flex flex-wrap items-end gap-3 bg-gray-50 border border-gray-200 rounded-xl px-3 py-2">

    <div class="w-full sm:w-56">
      <label class="text-xs text-gray-600">Usuario</label>
      <input type="text"
             name="usuario"
             value="{{ filtros.usuario }}"
             placeholder="Filtrar Usuario"
             class="border rounded-lg px-3 py-2 w-full"
             autocomplete="off">
    </div>

    <div class="w-full sm:w-44">
      <label class="text-xs text-gray-600">Fecha</label>
      <input type="text"
             name="fecha"
             value="{{ filtros.fecha }}"
             placeholder="DD-MM-YYYY"
             class="border rounded-lg px-3 py-2 w-full"
             autocomplete="off">
    </div>

    <div class="w-full sm:w-56">
      <label class="text-xs text-gray-600">Proyecto</label>
      <input type="text"
             name="proyecto"
             value="{{ filtros.proyecto }}"
             placeholder="Filtrar por Proyecto"
             class="border rounded-lg px-3 py-2 w-full"
             autocomplete="off">
    </div>

    <div class="w-full sm:w-56">
      <label class="text-xs text-gray-600">Categor√≠a</label>
      <input type="text"
             name="categoria"
             value="{{ filtros.categoria }}"
             placeholder="Filtrar por Categoria"
             class="border rounded-lg px-3 py-2 w-full"
             autocomplete="off">
    </div>

    <div class="w-full sm:w-48">
      <label class="text-xs text-gray-600">Tipo</label>
      <input type="text"
             name="tipo"
             value="{{ filtros.tipo }}"
             placeholder="Filtrar por Tipo"
             class="border rounded-lg px-3 py-2 w-full"
             autocomplete="off">
    </div>

    <div class="w-full sm:w-56">
      <label class="text-xs text-gray-600">Estado</label>
      <select name="estado"
              class="border rounded-lg px-3 py-2 w-full">
        <option value="">Todos los estados</option>
        {% for codigo, nombre in estado_choices %}
          <option value="{{ codigo }}" {% if filtros.estado == codigo %}selected{% endif %}>
            {{ nombre }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="w-full sm:w-auto flex items-center gap-2 mt-2 sm:mt-0">
      <a href="{% url 'facturacion:listar_cartola' %}"
         class="bg-red-100 hover:bg-red-200 text-red-600 text-sm font-medium px-4 py-2 rounded-lg shadow whitespace-nowrap">
        ‚ùå Limpiar
      </a>
    </div>

    <!-- Mantener cantidad actual -->
    <input type="hidden" name="cantidad" value="{{ cantidad }}">
  </div>
</form>

<!-- Selector de columnas -->
<div class="flex justify-start mb-2">
  <details class="relative">
    <summary class="cursor-pointer text-sm text-gray-700 px-3 py-1 border rounded-full bg-gray-50 hover:bg-gray-100 select-none">
      ‚öôÔ∏è Columns
    </summary>

    <div id="columnToggles" class="absolute left-0 mt-1 w-64 bg-white border rounded-xl shadow-lg p-3 z-10">
      <p class="text-xs text-gray-500 mb-2">Show / hide columns</p>

      <!-- Master checkbox -->
      <label class="flex items-center gap-2 mb-2 pb-2 border-b">
        <input type="checkbox" id="col-toggle-all" checked>
        <span class="font-semibold text-xs">Show all columns</span>
      </label>

      <div class="space-y-1 text-sm">
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="0" checked>
          <span>Usuario</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="1" checked>
          <span>Fecha</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="2" checked>
          <span>Proyecto</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="3" checked>
          <span>Categor√≠a</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="4" checked>
          <span>Tipo</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="5" checked>
          <span>RUT Factura</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="6" checked>
          <span>Tipo de Documento</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="7" checked>
          <span>N¬∞ Documento</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="8" checked>
          <span>Observaciones</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="9" checked>
          <span>N¬∞ Transferencia</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="10" checked>
          <span>Comprobante</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="11" checked>
          <span>Cargos</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="12" checked>
          <span>Abonos</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="13" checked>
          <span>Status</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="14" checked>
          <span>Acciones</span>
        </label>
      </div>
    </div>
  </details>
</div>

<div id="cartolaZone">
  <!-- Tabla responsive -->
  <div class="tabla-responsive overflow-x-auto">
    <table class="table-auto w-full text-sm min-w-full sm:min-w-[1200px]"
           style="white-space: nowrap;"
           data-columns-table="gz-cartola">
      <thead class="bg-gray-100 text-gray-800 font-semibold text-center">
        <tr>
          <th class="p-2 border">Usuario</th>
          <th class="p-2 border">Fecha</th>
          <th class="p-2 border">Proyecto</th>
          <th class="p-2 border">Categor√≠a</th>
          <th class="p-2 border">Tipo</th>
          <th class="p-2 border">RUT Factura</th>
          <th class="p-2 border">Tipo de Documento</th>
          <th class="p-2 border">N√∫mero de Documento</th>
          <th class="p-2 border">Observaciones</th>
          <th class="p-2 border">N¬∞ Transferencia</th>
          <th class="p-2 border">Comprobante</th>
          <th class="p-2 border">Cargos</th>
          <th class="p-2 border">Abonos</th>
          <th class="p-2 border">Status</th>
          <th class="p-2 border">Acciones</th>
        </tr>
      </thead>

      <tbody class="text-center">
        {% for mov in pagina %}
        <tr class="border-t">
          <td class="p-2 border">{{ mov.usuario }}</td>
          <td class="p-2 border">{{ mov.fecha|date:"d-m-Y" }}</td>
          <td class="p-2 border">{{ mov.proyecto }}</td>
          <td class="p-2 border">{{ mov.tipo.categoria|title }}</td>
          <td class="p-2 border">{{ mov.tipo }}</td>
          <td class="p-2 border">{{ mov.rut_factura|default:"‚Äî" }}</td>
          <td class="p-2 border">{{ mov.tipo_doc|default:"‚Äî" }}</td>
          <td class="p-2 border">{{ mov.numero_doc|default:"‚Äî" }}</td>
          <td class="p-2 border">{{ mov.observaciones }}</td>
          <td class="p-2 border">{{ mov.numero_transferencia|default:"‚Äî" }}</td>
          <td class="p-2 border">
            {% if mov.comprobante %}
              <a href="{{ mov.comprobante.url }}" target="_blank" class="text-blue-600 underline">Ver</a>
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          <td class="p-2 border text-right">{{ mov.cargos|default:0|formato_clp }}</td>
          <td class="p-2 border text-right">{{ mov.abonos|default:0|formato_clp }}</td>

          <!-- Status -->
          <td class="p-2 text-sm">
            <div class="flex flex-col gap-1 text-left leading-tight">
              {% if mov.status == 'pendiente_supervisor' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                  ‚è≥ Pendiente aprobaci√≥n del Supervisor
                </span>
              {% elif mov.status == 'aprobado_supervisor' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                  ‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br>
                  ‚è≥ Pendiente aprobaci√≥n del PM
                </span>
              {% elif mov.status == 'rechazado_supervisor' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                  ‚ùå Rechazado por Supervisor
                </span>
              {% elif mov.status == 'aprobado_pm' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                  ‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br>
                  ‚úÖ PM: {{ mov.aprobado_por_pm.get_full_name }} <br>
                  ‚è≥ Pendiente aprobaci√≥n de Finanzas
                </span>
              {% elif mov.status == 'rechazado_pm' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                  ‚ùå Rechazado por PM
                </span>
              {% elif mov.status == 'aprobado_finanzas' %}
                <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">
                  ‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br>
                  ‚úÖ PM: {{ mov.aprobado_por_pm.get_full_name }} <br>
                  ‚úÖ Finanzas: {{ mov.aprobado_por_finanzas.get_full_name }}
                </span>
              {% elif mov.status == 'rechazado_finanzas' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                  ‚ùå Rechazado por Finanzas
                </span>
              {% elif mov.status == 'pendiente_abono_usuario' %}
                <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                  ‚è≥ Pendiente aprobaci√≥n del Usuario
                </span>
              {% elif mov.status == 'aprobado_abono_usuario' %}
                <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">
                  ‚úÖ Abono aprobado por Usuario
                </span>
              {% elif mov.status == 'rechazado_abono_usuario' %}
                <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                  ‚ùå Abono rechazado por Usuario
                </span>
              {% else %}
                {{ mov.get_status_display }}
              {% endif %}

              {% if 'rechazado' in mov.status and mov.motivo_rechazo %}
                <div class="mt-1 text-xs text-red-700 whitespace-pre-wrap break-words editable-motivo"
                     style="word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; max-width: 100%;">
                  <strong>Motivo:</strong> <span class="motivo-text">{{ mov.motivo_rechazo }}</span>
                </div>
              {% endif %}
            </div>
          </td>

          <!-- Acciones -->
          <td class="p-2 border">
            {# SUPERUSUARIO #}
            {% if user.is_superuser %}
              <a href="{% url 'facturacion:editar_movimiento' mov.id %}?next={{ request.get_full_path|urlencode }}"
                 class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-blue-200 transition">
                ‚úèÔ∏è Editar
              </a>
              <a href="{% url 'facturacion:eliminar_movimiento' mov.id %}?next={{ request.get_full_path|urlencode }}"
                 class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">
                üóëÔ∏è Eliminar
              </a>

              {% if mov.tipo.categoria != "abono" %}
                {% if mov.status == 'pendiente_supervisor' or mov.status == 'aprobado_supervisor' or mov.status == 'aprobado_pm' %}
                  <a href="#"
                     class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
                     data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">
                    ‚úÖ Aprobar gasto
                  </a>
                  <a href="#" onclick="return abrirModalRechazo({{ mov.id }});"
                     class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">
                    ‚ùå Rechazar gasto
                  </a>
                {% endif %}
              {% endif %}
            {% endif %}

            {# NO SUPERUSUARIO (gastos, no abonos) #}
            {% if not user.is_superuser and mov.tipo.categoria != "abono" %}

              {# Supervisor #}
              {% if user.es_supervisor and mov.status == "pendiente_supervisor" %}
                <a href="#"
                   class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
                   data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">
                  ‚úÖ Aprobar gasto
                </a>
                <a href="#" onclick="return abrirModalRechazo({{ mov.id }});"
                   class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">
                  ‚ùå Rechazar gasto
                </a>
              {% endif %}

              {# PM #}
              {% if user.es_pm and mov.status == "aprobado_supervisor" %}
                <a href="#"
                   class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
                   data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">
                  ‚úÖ Aprobar gasto
                </a>
                <a href="#" onclick="return abrirModalRechazo({{ mov.id }});"
                   class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">
                  ‚ùå Rechazar gasto
                </a>
              {% endif %}

              {# Finanzas #}
              {% if user.es_facturacion and mov.status == "aprobado_pm" %}
                <a href="#"
                   class="js-approve inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200 transition"
                   data-url="{% url 'facturacion:aprobar_movimiento' mov.id %}">
                  ‚úÖ Aprobar gasto
                </a>
                <a href="#" onclick="return abrirModalRechazo({{ mov.id }});"
                   class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200 transition">
                  ‚ùå Rechazar gasto
                </a>
              {% endif %}

            {% endif %}
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="15" class="p-4 text-center">No hay movimientos registrados.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  

    <!-- Selector de cantidad -->
    <form method="get" class="flex items-center gap-2">
      <label for="cantidad" class="text-sm font-medium text-gray-700">Mostrar:</label>
      <select name="cantidad" id="cantidad" onchange="this.form.submit()" class="border rounded-lg px-3 py-1">
        <option value="5"   {% if cantidad == '5' %}selected{% endif %}>5</option>
        <option value="10"  {% if cantidad == '10' %}selected{% endif %}>10</option>
        <option value="20"  {% if cantidad == '20' %}selected{% endif %}>20</option>
        <option value="50"  {% if cantidad == '50' %}selected{% endif %}>50</option>
        <option value="100" {% if cantidad == '100' %}selected{% endif %}>100</option>
      </select>

      <!-- Preservar filtros actuales -->
      <input type="hidden" name="usuario"     value="{{ filtros.usuario }}">
      <input type="hidden" name="fecha"       value="{{ filtros.fecha }}">
      <input type="hidden" name="proyecto"    value="{{ filtros.proyecto }}">
      <input type="hidden" name="categoria"   value="{{ filtros.categoria }}">
      <input type="hidden" name="tipo"        value="{{ filtros.tipo }}">
      <input type="hidden" name="rut_factura" value="{{ filtros.rut_factura }}">
      <input type="hidden" name="estado"      value="{{ filtros.estado }}">
    </form>

   <!-- Paginaci√≥n -->
<div class="mt-4 flex justify-center gap-2 text-sm">
  {% if pagina.has_previous %}
    <a href="?page=1&cantidad={{ cantidad }}&id_claro={{ id_claro }}&id_new={{ id_new }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">¬´ Primero</a>
    <a href="?page={{ pagina.previous_page_number }}&cantidad={{ cantidad }}&id_claro={{ id_claro }}&id_new={{ id_new }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">‚Äπ Anterior</a>
  {% endif %}
  <span class="px-3 py-1">P√°gina {{ pagina.number }} de {{ pagina.paginator.num_pages }}</span>
  {% if pagina.has_next %}
    <a href="?page={{ pagina.next_page_number }}&cantidad={{ cantidad }}&id_claro={{ id_claro }}&id_new={{ id_new }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Siguiente ‚Ä∫</a>
    <a href="?page={{ pagina.paginator.num_pages }}&cantidad={{ cantidad }}&id_claro={{ id_claro }}&id_new={{ id_new }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">√öltimo ¬ª</a>
  {% endif %}
</div>

  

<!-- Modal de rechazo -->
<div id="modalRechazo" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6">
    <h2 class="text-lg font-bold text-gray-800 mb-4">Motivo del Rechazo</h2>
    <form id="formRechazo" method="POST" action="">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.get_full_path }}">
      <textarea name="motivo_rechazo" rows="4" required
                class="w-full border rounded-lg p-2 mb-4"
                placeholder="Escribe el motivo del rechazo"></textarea>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="cerrarModalRechazo()"
                class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Rechazar</button>
      </div>
    </form>
  </div>
</div>

<script>
  function abrirModalRechazo(id) {
    const modal = document.getElementById('modalRechazo');
    const form  = document.getElementById('formRechazo');

    form.action = `/facturacion/cartola/rechazar/${id}/`;
    // Alternativa con URL nombrada:
    // form.action = `{% url 'facturacion:rechazar_movimiento' 0 %}`.replace('/0/', `/${id}/`);

    const nextInput = form.querySelector('input[name="next"]');
    if (nextInput) {
      nextInput.value = location.pathname + location.search;
    }

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    return false;
  }

  function cerrarModalRechazo() {
    const modal = document.getElementById('modalRechazo');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }
</script>

<!-- Filtros + paginaci√≥n por AJAX (tipo Hyperlink) -->
<script>
(function () {
  const form = document.getElementById('form-filtros');
  let zone = document.getElementById('cartolaZone');
  if (!form || !zone) return;

  function qsFromForm() {
    const fd = new FormData(form);
    const params = new URLSearchParams(fd);

    // Eliminar par√°metros vac√≠os
    form.querySelectorAll('input[type="text"], select').forEach(el => {
      const v = (el.value || '').trim();
      if (v === '') params.delete(el.name);
    });
    return params;
  }

  async function refreshList(extraParams = {}) {
    // guardar foco y caret
    const active = document.activeElement;
    const activeName = active && active.name;
    const caretPos = (active && active.selectionStart) ?? null;

    const params = qsFromForm();
    Object.entries(extraParams).forEach(([k, v]) => params.set(k, v));

    const url = `${location.pathname}?${params.toString()}`;
    const res = await fetch(url, { headers: { 'X-Requested-With': 'fetch' }});
    const html = await res.text();

    const doc = new DOMParser().parseFromString(html, 'text/html');
    const newZone = doc.querySelector('#cartolaZone');
    if (!newZone) { location.href = url; return; }

    zone.replaceWith(newZone);
    zone = document.getElementById('cartolaZone');
    wirePagination(zone);

    // re-aplicar columnas si est√° disponible
    if (window.reApplyCartolaColumns) {
      window.reApplyCartolaColumns();
    }
    // re-enganchar aprobar si est√° disponible
    if (window.engancharAprobarCartola) {
      window.engancharAprobarCartola();
    }

    // restaurar foco/caret
    if (activeName) {
      const again = form.querySelector(`[name="${activeName}"]`);
      if (again) {
        again.focus();
        if (caretPos !== null && again.setSelectionRange) {
          const end = again.value.length;
          const pos = Math.min(caretPos, end);
          again.setSelectionRange(pos, pos);
        }
      }
    }

    // actualizar URL
    history.replaceState(null, '', url);
  }

  function wirePagination(scope) {
    (scope || document).querySelectorAll('a[href*="page="]').forEach(a => {
      a.addEventListener('click', (ev) => {
        ev.preventDefault();
        const u = new URL(a.href, location.href);
        const page = u.searchParams.get('page') || '1';
        refreshList({ page });
      });
    });
  }
  wirePagination(zone);

  // Debounce
  let t;
  const debouncedRefresh = (extra = {}) => {
    clearTimeout(t);
    t = setTimeout(() => refreshList({ page: 1, ...extra }), 300);
  };

  // Autofiltrado
  form.addEventListener('input', (e) => {
    if (e.target.matches('input[type="text"], select')) debouncedRefresh();
  });
  form.addEventListener('change', (e) => {
    if (e.target.matches('input[type="text"], select')) debouncedRefresh();
  });
  form.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.target.matches('input[type="text"]')) {
      e.preventDefault();
      refreshList({ page: 1 });
    }
  });

  // Exponer refreshList por si lo quieres desde otros scripts
  window.refreshCartolaList = refreshList;
})();
</script>

<!-- Mantener scroll horizontal -->
<script>
/* ====== Mantener scroll horizontal en Cartola (GZ Services) ====== */
(function () {
  const KEY = 'gz-cartola-scrollX:' + location.pathname;

  function getBox() {
    return document.querySelector('#cartolaZone .tabla-responsive');
  }

  function saveX(x){
    try { sessionStorage.setItem(KEY, String(x)); } catch(_) {}
  }
  function readX(){
    try { return Number(sessionStorage.getItem(KEY) || 0); } catch(_) { return 0; }
  }

  function attachSaver(box){
    if (!box || box.__hasScrollSaver) return;
    box.__hasScrollSaver = true;
    let t = null;
    box.addEventListener('scroll', () => {
      if (t) return;
      t = setTimeout(() => { t = null; saveX(box.scrollLeft); }, 120);
    }, { passive: true });
  }

  function restoreNow(){
    const box = getBox();
    if (!box) return;
    requestAnimationFrame(() => {
      box.scrollLeft = readX();
    });
    attachSaver(box);
  }

  // 1) Al cargar
  document.addEventListener('DOMContentLoaded', restoreNow);

  // 2) Si #cartolaZone se reemplaza por AJAX, volver a aplicar
  const zone = document.getElementById('cartolaZone');
  if (zone) {
    const mo = new MutationObserver((muts) => {
      for (const m of muts) {
        if (m.type === 'childList' && (m.addedNodes.length || m.removedNodes.length)) {
          setTimeout(restoreNow, 0);
          break;
        }
      }
    });
    mo.observe(zone.parentNode || zone, { childList: true, subtree: true });
  }

  // 3) Antes de salir/recargar
  window.addEventListener('beforeunload', () => {
    const box = getBox();
    if (box) saveX(box.scrollLeft);
  });
})();
</script>

<!-- Gesti√≥n de columnas con localStorage -->
<script>
(function () {
  const panel = document.getElementById('columnToggles');
  if (!panel) return;

  function getTable() {
    return document.querySelector('[data-columns-table]') ||
           document.querySelector('#cartolaZone table') ||
           document.querySelector('table');
  }

  const firstTable = getTable();
  const tableId = (firstTable && firstTable.dataset.columnsTable) || location.pathname;
  const STORAGE_KEY = 'cols:' + tableId;

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return {};
      const obj = JSON.parse(raw);
      return obj && typeof obj === 'object' ? obj : {};
    } catch (e) {
      return {};
    }
  }

  function saveState(state) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {}
  }

  function applyVisibility() {
    const table = getTable();
    if (!table) return;

    const state = loadState();

    const theadCells = table.querySelectorAll('thead tr th');
    theadCells.forEach((th, idx) => {
      const visible = state[idx] !== false;
      th.style.display = visible ? '' : 'none';
    });

    table.querySelectorAll('tbody tr').forEach((tr) => {
      const tds = tr.querySelectorAll('td');
      tds.forEach((td, idx) => {
        const visible = state[idx] !== false;
        td.style.display = visible ? '' : 'none';
      });
    });

    const checks = panel.querySelectorAll('.col-toggle');
    const master = panel.querySelector('#col-toggle-all');
    let allOn = true;

    checks.forEach((cb) => {
      const idx = parseInt(cb.dataset.col || '0', 10);
      const visible = state[idx] !== false;
      cb.checked = visible;
      if (!visible) allOn = false;
    });

    if (master) {
      master.checked = allOn;
    }
  }

  function bindToggles() {
    const checks = panel.querySelectorAll('.col-toggle');
    const master = panel.querySelector('#col-toggle-all');

    checks.forEach((cb) => {
      cb.addEventListener('change', () => {
        const idx = parseInt(cb.dataset.col || '0', 10);
        const state = loadState();
        state[idx] = cb.checked;
        saveState(state);
        applyVisibility();
      });
    });

    if (master) {
      master.addEventListener('change', () => {
        const val = master.checked;
        const state = loadState();

        checks.forEach((cb) => {
          const idx = parseInt(cb.dataset.col || '0', 10);
          cb.checked = val;
          state[idx] = val;
        });

        saveState(state);
        applyVisibility();
      });
    }
  }

  function bindOutsideClickToClose() {
    const details = panel.closest('details');
    if (!details) return;

    document.addEventListener('click', (e) => {
      if (!details.open) return;
      if (details.contains(e.target)) return;
      details.open = false;
    });
  }

  bindToggles();
  applyVisibility();
  bindOutsideClickToClose();

  // Exponer para re-aplicar despu√©s de AJAX
  window.reApplyCartolaColumns = applyVisibility;
})();
</script>

<!-- Aprobar por AJAX (igual que Hyperlink) -->
<script>
(function () {
  function engancharAprobarCartola() {
    document.querySelectorAll('.js-approve').forEach(btn => {
      if (btn.__hasApproveHandler) return;
      btn.__hasApproveHandler = true;

      btn.addEventListener('click', async (e) => {
        e.preventDefault();

        const url = btn.dataset.url;
        const row = btn.closest('tr');
        if (!url || !row) return;

        if (btn.dataset.loading === '1') return;
        btn.dataset.loading = '1';

        const originalText = btn.textContent;
        btn.textContent    = 'Aprobando...';

        try {
          const fd = new FormData();
          fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');

          const resp = await fetch(url, {
            method: 'POST',
            body: fd,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
            },
          });

          let data = {};
          try {
            data = await resp.json();
          } catch (_) {}

          if (!resp.ok || !data.ok) {
            const msg = (data && data.error) || 'No se pudo aprobar el movimiento.';
            alert(msg);
            btn.textContent     = originalText;
            btn.dataset.loading = '';
            return;
          }

          row.style.transition = 'opacity 0.2s ease';
          row.style.opacity    = '0.4';
          setTimeout(() => {
            row.remove();
          }, 200);

        } catch (err) {
          console.error(err);
          alert('Error de red al aprobar el movimiento.');
          btn.textContent     = originalText;
          btn.dataset.loading = '';
        }
      });
    });
  }

  document.addEventListener('DOMContentLoaded', engancharAprobarCartola);
  window.engancharAprobarCartola = engancharAprobarCartola;
})();
</script>

</div>
{% endblock %}