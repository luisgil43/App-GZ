{% extends 'dashboard_admin/base.html' %}
{% block title %}Previsualizar OC{% endblock %}

{% block dashboard_content %}
<div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow mt-6">
  <h2 class="text-xl font-bold mb-4">üìÑ Previsualizaci√≥n de Datos Extra√≠dos</h2>

  {% if datos and datos|length > 0 %}
    <form method="post" action="{% url 'facturacion:guardar_ordenes_compra' %}">
      {% csrf_token %}

      <div class="overflow-x-auto">
        <table class="min-w-full border text-sm text-left">
          <thead class="bg-gray-100 font-semibold">
            <tr>
              <th class="border px-2 py-1">OC</th>
              <th class="border px-2 py-1">POS</th>
              <th class="border px-2 py-1">Cant</th>
              <th class="border px-2 py-1">UM</th>
              <th class="border px-2 py-1">Material</th>
              <th class="border px-2 py-1">Descripci√≥n / Sitio</th>
              <th class="border px-2 py-1">Fecha Entrega</th>
              <th class="border px-2 py-1">P. Unitario</th>
              <th class="border px-2 py-1">Monto</th>
              <th class="border px-2 py-1">ID NEW</th>
              <th class="border px-2 py-1">Asociar a DU</th>
            </tr>
          </thead>
          <tbody>
            {% for fila in datos %}
              {% with candidatos=fila.candidatos %}
              <tr class="border-b hover:bg-gray-50
                         {% if fila.id_new in ids_no_encontrados %}bg-red-100 text-red-800{% endif %}">
                <td class="border px-2 py-1">{{ fila.orden_compra }}</td>
                <td class="border px-2 py-1">{{ fila.pos }}</td>
                <td class="border px-2 py-1">{{ fila.cantidad }}</td>
                <td class="border px-2 py-1">{{ fila.unidad_medida }}</td>
                <td class="border px-2 py-1">{{ fila.material_servicio }}</td>
                <td class="border px-2 py-1">{{ fila.descripcion_sitio }}</td>
                <td class="border px-2 py-1">{{ fila.fecha_entrega }}</td>
                <td class="border px-2 py-1">{{ fila.precio_unitario }}</td>
                <td class="border px-2 py-1">{{ fila.monto }}</td>
                <td class="border px-2 py-1 font-semibold">{{ fila.id_new }}</td>

                <td class="border px-2 py-1">
                  {% if candidatos|length == 0 %}
                    <span class="text-xs text-red-700">Sin servicio</span>
                  {% elif candidatos|length == 1 %}
                    <span class="text-xs">{{ candidatos.0.label }}</span>
                    <input type="hidden" name="target_du_{{ fila.idx }}" value="{{ candidatos.0.id }}">
                  {% else %}
                    <select name="target_du_{{ fila.idx }}" class="border rounded px-2 py-1 text-xs">
                      <option value="">‚Äî Selecciona DU ‚Äî</option>
                      {% for c in candidatos %}
                        <option value="{{ c.id }}"
                                {% if fila.selected_id and fila.selected_id == c.id %}selected{% endif %}>
                          {{ c.label }}
                        </option>
                      {% endfor %}
                    </select>
                  {% endif %}
                </td>
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-6 flex gap-3">
        <a href="{% url 'facturacion:importar_orden_compra' %}"
           class="bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">
          ‚Üê Volver
        </a>
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
          Confirmar y Guardar
        </button>
      </div>
    </form>
  {% else %}
    <p class="text-red-500">‚ùå No se encontraron datos v√°lidos.</p>
    <a href="{% url 'facturacion:importar_orden_compra' %}"
       class="inline-block mt-4 bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">
      ‚Üê Volver
    </a>
  {% endif %}
</div>
{% endblock %}
