{% extends "dashboard/base.html" %}
{% load l10n %}
{% block title %}Subir Evidencias ‚Äî DU{{ servicio.du }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto bg-white p-6 rounded-2xl shadow mt-6">

<div class="flex items-center justify-between gap-3">
  <div class="flex items-center gap-2">
    <a href="{% url 'operaciones:mis_servicios_tecnico' %}"
       class="inline-flex items-center bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 rounded-md">
      ‚¨ÖÔ∏è Volver
    </a>

    <div>
      <h1 class="text-xl sm:text-2xl font-bold leading-tight">
        üì∏ Subir Evidencias ‚Äî DU{{ servicio.du }}
      </h1>
      <div class="text-sm text-gray-600">
        {{ servicio.id_claro }} ¬∑ {{ servicio.id_new }} ¬∑ {{ servicio.region }}
      </div>
    </div>
  </div>

  <form id="finalizar-form" method="post" action="{% url 'operaciones:finalizar_servicio' servicio.id %}">
    {% csrf_token %}
    <button id="btn-finalizar" type="submit"
            {% if not can_finish %}disabled{% endif %}
            class="{% if can_finish %}inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md{% else %}inline-flex items-center gap-2 bg-indigo-300 text-white px-4 py-2 rounded-md cursor-not-allowed{% endif %}"
            {% if not can_finish %}title="Debes subir todas las fotos requeridas y que todos acepten la asignaci√≥n."{% endif %}>
      üèÅ Finalizar
    </button>
  </form>
</div>


   {% if pendientes_aceptar %}
  <div class="mt-3 p-3 rounded bg-yellow-50 text-yellow-800 text-sm">
    A√∫n faltan t√©cnicos por aceptar: {{ pendientes_aceptar|join:", " }}.
  </div>
{% endif %}

<div id="faltantes-banner"
     class="mt-3 p-3 rounded bg-yellow-50 text-yellow-800 text-sm {% if not faltantes_global %}hidden{% endif %}">
  {% if faltantes_global %}Faltan fotos requeridas: {{ faltantes_global|join:", " }}.{% endif %}
</div>



  <div class="grid md:grid-cols-2 gap-6 mt-4">
    <div>
      <h2 class="font-semibold mb-2">Requisitos</h2>
      <ul class="space-y-2">
        {% for r in requisitos %}
<li class="border rounded p-3">
  <div class="flex items-center justify-between">
    <div class="font-medium">
      {{ r.orden }}. {{ r.titulo }} {% if r.obligatorio %}<span class="text-red-600">*</span>{% endif %}

      {% if r.id in locked_ids and r.uploaded|default:0 == 0 %}
        <span class="ml-2 text-xs px-2 py-0.5 rounded bg-gray-200 text-gray-700">Tomado</span>
      {% else %}
       <span
  class="ml-2 text-xs px-2 py-0.5 rounded req-badge
         {% if r.uploaded > 0 or r.completed_global %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}"
  data-req="{{ r.id }}"
  data-state="{% if r.uploaded > 0 or r.completed_global %}done{% else %}pending{% endif %}">
  {% if r.uploaded > 0 or r.completed_global %}Completado{% else %}Pendiente{% endif %}
</span>
      {% endif %}
    </div>

    <div class="text-xs text-gray-500 req-count" data-req="{{ r.id }}">
      {{ r.uploaded }} subidas (t√∫)
    </div>
  </div>

  {% if r.descripcion %}
    <div class="text-sm text-gray-600">{{ r.descripcion }}</div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="mt-2 geo-upload-form ajax-uploader">
    {% csrf_token %}
    <input type="hidden" name="req_id" value="{{ r.id }}">

    <!-- HIDDEN META -->
    <input type="hidden" name="lat">
    <input type="hidden" name="lng">
    <input type="hidden" name="acc">
    <input type="hidden" name="client_taken_at">

    <div class="flex items-center gap-2">
      <!-- GALLERY -->
      <input id="file-gallery-{{ r.id }}" type="file" name="imagenes[]" accept="image/*" multiple
             class="sr-only file-input" {% if r.id in locked_ids or r.uploaded > 0 or r.completed_global %}disabled{% endif %}>
      <label for="file-gallery-{{ r.id }}"
             class="px-3 py-2 rounded text-sm cursor-pointer
                    {% if r.id in locked_ids or r.uploaded > 0 or r.completed_global %}bg-gray-100 text-gray-400 cursor-not-allowed opacity-60 pointer-events-none{% else %}bg-gray-100 hover:bg-gray-200{% endif %}">
        üìÅ Elegir archivos
      </label>
      <span class="text-xs text-gray-600 filename" data-empty="Sin archivos">
        {% if r.id in locked_ids or r.uploaded > 0 or r.completed_global %}Cerrado{% else %}Sin archivos{% endif %}
      </span>

      <!-- CAMERA -->
      <input id="file-camera-{{ r.id }}" type="file" name="imagenes[]" accept="image/*" capture="environment"
             class="sr-only file-input-camera" {% if r.id in locked_ids or r.uploaded > 0 or r.completed_global %}disabled{% endif %}>
      <button type="button"
              class="px-3 py-2 rounded text-sm
                     {% if r.id in locked_ids or r.uploaded > 0 or r.completed_global %}bg-gray-100 text-gray-400 cursor-not-allowed opacity-60{% else %}bg-gray-100 hover:bg-gray-200{% endif %} trigger-camera"
              data-target="file-camera-{{ r.id }}"
              {% if r.id in locked_ids or r.uploaded > 0 or r.completed_global %}disabled{% endif %}>
        üì∑ Tomar
      </button>
    </div>

    <div class="flex items-center justify-between mt-2 text-xs text-gray-600">
      <span class="gps-status">
        {% if r.id in locked_ids or r.uploaded > 0 or r.completed_global %}üìç Cerrado{% else %}üìç En espera de ubicaci√≥n‚Ä¶{% endif %}
      </span>
      <span class="time-status">üïí ‚Äî</span>
    </div>

    <div class="flex items-center gap-2 mt-2">
      <input type="text" name="nota" placeholder="Nota (opcional)" class="w-full border rounded p-2"
             {% if r.id in locked_ids or r.uploaded > 0 or r.completed_global %}disabled{% endif %}>
      <button type="button"
              class="grant-location px-3 py-2 rounded bg-blue-50 text-blue-700 hover:bg-blue-100 text-sm
                     {% if r.id in locked_ids or r.uploaded > 0 or r.completed_global %}opacity-60 cursor-not-allowed{% endif %}"
              {% if r.id in locked_ids or r.uploaded > 0 or r.completed_global %}disabled{% endif %}>
        Capturar ubicaci√≥n
      </button>
    </div>

    <button class="mt-2 px-3 py-1 rounded
                   {% if r.id in locked_ids or r.uploaded > 0 or r.completed_global %}bg-gray-300 text-white cursor-not-allowed opacity-60{% else %}bg-blue-600 text-white hover:bg-blue-700{% endif %}"
            {% if r.id in locked_ids or r.uploaded > 0 or r.completed_global %}disabled{% endif %}>
      Subir
    </button>
  </form>
</li>


        {% endfor %}
      </ul>

     <div class="mt-6">
  <h3 class="font-semibold mb-2">Fotos Extra</h3>

  <form method="post" enctype="multipart/form-data"
        class="geo-upload-form ajax-uploader border rounded p-3" data-extra="1">
    {% csrf_token %}

    <!-- HIDDEN META -->
    <input type="hidden" name="lat">
    <input type="hidden" name="lng">
    <input type="hidden" name="acc">
    <input type="hidden" name="client_taken_at">

    <div class="flex items-center gap-2">
      <input id="file-gallery-extra" type="file" name="imagenes[]" accept="image/*" multiple class="sr-only file-input">
      <label for="file-gallery-extra" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm cursor-pointer">üìÅ Elegir archivos</label>
      <span class="text-xs text-gray-600 filename" data-empty="Sin archivos">Sin archivos</span>

      <input id="file-camera-extra" type="file" name="imagenes[]" accept="image/*" capture="environment" class="sr-only file-input-camera">
      <button type="button" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm trigger-camera" data-target="file-camera-extra">üì∑ Tomar</button>
    </div>

    <div class="flex items-center justify-between mt-2 text-xs text-gray-600">
      <span class="gps-status">üìç En espera de ubicaci√≥n‚Ä¶</span>
      <span class="time-status">üïí ‚Äî</span>
    </div>

    {% if is_proyecto_especial %}
      <div class="mt-3">
        <label for="titulo_manual" class="block text-sm font-semibold text-gray-700">T√≠tulo (requerido para Extra)</label>
        <input type="text" name="titulo_manual" id="titulo_manual" class="w-full border rounded-lg p-2" placeholder="Escribe un t√≠tulo para esta foto" required>
      </div>
    {% else %}
      <input type="hidden" name="titulo_manual" value="Extra">
    {% endif %}

    <div class="flex items-center gap-2 mt-2">
      <input type="text" name="nota" placeholder="Nota (opcional)" class="w-full border rounded p-2">
      <button type="button" class="grant-location px-3 py-2 rounded bg-blue-50 text-blue-700 hover:bg-blue-100 text-sm">Capturar ubicaci√≥n</button>
    </div>

    <button class="mt-2 bg-gray-800 text-white px-3 py-1 rounded">Subir</button>
  </form>
</div>

 </div>



  <div>
      <h2 class="font-semibold mb-2">Subidas</h2>

<!-- hooks para JS (no cambia comportamiento visual) -->
<div id="js-urls"
     data-delete-url-template="{% url 'operaciones:fotos_borrar_evidencia' 0 %}"
     data-status-url="{% url 'operaciones:fotos_status_json' a.pk %}">
</div>
<script>
  // ‚ñ∫ GLOBAL: disponible para otros scripts
  window.CAN_DELETE = {% if a.estado == 'en_proceso' %}true{% elif a.estado == 'rechazado_supervisor' and a.reintento_habilitado %}true{% else %}false{% endif %};
  window.DELETE_URL_TPL = document.getElementById('js-urls')?.dataset?.deleteUrlTemplate || '';
  window.deleteUrlFor   = (id) => (window.DELETE_URL_TPL || '').replace(/\/0(\/|$)/, `/${id}$1`);

  // Convierte candados existentes en botones ‚úï (si hay permiso)
  window.__upgradeDeleteBadges = function () {
    if (!window.CAN_DELETE || !window.DELETE_URL_TPL) return;
    document.querySelectorAll('.grid.grid-cols-2.gap-3 figure[data-ev-id]').forEach(fig => {
      if (fig.querySelector('[data-delete]')) return;      // ya tiene ‚úï
      const evId = fig.getAttribute('data-ev-id');
      if (!evId) return;
      const holder = fig.querySelector('.relative');
      const lock = holder?.querySelector('[title="Bloqueado"]');
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.title = 'Eliminar esta foto';
      btn.className = 'absolute top-1 right-1 w-7 h-7 rounded-full flex items-center justify-center bg-red-600/90 hover:bg-red-700 text-white text-sm shadow';
      btn.setAttribute('data-delete','');
      btn.setAttribute('data-action', window.deleteUrlFor(evId));
      btn.textContent = '‚úï';
      if (lock) lock.replaceWith(btn); else holder?.appendChild(btn);
    });
  };

  // Al cargar la p√°gina, ‚Äúupgradear‚Äù lo que vino del server
  document.addEventListener('DOMContentLoaded', window.__upgradeDeleteBadges);
</script>


      <div class="grid grid-cols-2 gap-3 max-h-[600px] overflow-auto">
{% for ev in evidencias %}
  <figure class="border rounded p-2"
          data-ev-id="{{ ev.id }}"
          {% if ev.requisito_id %}data-req="{{ ev.requisito.id }}"{% endif %}>
    <div class="relative">
      <img src="{{ ev.imagen.url }}" class="w-full h-32 object-cover rounded" loading="lazy" alt="photo">


{% if a.estado == 'en_proceso' %}
  <button type="button"
          class="absolute top-1 right-1 w-7 h-7 rounded-full flex items-center justify-center
                 bg-red-600/90 hover:bg-red-700 text-white text-sm shadow"
          title="Eliminar esta foto"
          data-delete
          data-action="{% url 'operaciones:fotos_borrar_evidencia' ev.id %}">
    ‚úï
  </button>
{% elif a.estado == 'rechazado_supervisor' and a.reintento_habilitado %}
  <button type="button"
          class="absolute top-1 right-1 w-7 h-7 rounded-full flex items-center justify-center
                 bg-red-600/90 hover:bg-red-700 text-white text-sm shadow"
          title="Eliminar esta foto"
          data-delete
          data-action="{% url 'operaciones:fotos_borrar_evidencia' ev.id %}">
    ‚úï
  </button>
{% else %}
  <span class="absolute top-1 right-1 w-7 h-7 rounded-full grid place-items-center
               bg-gray-300 text-white text-sm"
        title="Bloqueado">
    üîí
  </span>
{% endif %}
    </div>

    <figcaption class="text-xs mt-1 space-y-0.5">
      <div class="font-medium">
        {% if ev.requisito %}{{ ev.requisito.titulo }}
        {% elif ev.titulo_manual %}{{ ev.titulo_manual }}
        {% else %}Extra{% endif %}
      </div>
      <div>üïí {% if ev.client_taken_at %}{{ ev.client_taken_at|date:"Y-m-d H:i" }}{% else %}{{ ev.tomada_en|date:"Y-m-d H:i" }}{% endif %}</div>

{% if ev.lat and ev.lng %}
  <div>
    üìç {{ ev.lat|unlocalize }}, {{ ev.lng|unlocalize }}
    {% if ev.gps_accuracy_m %} (¬±{{ ev.gps_accuracy_m|unlocalize }}m){% endif %}
  </div>
  <a class="text-blue-600 hover:underline" target="_blank" rel="noopener"
     href="https://maps.google.com/?q={{ ev.lat|unlocalize }},{{ ev.lng|unlocalize }}">
    Abrir en Maps
  </a>
{% else %}
  <div class="text-gray-400">üìç Sin GPS</div>
{% endif %}




      {% if ev.nota %}
        <div class="text-gray-600">{{ ev.nota }}</div>
      {% endif %}
    </figcaption>
  </figure>
{% empty %}
  <div class="text-gray-500" data-empty>A√∫n no hay fotos.</div>
{% endfor %}
      </div>
    </div>
  </div>

<!-- Modal eliminar evidencia -->
<div id="delete-modal" class="fixed inset-0 z-50 hidden">
  <button id="delete-backdrop" class="absolute inset-0 bg-black/40" aria-label="Cerrar"></button>

  <div class="relative max-w-md mx-auto bg-white rounded-2xl shadow p-6 mt-40">
    <h3 class="text-lg font-semibold text-red-600">Eliminar foto</h3>
    <p class="mt-1 text-sm text-gray-600">¬øSeguro que deseas eliminar esta foto? Esta acci√≥n no se puede deshacer.</p>

    <form id="delete-form" method="post" class="mt-4">
      {% csrf_token %}
      <div class="flex justify-end gap-2">
        <button type="button"
                id="delete-cancel"
                class="px-4 py-2 rounded bg-gray-100 hover:bg-gray-200">
          Cancelar
        </button>
        <button type="submit"
                class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">
          Eliminar
        </button>
      </div>
    </form>
  </div>
</div>
</div>


<script>
  // IDs de evidencias ya presentes en el DOM
  window.__knownEvIds = new Set(
    Array.from(document.querySelectorAll('figure[data-ev-id]'))
         .map(f => parseInt(f.getAttribute('data-ev-id'),10))
         .filter(Number.isFinite)
  );
  window.__maxEvId = window.__knownEvIds.size
    ? Math.max(...Array.from(window.__knownEvIds))
    : 0;
</script>

<script>
  (function () {
    const modal    = document.getElementById('delete-modal');
    const form     = document.getElementById('delete-form');
    const backdrop = document.getElementById('delete-backdrop');
    const cancel   = document.getElementById('delete-cancel');
    const CSRF     = (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value;

    let targetFigure = null;

    function openModal(actionUrl, fig) {
      targetFigure = fig || null;
      form.setAttribute('action', actionUrl);
      modal.classList.remove('hidden');
    }
    function closeModal() {
      modal.classList.add('hidden');
      form.removeAttribute('action');
      targetFigure = null;
    }

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-delete]');
      if (!btn) return;
      e.preventDefault();
      openModal(btn.getAttribute('data-action'), btn.closest('figure'));
    });

    backdrop.addEventListener('click', closeModal);
    cancel.addEventListener('click', closeModal);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal();
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const action = form.getAttribute('action');
      if (!action) return;

      try {
        const fd = new FormData(form);
        const res = await fetch(action, {
          method: 'POST',
          body: fd,
          headers: { 'X-CSRFToken': CSRF },
          cache: 'no-store'
        });

        if ((res.status >= 200 && res.status < 300) || (res.status >= 300 && res.status < 400)) {
          window.location.reload();
          return;
        }
        throw new Error('Error al borrar: ' + res.status);
      } catch (err) {
        alert('No se pudo eliminar la foto. Vuelve a intentarlo.');
      } finally {
        closeModal();
      }
    });
  })();
</script>

<script>
/* Exponer una funci√≥n global para capturar GPS al ENVIAR */
window.__captureGeoForFotos = async function(form){
  const GEO_OPTS = { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 };
  const latEl   = form.querySelector('input[name="lat"]');
  const lngEl   = form.querySelector('input[name="lng"]');
  const accEl   = form.querySelector('input[name="acc"]');
  const takenEl = form.querySelector('input[name="client_taken_at"]');
  const gpsStatus  = form.querySelector('.gps-status');
  const timeStatus = form.querySelector('.time-status');

  const now = new Date();
  if (takenEl) takenEl.value = now.toISOString();
  if (timeStatus) timeStatus.textContent = "üïí " + now.toLocaleString();

  if (!('geolocation' in navigator)) {
    if (gpsStatus) gpsStatus.textContent = "üìç Geolocalizaci√≥n no soportada";
    return false;
  }

  return new Promise((resolve)=>{
    navigator.geolocation.getCurrentPosition(
      (pos)=>{
        const { latitude, longitude, accuracy } = (pos && pos.coords) || {};
        if (latEl) latEl.value = latitude ?? "";
        if (lngEl) lngEl.value = longitude ?? "";
        if (accEl) accEl.value = accuracy ?? "";
        if (latEl.value && lngEl.value){
          if (gpsStatus) gpsStatus.textContent =
            `üìç ${Number(latEl.value).toFixed(6)}, ${Number(lngEl.value).toFixed(6)}${accEl.value ? " (¬±"+Math.round(accEl.value)+"m)" : ""}`;
          resolve(true);
        } else {
          if (gpsStatus) gpsStatus.textContent = "üìç Ubicaci√≥n no disponible";
          resolve(false);
        }
      },
      ()=>{
        if (gpsStatus) gpsStatus.textContent = "üìç Permiso denegado o no disponible";
        resolve(false);
      },
      { ...GEO_OPTS }
    );
  });
};
</script>

<script>
(function(){
  const GEO_OPTS = { enableHighAccuracy: true, maximumAge: 0, timeout: 20000 };

  async function captureGeo(form){
    const latEl   = form.querySelector('input[name="lat"]');
    const lngEl   = form.querySelector('input[name="lng"]');
    const accEl   = form.querySelector('input[name="acc"]');
    const takenEl = form.querySelector('input[name="client_taken_at"]');
    const gpsStatus  = form.querySelector('.gps-status');
    const timeStatus = form.querySelector('.time-status');

    function setTimeNow(){
      const now = new Date();
      if (takenEl) takenEl.value = now.toISOString();
      if (timeStatus) timeStatus.textContent = "üïí " + now.toLocaleString();
    }
    function setGps(text){ if (gpsStatus) gpsStatus.textContent = text; }

    setTimeNow();

    if (!('geolocation' in navigator)){
      setGps("üìç Geolocalizaci√≥n no soportada");
      return false;
    }

    setGps("üìç Obteniendo ubicaci√≥n‚Ä¶");
    return new Promise((resolve)=>{
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          const { latitude, longitude, accuracy } = (pos && pos.coords) || {};
          if (latEl) latEl.value = (latitude ?? "");
          if (lngEl) lngEl.value = (longitude ?? "");
          if (accEl) accEl.value = (accuracy ?? "");
          if (latEl.value && lngEl.value){
            setGps(`üìç ${Number(latEl.value).toFixed(6)}, ${Number(lngEl.value).toFixed(6)}${accEl.value ? " (¬±"+Math.round(accEl.value)+"m)" : ""}`);
            resolve(true);
          } else {
            setGps("üìç Ubicaci√≥n no disponible");
            resolve(false);
          }
        },
        ()=>{
          setGps("üìç Permiso denegado o no disponible");
          resolve(false);
        },
        GEO_OPTS
      );
    });
  }

  document.querySelectorAll('.geo-upload-form').forEach(form=>{
    const fileInputGallery = form.querySelector('.file-input');
    const fileInputCam     = form.querySelector('.file-input-camera');
    const filenameEl       = form.querySelector('.filename');

    if (filenameEl) filenameEl.textContent = filenameEl.getAttribute('data-empty') || 'Sin archivos';

    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.trigger-camera');
      if(!btn) return;
      if(btn.closest('form') !== form) return;
      const id = btn.getAttribute('data-target');
      const inputCam = document.getElementById(id);
      if(inputCam) inputCam.click();
    });

    if (fileInputGallery){
      fileInputGallery.addEventListener('change', () => {
        const n = fileInputGallery.files ? fileInputGallery.files.length : 0;
        if (filenameEl){
          filenameEl.textContent = n===0 ? (filenameEl.dataset.empty || 'Sin archivos')
                               : n===1 ? fileInputGallery.files[0].name
                                       : `${n} archivos seleccionados`;
        }
      });
    }

    if (fileInputCam){
      fileInputCam.addEventListener('change', () => {
        const n = fileInputCam.files ? fileInputCam.files.length : 0;
        if (filenameEl){
          filenameEl.textContent = n===0 ? (filenameEl.dataset.empty || 'Sin archivos')
                               : n===1 ? fileInputCam.files[0].name
                                       : `${n} archivos seleccionados`;
        }
      });
    }

    const btnGrant = form.querySelector('.grant-location');
    if (btnGrant){
      btnGrant.addEventListener('click', async ()=>{ await captureGeo(form); });
    }

  form.addEventListener('submit', (e) => {
  // ‚ö†Ô∏è Nunca dejes pasar el submit nativo: el uploader AJAX es quien sube.
  e.preventDefault();
  // No hacemos nada aqu√≠: el otro bloque (uploader) maneja la subida en su propio submit.
});
  });
})();
</script>

<script>
/* Geolocalizaci√≥n pasiva global */
(function(){
  const OPTS = { enableHighAccuracy:true, maximumAge:10000, timeout:8000 };
  const last = { ok:false, lat:null, lng:null, acc:null, ts:0 };
  window.__lastGeo = last;

  function setLabelCoords(el, lat, lng, acc){
    if (!el) return;
    el.textContent = `üìç ${lat.toFixed(6)}, ${lng.toFixed(6)}${isFinite(acc)?' (¬±'+Math.round(acc)+'m)':''}`;
  }

  function stampToForm(form){
    const latEl=form.querySelector('input[name="lat"]');
    const lngEl=form.querySelector('input[name="lng"]');
    const accEl=form.querySelector('input[name="acc"]');
    const tEl  =form.querySelector('input[name="client_taken_at"]');
    const lbl  =form.querySelector('.gps-status');
    if (tEl && !tEl.value) tEl.value = new Date().toISOString();

    if (last.ok && latEl && lngEl){
      latEl.value = last.lat; lngEl.value = last.lng;
      if (accEl) accEl.value = last.acc ?? '';
      setLabelCoords(lbl, Number(last.lat), Number(last.lng), Number(last.acc));
      return true;
    }
    return false;
  }

  if ('geolocation' in navigator){
    try {
      navigator.geolocation.watchPosition((pos)=>{
        const c = pos.coords||{};
        last.ok  = isFinite(c.latitude) && isFinite(c.longitude);
        last.lat = c.latitude;
        last.lng = c.longitude;
        last.acc = c.accuracy;
        last.ts  = Date.now();
        document.querySelectorAll('.geo-upload-form').forEach(f=>{
          const lbl=f.querySelector('.gps-status');
          if (last.ok && lbl && /espera|intentando/i.test(lbl.textContent||'')){
            stampToForm(f);
          }
        });
      }, ()=>{}, OPTS);
    } catch(e){}
  }

  window.__stampGeoIntoForm = async function(form){
    if (stampToForm(form)) return true;

    const lbl=form.querySelector('.gps-status');
    if (lbl) lbl.textContent='üìç Intentando obtener ubicaci√≥n‚Ä¶';

    if (!('geolocation' in navigator)) {
      if (lbl) lbl.textContent='üìç Geolocalizaci√≥n no soportada';
      return false;
    }
    return new Promise(resolve=>{
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          const c=pos.coords||{};
          last.ok  = isFinite(c.latitude)&&isFinite(c.longitude);
          last.lat = c.latitude; last.lng = c.longitude; last.acc = c.accuracy;
          stampToForm(form);
          resolve(true);
        },
        ()=>{
          if (lbl) lbl.textContent='üìç Sin GPS (se subir√° sin coordenadas)';
          resolve(false);
        },
        OPTS
      );
    });
  };
})();
</script>

<script>
/* ‚Äî dentro del uploader ‚Äî */
async function resizeImage(file, maxSide=1600, quality=0.85) {
  if (file && file.size <= 1_000_000) return file;
  if (!/^image\/(jpeg|jpg|png|webp)$/i.test(file.type)) return file;
  const bmp = await createImageBitmap(file).catch(()=>null);
  if (!bmp) return file;
  const scale = Math.min(1, maxSide / Math.max(bmp.width, bmp.height));
  if (scale === 1) return file;

  const canvas = document.createElement('canvas');
  canvas.width  = Math.round(bmp.width*scale);
  canvas.height = Math.round(bmp.height*scale);
  canvas.getContext('2d').drawImage(bmp, 0, 0, canvas.width, canvas.height);

  const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', quality));
  const safeName = (file.name || 'foto').replace(/\.(heic|heif|png|webp)$/i, '.jpg');
  return new File([blob], safeName, {type: 'image/jpeg'});
}
</script>

<script>
/* ‚Äî dentro del uploader ‚Äî */
async function bestEffortGps(form){
  if (window.__stampGeoIntoForm) {
    const ok = await window.__stampGeoIntoForm(form);
    if (ok) return true;
  }
  if (window.__captureGeoForFotos) {
    const lbl = form.querySelector('.gps-status');
    if (lbl) lbl.textContent = 'üìç Intentando obtener ubicaci√≥n‚Ä¶';
    const ok2 = await window.__captureGeoForFotos(form);
    if (!ok2 && lbl) lbl.textContent = 'üìç Sin GPS (se subir√° sin coordenadas)';
    return ok2;
  }
  return false;
}
</script>

<script>
(() => {
  /* ‚úÖ endpoint AJAX correcto */
  const UPLOAD_URL = "{% url 'operaciones:fotos_upload_ajax' a.pk %}";
  const CSRF = (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value;

  // ---- estado por requisito (contador propio)
  const myCountsByReq = new Map();
  document.querySelectorAll('.req-count[data-req]').forEach(el => {
    const id = el.getAttribute('data-req');
    const m = (el.textContent.match(/\d+/) || [0])[0];
    myCountsByReq.set(id, parseInt(m,10));
  });

  function setReqEnabled(reqId, enabled){
    const inp = document.querySelector(`input[name="req_id"][value="${reqId}"]`);
    if (!inp) return;
    const li   = inp.closest('li');
    const form = inp.closest('form');

    const gallery = document.getElementById(`file-gallery-${reqId}`);
    const lblGal  = li?.querySelector(`label[for="file-gallery-${reqId}"]`);
    const cam     = document.getElementById(`file-camera-${reqId}`);
    const btnCam  = li?.querySelector(`.trigger-camera[data-target="file-camera-${reqId}"]`);
    const btnLoc  = li?.querySelector('.grant-location');
    const nota    = li?.querySelector('input[name="nota"]');
    const submit  = form?.querySelector('button[type="submit"], button:not([type])');

    [gallery, cam, btnCam, btnLoc, nota, submit].forEach(el=>{
      if(!el) return;
      el.disabled = !enabled;
      el.classList.toggle('cursor-not-allowed', !enabled);
      el.classList.toggle('opacity-60', !enabled);
    });
    if (lblGal){
      lblGal.classList.toggle('pointer-events-none', !enabled);
      lblGal.classList.toggle('opacity-60', !enabled);
    }
    const filenameEl = form?.querySelector('.filename');
    if (filenameEl) filenameEl.textContent = enabled ? (filenameEl.dataset.empty || 'Sin archivos') : 'Cerrado';
    if (!enabled && nota) nota.value = '';
  }
  window.__setReqEnabled = setReqEnabled;

  function markReqDone(reqId){
    if (!reqId) return;
    const n = (myCountsByReq.get(String(reqId)) || 0) + 1;
    myCountsByReq.set(String(reqId), n);
    const countEl = document.querySelector(`.req-count[data-req="${reqId}"]`);
    if (countEl) countEl.textContent = `${n} subidas (t√∫)`;
    const badge = document.querySelector(`.req-badge[data-req="${reqId}"]`);
    if (badge){
      badge.dataset.state = 'done';
      badge.textContent   = 'Completado';
      badge.classList.remove('bg-red-100','text-red-800');
      badge.classList.add('bg-green-100','text-green-800');
    }
  }

  function afterFormDrained(form){
    const filenameEl = form.querySelector('.filename');
    if (filenameEl) {
      filenameEl.textContent = 'Completado';
      clearTimeout(form._filenameTimer);
      form._filenameTimer = setTimeout(() => {
        filenameEl.textContent = filenameEl.dataset.empty || 'Sin archivos';
      }, 1500);
    }
    form.querySelectorAll('input[type=file][name="imagenes[]"]').forEach(inp => { inp.value = ''; });
    const titulo = form.querySelector('input[name="titulo_manual"]');
    if (titulo && (titulo.type || '').toLowerCase() !== 'hidden') titulo.value = '';
    const nota = form.querySelector('input[name="nota"]');
    if (nota) nota.value = '';
    const gpsStatus  = form.querySelector('.gps-status');
    if (gpsStatus) gpsStatus.textContent = 'üìç En espera de ubicaci√≥n‚Ä¶';
    const timeStatus = form.querySelector('.time-status');
    if (timeStatus) timeStatus.textContent = 'üïí ‚Äî';
    ['lat','lng','acc','client_taken_at'].forEach(nm => {
      const el = form.querySelector(`input[name="${nm}"]`);
      if (el) el.value = '';
    });
    const reqId = form.querySelector('input[name="req_id"]')?.value || null;
    if (reqId) {
      const badge = document.querySelector(`.req-badge[data-req="${reqId}"]`);
      if (badge && badge.dataset.state === 'done' && window.__setReqEnabled) {
        window.__setReqEnabled(reqId, false);
        delete form.dataset.working;
      }
    }
  }

  function insertEvidenceFigure(fig, ev) {
    const grid = document.querySelector('.grid.grid-cols-2.gap-3');
    if (!grid) return;
    const emptyMsg = grid.querySelector('[data-empty]');
    if (emptyMsg) emptyMsg.remove();
    const firstExtra = grid.querySelector('figure:not([data-req])');
    if (ev.req_id) {
      if (firstExtra) grid.insertBefore(fig, firstExtra);
      else grid.appendChild(fig);
    } else {
      grid.appendChild(fig);
    }
  }

  function addEvidenceCard(ev) {
    const grid = document.querySelector('.grid.grid-cols-2.gap-3');
    if (!grid) return;

    const fig = document.createElement('figure');
    fig.className = "border rounded p-2";
    fig.setAttribute('data-ev-id', ev.id);
    if (ev.req_id) fig.setAttribute('data-req', ev.req_id);

    const gps = (ev.lat && ev.lng)
      ? `üìç ${Number(ev.lat).toFixed(5)}, ${Number(ev.lng).toFixed(5)}${ev.acc ? " (¬±"+Math.round(ev.acc)+"m)" : ""}`
      : 'üìç Sin GPS';

    let badgeHtml = `<span class="absolute top-1 right-1 w-7 h-7 rounded-full grid place-items-center bg-gray-300 text-white text-sm" title="Bloqueado">üîí</span>`;
    if (window.CAN_DELETE && window.DELETE_URL_TPL) {
      const action = window.deleteUrlFor ? window.deleteUrlFor(ev.id)
                                         : window.DELETE_URL_TPL.replace(/\/0(\/|$)/, `/${ev.id}$1`);
      badgeHtml = `
        <button type="button"
                class="absolute top-1 right-1 w-7 h-7 rounded-full flex items-center justify-center
                       bg-red-600/90 hover:bg-red-700 text-white text-sm shadow"
                title="Eliminar esta foto"
                data-delete
                data-action="${action}">‚úï</button>`;
    }

    fig.innerHTML = `
      <div class="relative">
        <img src="${ev.url}" class="w-full h-32 object-cover rounded" loading="lazy" alt="photo">
        ${badgeHtml}
      </div>
      <figcaption class="text-xs mt-1 space-y-0.5">
        <div class="font-medium">${ev.titulo}</div>
        <div>üïí ${ev.fecha}</div>
        <div>${gps}</div>
      </figcaption>`;

    insertEvidenceFigure(fig, ev);
    if (typeof window.__upgradeDeleteBadges === 'function') window.__upgradeDeleteBadges();
  }

  function makeQueueItem(file, meta, parentForm) {
    const el = document.createElement('div');
    el.className = "border rounded p-2 relative";
    el.innerHTML = `
      <div class="text-xs mb-1 truncate">${file.name}</div>
      <div class="w-full h-2 bg-gray-100 rounded overflow-hidden">
        <div class="h-2 bg-blue-600" style="width:0%"></div>
      </div>
      <div class="flex items-center justify-between mt-1 text-xs text-gray-600">
        <span class="status">Preparando‚Ä¶</span>
        <button class="cancel text-red-600" type="button">Cancelar</button>
      </div>`;
    el._meta = meta;
    el._file = file;
    el._xhr  = null;
    el._parentForm = parentForm;
    return el;
  }

  async function uploadOne(el) {
    const bar = el.querySelector('.bg-blue-600');
    const status = el.querySelector('.status');
    const cancelBtn = el.querySelector('.cancel');

    status.textContent = 'Optimizando‚Ä¶';
    // usa el resize global si existe; si no, sin cambio
    const small = (typeof resizeImage === 'function')
      ? await resizeImage(el._file).catch(()=>el._file)
      : el._file;

    const fd = new FormData();
    if (CSRF) fd.append('csrfmiddlewaretoken', CSRF);
    fd.append('imagen', small);
    for (const [k, v] of Object.entries(el._meta||{})) {
      if (v !== undefined && v !== null) fd.append(k, v);
    }

    const xhr = new XMLHttpRequest();
    el._xhr = xhr;

    return new Promise((resolve) => {
      xhr.upload.addEventListener('progress', (e) => {
        if (!e.lengthComputable) return;
        const pct = Math.round((e.loaded / e.total) * 100);
        bar.style.width = pct + '%';
        status.textContent = `Subiendo‚Ä¶ ${pct}%`;
      });

      xhr.onreadystatechange = () => {
        if (xhr.readyState !== 4) return;
        cancelBtn.disabled = true;
        try {
          const data = JSON.parse(xhr.responseText);
          if (xhr.status >= 200 && xhr.status < 300 && data.ok) {
            bar.style.width = '100%';
            status.textContent = 'Completado';
            addEvidenceCard(data.evidencia);
            if (el._meta.req_id) markReqDone(el._meta.req_id);
            if (typeof window.__refreshFotosStatus === 'function') window.__refreshFotosStatus();
            setTimeout(()=> el.remove(), 400);
          } else {
            status.textContent = (data && data.error) ? data.error : `Error ${xhr.status}`;
            el.classList.add('bg-red-50');
          }
        } catch {
          status.textContent = `Error ${xhr.status}`;
          el.classList.add('bg-red-50');
        }

        const form = el._parentForm;
        const filenameEl = form ? form.querySelector('.filename') : null;
        if (form) {
          form._pendingUploads = Math.max(0, (form._pendingUploads||0) - 1);
          if (filenameEl && form._pendingUploads > 0) filenameEl.textContent = 'Subiendo‚Ä¶';
          if (form._pendingUploads === 0) afterFormDrained(form);
        }
        if (typeof window.__upgradeDeleteBadges === 'function') window.__upgradeDeleteBadges();

        resolve();
      };

      cancelBtn.addEventListener('click', () => {
        if (el._xhr) el._xhr.abort();
        status.textContent = 'Cancelado';
        el.classList.add('opacity-60');
        const form = el._parentForm;
        if (form) {
          form._pendingUploads = Math.max(0, (form._pendingUploads||0) - 1);
          if (form._pendingUploads === 0) afterFormDrained(form);
        }
        setTimeout(()=> el.remove(), 300);
      });

      xhr.open('POST', UPLOAD_URL, true);
      xhr.send(fd);
    });
  }

  // best-effort GPS auxiliar (por si no existe el global)
  async function bestEffortGpsLocal(form){
    const latEl = form.querySelector('input[name="lat"]');
    const lngEl = form.querySelector('input[name="lng"]');
    const accEl = form.querySelector('input[name="acc"]');
    const taken = form.querySelector('input[name="client_taken_at"]');
    const gpsLabel = form.querySelector('.gps-status');

    if (taken && !taken.value) taken.value = new Date().toISOString();
    if (latEl?.value && lngEl?.value) return true;

    if (gpsLabel) gpsLabel.textContent = 'üìç Intentando obtener ubicaci√≥n‚Ä¶';

    let ok = false;
    if (window.__captureGeoForFotos) ok = await window.__captureGeoForFotos(form);
    if (!ok) {
      if (gpsLabel) gpsLabel.textContent = 'üìç Sin GPS (se subir√° sin coordenadas)';
      if (accEl) accEl.value = '';
      return false;
    }
    return true;
  }

  const queue = [];
  let pumping = false;
  async function pump(){
    if (pumping) return;
    pumping = true;
    try {
      while (queue.length){
        const el = queue.shift();
        await uploadOne(el);
      }
    } finally {
      pumping = false;
    }
  }

  /* ‚úÖ FALTABA: funci√≥n que encola los archivos del formulario */
  async function pushFiles(form, files) {
    // L√≠mite para EXTRAS (si aplica)
    const reqId = form.querySelector('input[name="req_id"]')?.value || "";
     if (!reqId && Number.isFinite(window.__EXTRAS_LEFT)) {
   const left = window.__EXTRAS_LEFT;
   const max  = window.__MAX_EXTRA ?? left;
   if (left <= 0) { alert(`Ya alcanzaste el m√°ximo de ${max} fotos extra.`); return; }
   if (files.length > left) {
     alert(`Solo puedes subir ${left} foto(s) extra m√°s (m√°ximo ${max}).`);
     files = Array.from(files).slice(0, left);
   }
 }
    if (!files.length) return;

    form.dataset.working = '1';

    // GPS best-effort (usa global si existe; si no, local)
    if (typeof bestEffortGps === 'function') {
      await bestEffortGps(form);
    } else {
      await bestEffortGpsLocal(form);
    }

    // Meta com√∫n
    const lat   = form.querySelector('input[name="lat"]')?.value || "";
    const lng   = form.querySelector('input[name="lng"]')?.value || "";
    const acc   = form.querySelector('input[name="acc"]')?.value || "";
    const taken = form.querySelector('input[name="client_taken_at"]')?.value || new Date().toISOString();
    const nota  = form.querySelector('input[name="nota"]')?.value || "";
    const titulo_manual = form.querySelector('input[name="titulo_manual"]')?.value || "";

    form._pendingUploads = (form._pendingUploads || 0) + files.length;

    const queueBox = form._queueBox || form.querySelector('.mt-2.space-y-2');

    for (const f of files) {
      const el = makeQueueItem(f, {
        req_id: reqId || undefined,
        nota: nota || undefined,
        lat, lng, acc,
        client_taken_at: taken,
        titulo_manual: titulo_manual || undefined,
      }, form);
      queueBox.prepend(el);
      queue.push(el);
      pump();
    }

    const filenameEl = form.querySelector('.filename');
    if (filenameEl) {
      filenameEl.textContent = `${files.length} archivo${files.length>1?'s':''} en cola`;
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Wire de formularios
  document.querySelectorAll('.geo-upload-form').forEach(form => {
    const queueBox = document.createElement('div');
    queueBox.className = "mt-2 space-y-2";
    form.appendChild(queueBox);
    form._queueBox = queueBox;
    form._pendingUploads = 0;

    const fileInputs = form.querySelectorAll('input[type=file][name="imagenes[]"]');
    const filenameEl = form.querySelector('.filename');

    // Solo mostrar nombre/cantidad al elegir; no subir a√∫n
    fileInputs.forEach(inp => {
      inp.addEventListener('change', () => {
        const n = inp.files ? inp.files.length : 0;
        if (!filenameEl) return;
        filenameEl.textContent =
          n === 0 ? (filenameEl.dataset.empty || 'Sin archivos')
        : n === 1 ? inp.files[0].name
                  : `${n} archivos seleccionados`;
      });
    });

    // La subida ocurre al hacer submit (click ‚ÄúSubir‚Äù)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const files = [];
      fileInputs.forEach(inp => {
        if (inp.files && inp.files.length) files.push(...inp.files);
      });
      if (!files.length) { alert('Selecciona al menos una imagen.'); return; }
      await pushFiles(form, files);
      fileInputs.forEach(inp => inp.value = '');
    });
  });
})();
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    if (typeof window.__setReqEnabled !== 'function') return;

    document.querySelectorAll('.req-badge[data-req]').forEach(badge => {
      const reqId = badge.getAttribute('data-req');
      const state = badge.getAttribute('data-state');
      if (state === 'done' && reqId) {
        window.__setReqEnabled(reqId, false);
      }
    });
  });
</script>

<div id="js-status" data-status-url="{% url 'operaciones:fotos_status_json' a.pk %}"></div>


<script>
(function(){
  var hostEl = document.getElementById('js-status');
  var STATUS_URL = hostEl ? hostEl.getAttribute('data-status-url') : '';
  if (!STATUS_URL) return;

  function updateMissingBanner(list){
    var el = document.getElementById('faltantes-banner');
    if (!el) return;
    if (Array.isArray(list) && list.length){
      el.classList.remove('hidden');
      el.textContent = 'Faltan fotos requeridas: ' + list.join(', ') + '.';
    } else {
      el.classList.add('hidden');
      el.textContent = '';
    }
  }

  function setFinishEnabled(enabled){
    var btn = document.getElementById('btn-finalizar');
    if (!btn) return;
    btn.disabled = !enabled;
    if (enabled){
      btn.className = 'inline-flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md';
      btn.removeAttribute('title');
    } else {
      btn.className = 'inline-flex items-center gap-2 bg-indigo-300 text-white px-4 py-2 rounded-md cursor-not-allowed';
      btn.title = 'Debes subir todas las fotos requeridas y que todos acepten la asignaci√≥n.';
    }
  }

  // ‚úÖ ESTA era la funci√≥n que faltaba
  function updateReqFromServer(list){
    if (!Array.isArray(list)) return;

    list.forEach(function(r){
      var badge = document.querySelector('.req-badge[data-req="' + r.id + '"]');
      var nowState = r.global_done ? 'done' : 'pending';

      if (badge){
        var prevState = badge.getAttribute('data-state');
        if (prevState !== nowState){
          badge.setAttribute('data-state', nowState);
          if (nowState === 'done'){
            badge.textContent = 'Completado';
            badge.classList.remove('bg-red-100','text-red-800');
            badge.classList.add('bg-green-100','text-green-800');
            if (typeof window.__setReqEnabled === 'function') window.__setReqEnabled(r.id, false);
          } else {
            badge.textContent = 'Pendiente';
            badge.classList.remove('bg-green-100','text-green-800');
            badge.classList.add('bg-red-100','text-red-800');
            if (typeof window.__setReqEnabled === 'function') window.__setReqEnabled(r.id, true);
          }
        }
      } else {
        // por si el requisito no est√° en DOM (raro), al menos ci√©rralo si est√° done
        if (r.global_done && typeof window.__setReqEnabled === 'function'){
          window.__setReqEnabled(r.id, false);
        }
      }
    });
  }

  function tick(){
    // param anti-cache por si el navegador ignora no-store
    var url = STATUS_URL + (STATUS_URL.includes('?') ? '&' : '?') + '_ts=' + Date.now();
    fetch(url, {cache:'no-store'})
      .then(r => r.ok ? r.json() : null)
      .then(j => {
        if (!j || !j.ok) return;
        updateReqFromServer(j.requisitos || []);
        setFinishEnabled(!!j.can_finish);
        updateMissingBanner(j.faltantes_global || []);

    if ('extras_left' in j) {
   window.__EXTRAS_LEFT = j.extras_left;     // puede ser n√∫mero o null (ilimitado)
   window.__MAX_EXTRA   = j.max_extra ?? null;
   const extraForm = document.querySelector('.geo-upload-form.ajax-uploader[data-extra="1"]');
   if (extraForm) {
     const hasLimit = Number.isFinite(j.extras_left);
     const enabled  = !hasLimit || j.extras_left > 0;   // null => habilitado
     extraForm.querySelectorAll('input[type=file],input[name=titulo_manual],input[name=nota],button')
       .forEach(el => el.disabled = !enabled);
     const fn = extraForm.querySelector('.filename');
     if (fn) fn.textContent = enabled ? (fn.dataset.empty || 'Sin archivos') : 'Cerrado';
     const gps = extraForm.querySelector('.gps-status');
     if (gps) {
       if (!enabled && hasLimit) {
         const maxTxt = (j.max_extra ?? j.extras_left ?? '').toString();
         gps.textContent = `üìç L√≠mite de ${maxTxt} extra alcanzado`;
       } else {
         gps.textContent = 'üìç En espera de ubicaci√≥n‚Ä¶';
       }
     }
   }
 }
      })
      .catch(()=>{});
  }

  document.addEventListener('DOMContentLoaded', tick);
  setInterval(tick, 8000);

  // llamado expl√≠cito tras cada subida exitosa
  window.__refreshFotosStatus = tick;
  window.__STATUS_URL = STATUS_URL;
})();
</script>



<script>
  window.__setReqEnabled = function(reqId, enabled){
  var inp = document.querySelector('input[name="req_id"][value="' + reqId + '"]');
  if (!inp) return;
  var li   = inp.closest('li');
  var form = inp.closest('form');

  var gallery = document.getElementById('file-gallery-' + reqId);
  var lblGal  = li ? li.querySelector('label[for="file-gallery-' + reqId + '"]') : null;
  var cam     = document.getElementById('file-camera-' + reqId);
  var btnCam  = li ? li.querySelector('.trigger-camera[data-target="file-camera-' + reqId + '"]') : null;
  var btnLoc  = li ? li.querySelector('.grant-location') : null;
  var nota    = li ? li.querySelector('input[name="nota"]') : null;
  var submit  = form ? (form.querySelector('button[type="submit"], button:not([type])')) : null;
  var filenameEl = form ? form.querySelector('.filename') : null;

  var hasPending = !!(form && ((form._pendingUploads||0) > 0 ||
                    Array.from(form.querySelectorAll('input[type=file][name="imagenes[]"]'))
                         .some(i => i.files && i.files.length)));
  var isWorking = hasPending || (form && form.dataset.working === '1');

  [gallery, cam, btnCam, btnLoc, nota, submit].forEach(function(el){
    if (!el) return;
    el.disabled = !enabled;
    if (!enabled) el.classList.add('cursor-not-allowed','opacity-60');
    else el.classList.remove('cursor-not-allowed','opacity-60');
  });
  if (lblGal){
    if (!enabled) lblGal.classList.add('pointer-events-none','opacity-60');
    else lblGal.classList.remove('pointer-events-none','opacity-60');
  }

  if (filenameEl){
    if (!enabled){
      filenameEl.textContent = 'Cerrado';
    } else {
      var txt = (filenameEl.textContent||'').trim();
      if ((txt === 'Cerrado' || txt === '') && !isWorking){
        filenameEl.textContent = filenameEl.getAttribute('data-empty') || 'Sin archivos';
      }
    }
  }

  var gpsStatus  = form ? form.querySelector('.gps-status') : null;
  var timeStatus = form ? form.querySelector('.time-status') : null;

  if (!enabled){
    if (gpsStatus)  gpsStatus.textContent  = 'üìç Cerrado';
    if (timeStatus) timeStatus.textContent = 'üïí ‚Äî';
    ['lat','lng','acc','client_taken_at'].forEach(function(nm){
      var el = form.querySelector('input[name="' + nm + '"]');
      if (el) el.value = '';
    });
    if (nota) nota.value = '';
  } else {
    if (gpsStatus && (gpsStatus.textContent||'').includes('Cerrado')){
      gpsStatus.textContent = 'üìç En espera de ubicaci√≥n‚Ä¶';
    }
  }
};
</script>

{% endblock %}
