{% extends "dashboard_admin/base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Rendiciones{% endblock %}

{% block dashboard_content %}
<div class="bg-white shadow mt-3 -mx-3 sm:mx-0 rounded-none sm:rounded-2xl px-3 py-4 sm:p-6">

  <style>
    /* ====== Cabecera tipo Excel (filtros por columna) ====== */
    .excel-header-btn{
      width:100%;
      justify-content:center;
      font-size:0.875rem;
    }
    .excel-header-btn .excel-arrow{
      font-size:0.65rem;
      margin-left:2px;
    }
    .excel-header-btn:hover .excel-arrow{
      color:#111827;
    }
    .excel-panel{
      position:fixed;
      z-index:50;
      width:300px;
      background:#fff;
      border-radius:0.75rem;
      border:1px solid #d1d5db;
      box-shadow:0 10px 30px rgba(0,0,0,.15);
      padding:0.75rem;
      font-size:0.8rem;
    }
    .excel-panel h3{
      font-weight:600;
      margin-bottom:0.5rem;
    }
    .excel-panel small{
      font-size:0.7rem;
      color:#6b7280;
    }
    .excel-panel .excel-options{
      max-height:220px;
      overflow-y:auto;
      border:1px solid #e5e7eb;
      border-radius:0.5rem;
      padding:0.25rem 0.5rem;
      margin-top:0.25rem;
      background:#f9fafb;
    }
    .excel-col-filtered .excel-header-btn{
      background:#e0f2fe;
      border-radius:999px;
    }
    .excel-col-filtered .excel-arrow{
      color:#2563eb !important;
    }
  </style>

  <!-- Encabezado -->
  <div class="flex flex-col sm:flex-row justify-start items-start sm:items-center mb-4 gap-2">
    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">üßæ Rendiciones</h2>
    {% if user.es_pm %}
    <a href="{% url 'operaciones:exportar_rendiciones_pm' %}"
       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full text-sm shadow">
      üì• Export to Excel
    </a>
    {% endif %}
  </div>

  <!-- Selector columnas -->
  <div class="flex justify-start mb-2">
    <details class="relative">
      <summary class="cursor-pointer text-sm text-gray-700 px-3 py-1 border rounded-full bg-gray-50 hover:bg-gray-100 select-none">
        ‚öôÔ∏è Columnas
      </summary>

      <div id="columnToggles" class="absolute left-0 mt-1 w-72 bg-white border rounded-xl shadow-lg p-3 z-10">
        <p class="text-xs text-gray-500 mb-2">Mostrar / ocultar columnas</p>

        <label class="flex items-center gap-2 mb-2 pb-2 border-b">
          <input type="checkbox" id="col-toggle-all" checked>
          <span class="font-semibold text-xs">Mostrar todas</span>
        </label>

        <div class="space-y-1 text-sm">
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="0" checked><span>Nombre</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="1" checked><span>Fecha</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="2" checked><span>Fecha real del gasto</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="3" checked><span>Proyecto</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="4" checked><span>Monto</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="5" checked><span>Tipo</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="6" checked><span>Veh√≠culo (Flota)</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="7" checked><span>Tipo Servicio (Flota)</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="8" checked><span>Fecha/Hora Servicio</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="9" checked><span>KM Servicio</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="10" checked><span>Servicio Flota</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="11" checked><span>Observaciones</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="12" checked><span>Comprobante</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="13" checked><span>Estado</span></label>
          <label class="flex items-center gap-2"><input type="checkbox" class="col-toggle" data-col="14" checked><span>Acciones</span></label>
        </div>
      </div>
    </details>
  </div>

  <!-- Bot√≥n limpiar filtros Excel -->
  <div class="flex justify-start mb-2">
    <button type="button"
            id="btnExcelClearAll"
            class="px-3 py-1 text-xs border rounded-full bg-white hover:bg-blue-50">
      ‚ùå Limpiar filtros
    </button>
  </div>

  <!-- Zona con valores globales para filtros Excel -->
  <div id="rendicionesZone" data-excel-global='{{ excel_global_json|safe }}'>

    <!-- Tabla responsive -->
    <div class="overflow-x-auto">
      <table id="tabla-rendiciones"
             class="table-auto w-full text-sm min-w-full sm:min-w-[1400px]"
             style="white-space: nowrap;"
             data-columns-table="rendiciones">

        <thead class="bg-gray-100 text-gray-800 font-semibold text-center">
          <tr>
            <th class="p-2 border" data-excel-col>
              <button type="button" class="excel-header-btn flex items-center gap-1">
                <span>Nombre</span><span class="excel-arrow text-gray-500">‚ñº</span>
              </button>
            </th>

            <th class="p-2 border" data-excel-col>
              <button type="button" class="excel-header-btn flex items-center gap-1">
                <span>Fecha</span><span class="excel-arrow text-gray-500">‚ñº</span>
              </button>
            </th>

            <th class="p-2 border" data-excel-col>
              <button type="button" class="excel-header-btn flex items-center gap-1">
                <span>Fecha real del gasto</span><span class="excel-arrow text-gray-500">‚ñº</span>
              </button>
            </th>

            <th class="p-2 border" data-excel-col>
              <button type="button" class="excel-header-btn flex items-center gap-1">
                <span>Proyecto</span><span class="excel-arrow text-gray-500">‚ñº</span>
              </button>
            </th>

            <th class="p-2 border text-right" data-excel-col>
              <button type="button" class="excel-header-btn flex items-center gap-1">
                <span>Monto</span><span class="excel-arrow text-gray-500">‚ñº</span>
              </button>
            </th>

            <th class="p-2 border" data-excel-col>
              <button type="button" class="excel-header-btn flex items-center gap-1">
                <span>Tipo</span><span class="excel-arrow text-gray-500">‚ñº</span>
              </button>
            </th>

            <th class="p-2 border" data-excel-col>
              <button type="button" class="excel-header-btn flex items-center gap-1">
                <span>Veh√≠culo (Flota)</span><span class="excel-arrow text-gray-500">‚ñº</span>
              </button>
            </th>

            <th class="p-2 border" data-excel-col>
              <button type="button" class="excel-header-btn flex items-center gap-1">
                <span>Tipo Servicio (Flota)</span><span class="excel-arrow text-gray-500">‚ñº</span>
              </button>
            </th>

            <th class="p-2 border" data-excel-col>
              <button type="button" class="excel-header-btn flex items-center gap-1">
                <span>Fecha/Hora Servicio</span><span class="excel-arrow text-gray-500">‚ñº</span>
              </button>
            </th>

            <th class="p-2 border text-right" data-excel-col>
              <button type="button" class="excel-header-btn flex items-center gap-1">
                <span>KM Servicio</span><span class="excel-arrow text-gray-500">‚ñº</span>
              </button>
            </th>

            <th class="p-2 border" data-excel-col>
              <button type="button" class="excel-header-btn flex items-center gap-1">
                <span>Servicio Flota</span><span class="excel-arrow text-gray-500">‚ñº</span>
              </button>
            </th>

            <th class="p-2 border" data-excel-col>
              <button type="button" class="excel-header-btn flex items-center gap-1">
                <span>Observaciones</span><span class="excel-arrow text-gray-500">‚ñº</span>
              </button>
            </th>

            <th class="p-2 border" data-excel-col>
              <button type="button" class="excel-header-btn flex items-center gap-1">
                <span>Comprobante</span><span class="excel-arrow text-gray-500">‚ñº</span>
              </button>
            </th>

            <th class="p-2 border" data-excel-col>
              <button type="button" class="excel-header-btn flex items-center gap-1">
                <span>Estado</span><span class="excel-arrow text-gray-500">‚ñº</span>
              </button>
            </th>

            <th class="p-2 border">Acciones</th>
          </tr>
        </thead>

        <tbody class="text-center">
          {% for mov in pagina %}
          <tr class="border-t align-top">
            <!-- 0 Nombre -->
            <td class="p-2 border" data-excel-value="{{ mov.usuario.get_full_name|default:'‚Äî' }}">
              {{ mov.usuario.get_full_name }}
            </td>

            <!-- 1 Fecha -->
            <td class="p-2 border" data-excel-value="{{ mov.fecha|date:'d-m-Y' }}">
              {{ mov.fecha|date:"d-m-Y" }}
            </td>

            <!-- 2 Fecha real del gasto -->
            <td class="p-2 border"
                data-excel-value="{% if mov.fecha_transaccion %}{{ mov.fecha_transaccion|date:'d-m-Y' }}{% else %}{{ mov.fecha|date:'d-m-Y' }}{% endif %}">
              {% if mov.fecha_transaccion %}
                {{ mov.fecha_transaccion|date:"d-m-Y" }}
              {% else %}
                {{ mov.fecha|date:"d-m-Y" }}
              {% endif %}
            </td>

            <!-- 3 Proyecto -->
            <td class="p-2 border" data-excel-value="{{ mov.proyecto|default:'‚Äî' }}">
              {{ mov.proyecto }}
            </td>

            <!-- 4 Monto -->
            <td class="p-2 border text-right"
                data-excel-value="${{ mov.cargos|default:0|floatformat:0|formato_clp }}">
              ${{ mov.cargos|default:0|floatformat:0|formato_clp }}
            </td>

            <!-- 5 Tipo -->
            <td class="p-2 border" data-excel-value="{{ mov.tipo|default:'‚Äî' }}">
              {{ mov.tipo }}
            </td>

            <!-- 6 Veh√≠culo -->
            <td class="p-2 border"
                data-excel-value="{% if mov.vehiculo_flota %}{{ mov.vehiculo_flota.patente }}{% if mov.vehiculo_flota.marca %} ¬∑ {{ mov.vehiculo_flota.marca }} {{ mov.vehiculo_flota.modelo }}{% endif %}{% else %}‚Äî{% endif %}">
              {% if mov.vehiculo_flota %}
                {{ mov.vehiculo_flota.patente }}{% if mov.vehiculo_flota.marca %} ¬∑ {{ mov.vehiculo_flota.marca }} {{ mov.vehiculo_flota.modelo }}{% endif %}
              {% else %}
                ‚Äî
              {% endif %}
            </td>

            <!-- 7 Tipo servicio flota -->
            <td class="p-2 border" data-excel-value="{{ mov.tipo_servicio_flota_nombre|default:'‚Äî' }}">
              {{ mov.tipo_servicio_flota_nombre|default:"‚Äî" }}
            </td>

            <!-- 8 Fecha/Hora servicio -->
            <td class="p-2 border"
                data-excel-value="{% if mov.fecha_servicio_flota %}{{ mov.fecha_servicio_flota|date:'d-m-Y' }}{% if mov.hora_servicio_flota %} {{ mov.hora_servicio_flota|time:'h:i a' }}{% endif %}{% else %}‚Äî{% endif %}">
              {% if mov.fecha_servicio_flota %}
                {{ mov.fecha_servicio_flota|date:"d-m-Y" }}
                {% if mov.hora_servicio_flota %}
                  <br><span class="text-xs text-gray-500">{{ mov.hora_servicio_flota|time:"h:i a" }}</span>
                {% endif %}
              {% else %}
                ‚Äî
              {% endif %}
            </td>

            <!-- 9 KM -->
            <td class="p-2 border text-right"
                data-excel-value="{% if mov.kilometraje_servicio_flota %}{{ mov.kilometraje_servicio_flota|miles }} KM{% else %}‚Äî{% endif %}">
              {% if mov.kilometraje_servicio_flota %}
                {{ mov.kilometraje_servicio_flota|miles }} KM
              {% else %}
                ‚Äî
              {% endif %}
            </td>

            <!-- 10 Servicio flota -->
            <td class="p-2 border"
                data-excel-value="{% if mov.servicio_flota %}#{{ mov.servicio_flota.service_code|default:mov.servicio_flota.id }}{% else %}‚Äî{% endif %}">
              {% if mov.servicio_flota %}
                #{{ mov.servicio_flota.service_code|default:mov.servicio_flota.id }}
              {% else %}
                ‚Äî
              {% endif %}
            </td>

            <!-- 11 Observaciones -->
            <td class="p-2 border" data-excel-value="{{ mov.observaciones|default:'‚Äî' }}">
              {{ mov.observaciones|default:"‚Äî" }}
            </td>

            <!-- 12 Comprobante -->
            <td class="p-2 border" data-excel-value="{% if mov.comprobante %}Ver{% else %}‚Äî{% endif %}">
              {% if mov.comprobante %}
                <a href="{{ mov.comprobante.url }}" target="_blank" class="text-blue-600 underline">Ver</a>
              {% else %}
                ‚Äî
              {% endif %}
            </td>

            <!-- 13 Estado -->
            <td class="p-2 text-sm"
                data-excel-value="{% if mov.status == 'pendiente_supervisor' %}Pendiente aprobaci√≥n del Supervisor{% elif mov.status == 'aprobado_supervisor' %}Pendiente aprobaci√≥n del PM{% elif mov.status == 'rechazado_supervisor' %}Rechazado por Supervisor{% elif mov.status == 'aprobado_pm' %}Pendiente aprobaci√≥n de Finanzas{% elif mov.status == 'rechazado_pm' %}Rechazado por PM{% elif mov.status == 'aprobado_finanzas' %}Aprobado por Finanzas{% elif mov.status == 'rechazado_finanzas' %}Rechazado por Finanzas{% elif mov.status == 'pendiente_abono_usuario' %}Pendiente aprobaci√≥n del Usuario{% elif mov.status == 'aprobado_abono_usuario' %}Abono aprobado por Usuario{% elif mov.status == 'rechazado_abono_usuario' %}Abono rechazado por Usuario{% else %}{{ mov.get_status_display }}{% endif %}">
              <div class="flex flex-col gap-1 text-left leading-tight">
                {% if mov.status == 'pendiente_supervisor' %}
                  <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                    ‚è≥ Pendiente aprobaci√≥n del Supervisor
                  </span>

                {% elif mov.status == 'aprobado_supervisor' %}
                  <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                    ‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br>
                    ‚è≥ Pendiente aprobaci√≥n del PM
                  </span>

                {% elif mov.status == 'rechazado_supervisor' %}
                  <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                    ‚ùå Rechazado por Supervisor
                  </span>

                {% elif mov.status == 'aprobado_pm' %}
                  <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                    ‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br>
                    ‚úÖ PM: {{ mov.aprobado_por_pm.get_full_name }} <br>
                    ‚è≥ Pendiente aprobaci√≥n de Finanzas
                  </span>

                {% elif mov.status == 'rechazado_pm' %}
                  <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                    ‚ùå Rechazado por PM
                  </span>

                {% elif mov.status == 'aprobado_finanzas' %}
                  <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">
                    ‚úÖ Supervisor: {{ mov.aprobado_por_supervisor.get_full_name }} <br>
                    ‚úÖ PM: {{ mov.aprobado_por_pm.get_full_name }} <br>
                    ‚úÖ Finanzas: {{ mov.aprobado_por_finanzas.get_full_name }}
                  </span>

                {% elif mov.status == 'rechazado_finanzas' %}
                  <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                    ‚ùå Rechazado por Finanzas
                  </span>

                {% elif mov.status == 'pendiente_abono_usuario' %}
                  <span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full font-medium">
                    ‚è≥ Pendiente aprobaci√≥n del Usuario
                  </span>

                {% elif mov.status == 'aprobado_abono_usuario' %}
                  <span class="inline-block bg-green-100 text-green-800 px-2 py-1 rounded-full font-medium">
                    ‚úÖ Abono aprobado por Usuario
                  </span>

                {% elif mov.status == 'rechazado_abono_usuario' %}
                  <span class="inline-block bg-red-100 text-red-800 px-2 py-1 rounded-full font-medium">
                    ‚ùå Abono rechazado por Usuario
                  </span>

                {% else %}
                  {{ mov.get_status_display }}
                {% endif %}

                {% if 'rechazado' in mov.status and mov.motivo_rechazo %}
                  <div class="mt-1 text-xs text-red-700 whitespace-pre-wrap break-words editable-motivo"
                       style="word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap; max-width: 100%;">
                    <strong>Motivo:</strong> <span class="motivo-text">{{ mov.motivo_rechazo }}</span>
                  </div>
                {% endif %}
              </div>
            </td>

            <!-- 14 Acciones -->
            <td class="p-2 border text-center">
              {% if not mov.tipo or mov.tipo.categoria != 'abono' %}
                {% if user.es_supervisor and mov.status == "pendiente_supervisor" %}
                  <form action="{% url 'operaciones:aprobar_rendicion' mov.id %}" method="post" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200">
                      ‚úÖ Aprobar
                    </button>
                  </form>
                  <button onclick="abrirModalRechazo({{ mov.id }})" class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200">
                    ‚ùå Rechazar
                  </button>
                {% endif %}

                {% if user.es_pm and mov.status == "aprobado_supervisor" %}
                  <form action="{% url 'operaciones:aprobar_rendicion' mov.id %}" method="post" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200">
                      ‚úÖ Aprobar
                    </button>
                  </form>
                  <button onclick="abrirModalRechazo({{ mov.id }})" class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200">
                    ‚ùå Rechazar
                  </button>
                {% endif %}

                {% if user.es_facturacion and mov.status == "aprobado_pm" %}
                  <form action="{% url 'operaciones:aprobar_rendicion' mov.id %}" method="post" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200">
                      ‚úÖ Aprobar
                    </button>
                  </form>
                  <button onclick="abrirModalRechazo({{ mov.id }})" class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200">
                    ‚ùå Rechazar
                  </button>
                {% endif %}

                {% if mov.status == 'pendiente_abono_usuario' and mov.usuario == user %}
                  <form action="{% url 'operaciones:aprobar_rendicion' mov.id %}" method="post" class="inline">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-green-200">
                      ‚úÖ Aprobar
                    </button>
                  </form>
                  <button onclick="abrirModalRechazo({{ mov.id }})" class="inline-block bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold hover:bg-red-200">
                    ‚ùå Rechazar
                  </button>
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr data-empty-row="1">
            <td colspan="15" class="p-4 text-center text-gray-500">No hay rendiciones disponibles.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Modal Rechazo -->
    <div id="modalRechazo" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
      <div class="bg-white p-6 rounded-lg shadow-lg w-96">
        <h2 class="text-lg font-bold mb-4">Rechazar Rendici√≥n</h2>
        <form id="formRechazo" method="post">
          {% csrf_token %}
          <textarea name="motivo_rechazo" rows="3" class="w-full border rounded-lg p-2" placeholder="Ingrese el motivo del rechazo"></textarea>

          <div class="mt-4 flex justify-end gap-2">
            <button type="button" onclick="cerrarModalRechazo()" class="px-3 py-1 bg-gray-200 rounded">Cancelar</button>
            <button type="submit" class="px-3 py-1 bg-red-600 text-white rounded">Rechazar</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      function abrirModalRechazo(id) {
        const next = encodeURIComponent(location.pathname + location.search);
        document.getElementById('formRechazo').action =
          `/operaciones/rendiciones/rechazar/${id}/?next=${next}`;
        document.getElementById('modalRechazo').classList.remove('hidden');
      }
      function cerrarModalRechazo() {
        document.getElementById('modalRechazo').classList.add('hidden');
      }
    </script>

    <!-- Paginaci√≥n -->
    <div class="mt-4 flex flex-wrap justify-between items-center text-sm">
      <form method="get" class="flex items-center gap-2">
        <label for="cantidad" class="text-sm font-medium text-gray-700">Mostrar:</label>
        <select name="cantidad" id="cantidad" onchange="this.form.submit()" class="border rounded-lg px-3 py-1">
          <option value="5" {% if cantidad == '5' %}selected{% endif %}>5</option>
          <option value="10" {% if cantidad == '10' %}selected{% endif %}>10</option>
          <option value="20" {% if cantidad == '20' %}selected{% endif %}>20</option>
          <option value="50" {% if cantidad == '50' %}selected{% endif %}>50</option>
          <option value="100" {% if cantidad == '100' %}selected{% endif %}>100</option>
        </select>

        {% if excel_filters_raw %}
          <input type="hidden" name="excel_filters" value="{{ excel_filters_raw|escape }}">
        {% endif %}
      </form>
    </div>

    <div class="mt-2 flex justify-center text-sm">
      {% if cantidad == 'todos' %}
        <span>P√°gina 1 de 1</span>
      {% else %}
        <span class="px-3 py-1">P√°gina {{ pagina.number }} de {{ pagina.paginator.num_pages }}</span>
      {% endif %}
    </div>

    <div class="mt-2 flex justify-center gap-2 text-sm">
      {% if pagina.has_previous %}
        <a href="?page=1&cantidad={{ cantidad }}{% if excel_filters_raw %}&excel_filters={{ excel_filters_raw|urlencode }}{% endif %}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">¬´ Primero</a>
        <a href="?page={{ pagina.previous_page_number }}&cantidad={{ cantidad }}{% if excel_filters_raw %}&excel_filters={{ excel_filters_raw|urlencode }}{% endif %}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">‚Äπ Anterior</a>
      {% endif %}
      {% if pagina.has_next %}
        <a href="?page={{ pagina.next_page_number }}&cantidad={{ cantidad }}{% if excel_filters_raw %}&excel_filters={{ excel_filters_raw|urlencode }}{% endif %}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Siguiente ‚Ä∫</a>
        <a href="?page={{ pagina.paginator.num_pages }}&cantidad={{ cantidad }}{% if excel_filters_raw %}&excel_filters={{ excel_filters_raw|urlencode }}{% endif %}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">√öltimo ¬ª</a>
      {% endif %}
    </div>

  </div> <!-- /#rendicionesZone -->
</div>

<!-- Panel flotante tipo Excel -->
<div id="excelFilterPanel" class="excel-panel hidden">
  <h3 id="excelPanelTitle">Columna</h3>
  <small>Filtrar valores</small>

  <div class="mt-2">
    <input id="excelFilterSearch"
           type="text"
           placeholder="Buscar..."
           class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs">
  </div>

  <div class="mt-2 excel-options" id="excelFilterOptions"></div>

  <div class="mt-3 flex justify-end gap-2">
    <button type="button"
            id="excelFilterClearAll"
            class="px-2 py-1 border rounded-md text-xs">
      Limpiar
    </button>
    <button type="button"
            id="excelFilterApply"
            class="px-2 py-1 bg-blue-600 text-white rounded-md text-xs">
      Aplicar
    </button>
  </div>
</div>

<script>
/* === Conservar scroll en "Rendiciones" === */
(function () {
  const KEY = 'rendiciones-scroll:' + location.pathname;

  function zone() {
    return document.querySelector('.overflow-x-auto');
  }

  function saveScroll() {
    try {
      const z = zone();
      sessionStorage.setItem(KEY, JSON.stringify({
        winX: window.scrollX || window.pageXOffset || 0,
        winY: window.scrollY || window.pageYOffset || 0,
        zoneX: z ? z.scrollLeft : 0,
        zoneY: z ? z.scrollTop  : 0
      }));
    } catch (_) {}
  }

  function restoreScroll() {
    try {
      const s = JSON.parse(sessionStorage.getItem(KEY) || 'null');
      if (!s) return;
      requestAnimationFrame(() => window.scrollTo(s.winX || 0, s.winY || 0));
      const z = zone();
      if (z) {
        z.scrollLeft = s.zoneX || 0;
        z.scrollTop  = s.zoneY || 0;
      }
    } catch (_) {}
  }

  document.addEventListener('DOMContentLoaded', restoreScroll);
  window.addEventListener('pageshow', (e) => { if (e.persisted) restoreScroll(); });
  window.addEventListener('beforeunload', saveScroll);

  document.addEventListener('submit', (e) => {
    if (e.target && e.target.matches('form')) saveScroll();
  });

  document.addEventListener('change', (e) => {
    if (e.target && e.target.matches('select#cantidad')) saveScroll();
  });

  document.addEventListener('click', (e) => {
    const a = e.target.closest('a[href*="page="]');
    if (a) saveScroll();
  });
})();
</script>

<script>
/* === Mostrar/Ocultar columnas === */
(function () {
  const panel = document.getElementById('columnToggles');
  if (!panel) return;

  const table =
    document.querySelector('[data-columns-table]') ||
    document.querySelector('table');
  if (!table) return;

  const tableId = table.dataset.columnsTable || location.pathname;
  const STORAGE_KEY = 'cols:' + tableId;

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return {};
      const obj = JSON.parse(raw);
      return obj && typeof obj === 'object' ? obj : {};
    } catch (e) {
      return {};
    }
  }

  function saveState(state) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {}
  }

  function applyVisibility() {
    const state = loadState();

    const theadCells = table.querySelectorAll('thead tr th');
    theadCells.forEach((th, idx) => {
      const visible = state[idx] !== false;
      th.style.display = visible ? '' : 'none';
    });

    table.querySelectorAll('tbody tr').forEach((tr) => {
      const tds = tr.querySelectorAll('td');
      tds.forEach((td, idx) => {
        const visible = state[idx] !== false;
        td.style.display = visible ? '' : 'none';
      });
    });

    const checks = panel.querySelectorAll('.col-toggle');
    const master = panel.querySelector('#col-toggle-all');
    let allOn = true;

    checks.forEach((cb) => {
      const idx = parseInt(cb.dataset.col || '0', 10);
      const visible = state[idx] !== false;
      cb.checked = visible;
      if (!visible) allOn = false;
    });

    if (master) master.checked = allOn;
  }

  function bindToggles() {
    const checks = panel.querySelectorAll('.col-toggle');
    const master = panel.querySelector('#col-toggle-all');

    checks.forEach((cb) => {
      cb.addEventListener('change', () => {
        const idx = parseInt(cb.dataset.col || '0', 10);
        const state = loadState();
        state[idx] = cb.checked;
        saveState(state);
        applyVisibility();
      });
    });

    if (master) {
      master.addEventListener('change', () => {
        const val = master.checked;
        const state = loadState();

        checks.forEach((cb) => {
          const idx = parseInt(cb.dataset.col || '0', 10);
          cb.checked = val;
          state[idx] = val;
        });

        saveState(state);
        applyVisibility();
      });
    }
  }

  function bindOutsideClickToClose() {
    const details = panel.closest('details');
    if (!details) return;

    document.addEventListener('click', (e) => {
      if (!details.open) return;
      if (details.contains(e.target)) return;
      details.open = false;
    });
  }

  bindToggles();
  applyVisibility();
  bindOutsideClickToClose();
})();
</script>

<script>
/* === Filtros tipo Excel (GLOBAL + backend) === */
(function(){
  const zona = document.getElementById('rendicionesZone');
  if(!zona) return;

  function loadExcelGlobalFromZona(){
    try{
      const raw = zona.dataset.excelGlobal || '{}';
      return JSON.parse(raw);
    }catch(_){
      return {};
    }
  }

  function loadActiveFiltersFromUrl(){
    const params = new URLSearchParams(location.search);
    const raw = params.get('excel_filters');
    if(!raw) return {};
    try{
      const obj = JSON.parse(raw);
      const out = {};
      Object.entries(obj || {}).forEach(([k, arr]) => {
        if (Array.isArray(arr)) out[k] = new Set(arr.map(String));
      });
      return out;
    }catch(_){
      return {};
    }
  }

  function saveActiveFiltersToUrl(activeFilters){
    const plain = {};
    Object.entries(activeFilters).forEach(([k, set]) => {
      if (set && set.size) plain[k] = Array.from(set);
    });

    const params = new URLSearchParams(location.search);
    params.delete('page'); // reinicia paginaci√≥n
    if (Object.keys(plain).length){
      params.set('excel_filters', JSON.stringify(plain));
    }else{
      params.delete('excel_filters');
    }
    location.href = location.pathname + '?' + params.toString();
  }

  const excel = {
    panel: document.getElementById('excelFilterPanel'),
    titleEl: document.getElementById('excelPanelTitle'),
    searchInput: document.getElementById('excelFilterSearch'),
    optsBox: document.getElementById('excelFilterOptions'),
    btnApply: document.getElementById('excelFilterApply'),
    btnClearCol: document.getElementById('excelFilterClearAll'),
    btnClearAllGlobal: document.getElementById('btnExcelClearAll'),
    table: document.getElementById('tabla-rendiciones'),
    headers: [],
    distinctValues: loadExcelGlobalFromZona(), // ‚úÖ globales del queryset
    activeFilters: loadActiveFiltersFromUrl(),
    currentColIndex: null,
  };

  if(!excel.table || !excel.panel) return;
  excel.headers = Array.from(excel.table.querySelectorAll('thead th'));

  function excelUpdateHeaderStates(){
    excel.headers.forEach((th, idx)=>{
      if(!th.hasAttribute('data-excel-col')) return;
      const hasFilter = !!(excel.activeFilters[idx] && excel.activeFilters[idx].size > 0);
      th.classList.toggle('excel-col-filtered', hasFilter);
    });
  }

  function excelFilterOptionList(query){
    const q = (query || '').trim().toLowerCase();
    let visible = 0;

    excel.optsBox.querySelectorAll('label[data-option-label]').forEach(lbl=>{
      const text = (lbl.dataset.optionText || lbl.textContent || '').toLowerCase();
      const show = text.includes(q);
      lbl.style.display = show ? '' : 'none';
      if(show) visible++;
    });

    let msg = excel.optsBox.querySelector('[data-no-match="1"]');
    if(!msg){
      msg = document.createElement('div');
      msg.dataset.noMatch = "1";
      msg.className = "mt-2 text-xs text-gray-500";
      msg.textContent = "No hay resultados.";
      excel.optsBox.appendChild(msg);
    }
    msg.style.display = (q && visible === 0) ? '' : 'none';
  }

  function excelRenderOptions(colIndex){
    excel.optsBox.innerHTML = '';

    const values = Array.isArray(excel.distinctValues[String(colIndex)])
      ? excel.distinctValues[String(colIndex)].slice()
      : [];

    values.sort((a,b)=>String(a).localeCompare(String(b), 'es', {sensitivity:'base'}));

    const selected = excel.activeFilters[colIndex];

    // Select all
    const allLabel = document.createElement('label');
    allLabel.className = 'flex items-center gap-1 mb-1 text-xs';
    const allCb = document.createElement('input');
    allCb.type = 'checkbox';
    allCb.dataset.selectAll = '1';
    allCb.checked = !selected || selected.size === values.length;

    allCb.addEventListener('change', ()=>{
      const q = (excel.searchInput?.value || '').trim().toLowerCase();
      const onlyVisible = !!q;

      const optionLabels = excel.optsBox.querySelectorAll('label[data-option-label]');
      optionLabels.forEach(lbl=>{
        if (onlyVisible && lbl.style.display === 'none') return;
        const cb = lbl.querySelector('input[type="checkbox"][data-value]');
        if(cb) cb.checked = allCb.checked;
      });
    });

    allLabel.appendChild(allCb);
    allLabel.appendChild(document.createTextNode(' (Seleccionar todo)'));
    excel.optsBox.appendChild(allLabel);

    // Opciones
    values.forEach(val=>{
      const label = document.createElement('label');
      label.className = 'flex items-center gap-1 text-xs mt-0.5';
      label.dataset.optionLabel = '1';
      label.dataset.optionText = String(val);

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.value = String(val);
      cb.checked = !selected || selected.has(String(val));

      label.appendChild(cb);
      label.appendChild(document.createTextNode(' ' + String(val)));
      excel.optsBox.appendChild(label);
    });
  }

  function excelOpenForHeader(th){
    excel.currentColIndex = parseInt(th.dataset.excelIndex, 10);
    excel.titleEl.textContent = th.innerText.trim();

    excelRenderOptions(excel.currentColIndex);

    const rect = th.getBoundingClientRect();
    const panelWidth  = 300;
    let left = rect.left + (rect.width - panelWidth) / 2;
    let top  = rect.bottom + 4;

    const minLeft = 8;
    const maxLeft = window.innerWidth - panelWidth - 8;
    if (left < minLeft) left = minLeft;
    if (left > maxLeft) left = maxLeft;

    excel.panel.style.left = left + 'px';
    excel.panel.style.top  = top + 'px';

    excel.panel.classList.remove('hidden');
    excel.searchInput.value = '';
    excelFilterOptionList('');
    excel.searchInput.focus();
  }

  // Bind headers
  excel.headers.forEach((th, idx)=>{
    if(th.hasAttribute('data-excel-col')){
      th.dataset.excelIndex = idx;
      const btn = th.querySelector('.excel-header-btn');
      if(btn){
        btn.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          excelOpenForHeader(th);
        });
      }
    }
  });

  // Buscador interno panel
  excel.searchInput.addEventListener('input', ()=>{
    excelFilterOptionList(excel.searchInput.value);
  });

  excel.searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      excel.btnApply.click();
    }
    if (e.key === 'Escape') {
      e.preventDefault();
      excel.panel.classList.add('hidden');
    }
  });

  // Limpiar solo columna actual
  excel.btnClearCol.addEventListener('click', (e)=>{
    e.preventDefault();
    if (excel.currentColIndex == null) return;
    delete excel.activeFilters[excel.currentColIndex];
    saveActiveFiltersToUrl(excel.activeFilters);
  });

  // Aplicar (backend)
  excel.btnApply.addEventListener('click', ()=>{
    if(excel.currentColIndex == null){
      excel.panel.classList.add('hidden');
      return;
    }

    const q = (excel.searchInput?.value || '').trim().toLowerCase();
    let chosenCheckboxes = [];

    if(q){
      const visibleLabels = Array.from(excel.optsBox.querySelectorAll('label[data-option-label]'))
        .filter(lbl => lbl.style.display !== 'none');

      chosenCheckboxes = visibleLabels
        .map(lbl => lbl.querySelector('input[type="checkbox"][data-value]'))
        .filter(Boolean);
    }else{
      chosenCheckboxes = Array.from(excel.optsBox.querySelectorAll('input[type="checkbox"][data-value]'));
    }

    const selected = new Set();
    chosenCheckboxes.forEach(cb => {
      if(cb.checked) selected.add(String(cb.dataset.value));
    });

    const allValues = Array.isArray(excel.distinctValues[String(excel.currentColIndex)])
      ? excel.distinctValues[String(excel.currentColIndex)]
      : [];

    if (selected.size === 0 || selected.size === allValues.length){
      delete excel.activeFilters[excel.currentColIndex];
    } else {
      excel.activeFilters[excel.currentColIndex] = selected;
    }

    saveActiveFiltersToUrl(excel.activeFilters);
  });

  // Limpiar todos (global)
  if (excel.btnClearAllGlobal){
    excel.btnClearAllGlobal.addEventListener('click', (e)=>{
      e.preventDefault();
      excel.activeFilters = {};
      saveActiveFiltersToUrl(excel.activeFilters);
    });
  }

  // Cerrar panel click afuera
  document.addEventListener('click', (e)=>{
    if(excel.panel.classList.contains('hidden')) return;
    if(excel.panel.contains(e.target)) return;
    if(e.target.closest('.excel-header-btn')) return;
    excel.panel.classList.add('hidden');
  });

  // Marcar columnas filtradas al cargar
  excelUpdateHeaderStates();
})();
</script>

{% endblock %}