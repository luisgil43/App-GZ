{% extends "dashboard/base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Mi Producci√≥n{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto bg-white p-4 sm:p-6 rounded-2xl shadow mt-6">

  <!-- Header: Mes actual + Total del mes (CLP) + Bot√≥n Mis pagos -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
    <h1 class="text-2xl font-bold">üë∑‚Äç‚ôÇÔ∏è Mi Producci√≥n</h1>

    <div class="flex items-center gap-3">
      <div class="text-sm text-gray-600">
        Mes actual: <b>{{ current_month_label|default:"‚Äî" }}</b>
        ¬∑ Total del mes (CLP):
        <b>$ {{ total_current_month|default:0|formato_clp }}</b>
      </div>

      <a href="{% url 'operaciones:user_monthly_payments' %}"
         class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
        üí≥ <span>Mis pagos</span>
      </a>
    </div>
  </div>

  <!-- Filtros -->
  <form id="filtros" class="mb-3 grid grid-cols-1 sm:grid-cols-3 gap-2" method="get" onsubmit="return false;">
    <input type="text" name="id_claro" value="{{ id_claro }}" placeholder="ID CLARO / ID NEW / Texto proyecto"
           class="border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
    <input type="text" name="mes_produccion" value="{{ mes_produccion }}" placeholder="Mes producci√≥n (YYYY-MM o 'Mes A√±o')"
           class="border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
    <div class="flex items-center gap-2">
      <a href="{% url 'operaciones:produccion_tecnico' %}"
         class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm">Limpiar</a>
    </div>
  </form>

  <div class="rounded-xl border border-gray-200 overflow-x-auto">
    <table class="table-auto text-sm w-full min-w-[1100px]" style="white-space: nowrap;">
      <thead class="bg-gray-100">
        <tr>
          <th class="w-10"></th>
          <th class="p-2 text-left">DU</th>
          <th class="p-2 text-left">ID CLARO</th>
          <th class="p-2 text-left">ID NEW</th>
          <th class="p-2 text-left">Regi√≥n</th>
          <th class="p-2 text-left">Mes producci√≥n</th>
          <th class="p-2 text-left">Estado</th>
          <th class="p-2 text-right">Mi total</th>
        </tr>
      </thead>
      <tbody>
        {% for r in pagina %}
        <tr class="border-t align-top">
          <td class="p-2 text-center">
            <button type="button"
                    class="btn-toggle inline-flex w-7 h-7 items-center justify-center rounded hover:bg-gray-100"
                    data-target="det-{{ forloop.counter }}" aria-expanded="false">
              <svg class="chev w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M6.293 7.293a1 1 0 011.414 0L10 9.586l2.293-2.293a1 1 0 111.414 1.414L10 12.414 6.293 8.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
            </button>
          </td>
          <td class="p-2">DU{{ r.du }}</td>
          <td class="p-2">{{ r.id_claro }}</td>
          <td class="p-2">{{ r.id_new }}</td>
          <td class="p-2">{{ r.region }}</td>
          <td class="p-2">{{ r.mes_produccion }}</td>

          <!-- Estado real con mismo estilo de badges que el ejemplo admin -->
         <td class="p-2 text-sm">
  <div class="inline-block px-3 py-1 rounded-full text-xs font-medium
    {% if r.estado == 'aprobado_supervisor' %}bg-emerald-100 text-emerald-800
    {% elif r.estado == 'aprobado_pm' %}bg-green-100 text-green-800
    {% elif r.estado == 'aprobado_finanzas' %}bg-teal-100 text-teal-800
    {% elif r.estado == 'ajuste_bono' %}bg-blue-100 text-blue-800
    {% elif r.estado == 'ajuste_adelanto' %}bg-purple-100 text-purple-800
    {% elif r.estado == 'ajuste_descuento' %}bg-red-100 text-red-800
    {% elif r.estado == 'en_proceso' %}bg-blue-100 text-blue-800
    {% elif r.estado == 'en_revision_supervisor' %}bg-yellow-100 text-yellow-800
    {% elif r.estado == 'rechazado_supervisor' or r.estado == 'rechazado_pm' %}bg-red-100 text-red-800
    {% else %}bg-gray-100 text-gray-800{% endif %}">
    {% if r.estado == 'aprobado_supervisor' %}‚úÖ Aprobado por Supervisor
    {% elif r.estado == 'aprobado_pm' %}‚úÖ Aprobado por PM
    {% elif r.estado == 'aprobado_finanzas' %}‚úÖ Aprobado por Finanzas
    {% elif r.estado == 'ajuste_bono' %}üéÅ Bono
    {% elif r.estado == 'ajuste_adelanto' %}‚è© Adelanto
    {% elif r.estado == 'ajuste_descuento' %}‚ûñ Descuento
    {% elif r.estado == 'en_proceso' %}En proceso
    {% elif r.estado == 'en_revision_supervisor' %}En revisi√≥n de Supervisor
    {% elif r.estado == 'rechazado_supervisor' %}Rechazado por Supervisor
    {% elif r.estado == 'rechazado_pm' %}Rechazado por PM
    {% else %}{{ r.estado|default:"‚Äî" }}{% endif %}
  </div>
</td>

          <td class="p-2 text-right">$ {{ r.monto_tecnico|formato_clp }} CLP</td>
        </tr>

        <!-- Detalle simple -->
        <tr id="det-{{ forloop.counter }}" class="hidden">
          <td class="p-0"></td>
          <td colspan="7" class="bg-gray-50 p-3">
            <div class="text-xs text-gray-700">
              <b>Detalle:</b>
              <div class="mt-1 whitespace-pre-line">{{ r.detalle_tarea|default:"‚Äî" }}</div>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="p-4 text-center text-gray-500">No tienes producci√≥n aprobada.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Paginaci√≥n -->
  <div class="mt-4 flex items-center justify-between text-sm">
    <form method="get" class="flex items-center gap-2">
      <label for="cantidad" class="text-sm">Mostrar:</label>
      <select name="cantidad" id="cantidad" class="border rounded px-2 py-1">
        <option value="5" {% if cantidad == '5' %}selected{% endif %}>5</option>
        <option value="10" {% if cantidad == '10' %}selected{% endif %}>10</option>
        <option value="20" {% if cantidad == '20' %}selected{% endif %}>20</option>
        <option value="todos" {% if cantidad == 'todos' %}selected{% endif %}>Todos</option>
      </select>
      <input type="hidden" name="id_claro" value="{{ id_claro }}">
      <input type="hidden" name="mes_produccion" value="{{ mes_produccion }}">
    </form>

    <div class="flex-1 text-center">
      {% if cantidad == 'todos' %}
        <span>P√°gina 1 de 1</span>
      {% else %}
        <span>P√°gina {{ pagina.number }} de {{ pagina.paginator.num_pages }}</span>
      {% endif %}
    </div>

    <div></div>
  </div>
</div>

<!-- Interacciones -->
<script>
  // Toggle detalle
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-toggle');
    if(!btn) return;
    const id = btn.getAttribute('data-target');
    const row = document.getElementById(id);
    const chev = btn.querySelector('.chev');
    const open = !row.classList.contains('hidden');
    row.classList.toggle('hidden');
    if (chev) chev.style.transform = open ? 'rotate(0deg)' : 'rotate(90deg)';
    btn.setAttribute('aria-expanded', (!open).toString());
  });

  // Filtros autom√°ticos (debounce)
  (function(){
    const form = document.getElementById('filtros'); if(!form) return;
    let t = null;
    form.querySelectorAll('input[type="text"]').forEach(el=>{
      el.addEventListener('input', ()=>{
        clearTimeout(t);
        t = setTimeout(()=> form.submit(), 450);
      });
    });
  })();

  // Auto-submit al cambiar "Mostrar"
  document.getElementById('cantidad')?.addEventListener('change', function(){
    this.form.submit();
  });
</script>
{% endblock %}
