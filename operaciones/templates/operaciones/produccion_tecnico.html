{% extends "dashboard/base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Mi Producci√≥n{% endblock %}

{% block content %}
<div class="bg-white shadow mt-3 -mx-3 sm:mx-0 rounded-none sm:rounded-2xl px-3 py-4 sm:p-6">

  <!-- Header: Mes actual + Total del mes (CLP) + Bot√≥n Mis pagos -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
    <h1 class="text-2xl font-bold">üë∑‚Äç‚ôÇÔ∏è Mi Producci√≥n</h1>

    <div class="flex items-center gap-3">
      <div class="text-sm text-gray-600">
        Mes actual: <b>{{ current_month_label|default:"‚Äî" }}</b>
        ¬∑ Total del mes (CLP):
        <b>$ {{ total_current_month|default:0|formato_clp }}</b>
      </div>

      <a href="{% url 'operaciones:user_monthly_payments' %}"
         class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
        üí≥ <span>Mis pagos</span>
      </a>
    </div>
  </div>

  <!-- Filtros -->
  <form id="filtros" class="mb-3 grid grid-cols-1 sm:grid-cols-3 gap-2" method="get" onsubmit="return false;">
    <input type="text" name="id_claro" value="{{ id_claro }}" placeholder="ID CLARO / ID NEW / Texto proyecto"
           class="border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
    <input type="text" name="mes_produccion" value="{{ mes_produccion }}" placeholder="Mes producci√≥n (YYYY-MM o 'Mes A√±o')"
           class="border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
    <div class="flex items-center gap-2">
      <a href="{% url 'operaciones:produccion_tecnico' %}"
         class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 text-sm">Limpiar</a>
    </div>
  </form>


  <div class="flex justify-start mb-2">
  <details class="relative">
    <summary class="cursor-pointer text-sm text-gray-700 px-3 py-1 border rounded-full bg-gray-50 hover:bg-gray-100 select-none">
      ‚öôÔ∏è Columns
    </summary>

    <!-- üëá IMPORTANTE: mismo id que usa el script -->
    <div id="columnToggles" class="absolute left-0 mt-1 w-56 bg-white border rounded-xl shadow-lg p-3 z-10">
      <p class="text-xs text-gray-500 mb-2">Show / hide columns</p>

      <!-- ‚úÖ Master checkbox -->
      <label class="flex items-center gap-2 mb-2 pb-2 border-b">
        <input type="checkbox" id="col-toggle-all" checked>
        <span class="font-semibold text-xs">Show all columns</span>
      </label>

      <!-- ‚úÖ Una l√≠nea por columna (index 1‚Äì7) -->
      <div class="space-y-1 text-sm">
        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="1" checked>
          <span>DU</span>
        </label>

        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="2" checked>
          <span>ID CLARO</span>
        </label>

        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="3" checked>
          <span>ID NEW</span>
        </label>

        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="4" checked>
          <span>Regi√≥n</span>
        </label>

        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="5" checked>
          <span>Mes producci√≥n</span>
        </label>

        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="6" checked>
          <span>Estado</span>
        </label>

        <label class="flex items-center gap-2">
          <input type="checkbox" class="col-toggle" data-col="7" checked>
          <span>Mi total</span>
        </label>
      </div>
    </div>
  </details>
</div>

   <div class="overflow-x-auto">
    <table class="table-auto w-full text-sm min-w-full sm:min-w-[1200px]" style="white-space: nowrap;">
      <thead class="bg-gray-100">
        <tr>
          <th class="w-10"></th>
          <th class="p-2 text-left">DU</th>
          <th class="p-2 text-left">ID CLARO</th>
          <th class="p-2 text-left">ID NEW</th>
          <th class="p-2 text-left">Regi√≥n</th>
          <th class="p-2 text-left">Mes producci√≥n</th>
          <th class="p-2 text-left">Estado</th>
          <th class="p-2 text-right">Mi total</th>
        </tr>
      </thead>
      <tbody>
        {% for r in pagina %}
        <tr class="border-t align-top">
          <td class="p-2 text-center">
            <button type="button"
                    class="btn-toggle inline-flex w-7 h-7 items-center justify-center rounded hover:bg-gray-100"
                    data-target="det-{{ forloop.counter }}" aria-expanded="false">
              <svg class="chev w-4 h-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M6.293 7.293a1 1 0 011.414 0L10 9.586l2.293-2.293a1 1 0 111.414 1.414L10 12.414 6.293 8.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
            </button>
          </td>
          <td class="p-2">DU{{ r.du }}</td>
          <td class="p-2">{{ r.id_claro }}</td>
          <td class="p-2">{{ r.id_new }}</td>
          <td class="p-2">{{ r.region }}</td>
          <td class="p-2">{{ r.mes_produccion }}</td>

          <!-- Estado real con mismo estilo de badges que el ejemplo admin -->
         <td class="p-2 text-sm">
  <div class="inline-block px-3 py-1 rounded-full text-xs font-medium
    {% if r.estado == 'aprobado_supervisor' %}bg-emerald-100 text-emerald-800
    {% elif r.estado == 'aprobado_pm' %}bg-green-100 text-green-800
    {% elif r.estado == 'aprobado_finanzas' %}bg-teal-100 text-teal-800
    {% elif r.estado == 'ajuste_bono' %}bg-blue-100 text-blue-800
    {% elif r.estado == 'ajuste_adelanto' %}bg-purple-100 text-purple-800
    {% elif r.estado == 'ajuste_descuento' %}bg-red-100 text-red-800
    {% elif r.estado == 'en_proceso' %}bg-blue-100 text-blue-800
    {% elif r.estado == 'en_revision_supervisor' %}bg-yellow-100 text-yellow-800
    {% elif r.estado == 'rechazado_supervisor' or r.estado == 'rechazado_pm' %}bg-red-100 text-red-800
    {% else %}bg-gray-100 text-gray-800{% endif %}">
    {% if r.estado == 'aprobado_supervisor' %}‚úÖ Aprobado por Supervisor
    {% elif r.estado == 'aprobado_pm' %}‚úÖ Aprobado por PM
    {% elif r.estado == 'aprobado_finanzas' %}‚úÖ Aprobado por Finanzas
    {% elif r.estado == 'ajuste_bono' %}üéÅ Bono
    {% elif r.estado == 'ajuste_adelanto' %}‚è© Adelanto
    {% elif r.estado == 'ajuste_descuento' %}‚ûñ Descuento
    {% elif r.estado == 'en_proceso' %}En proceso
    {% elif r.estado == 'en_revision_supervisor' %}En revisi√≥n de Supervisor
    {% elif r.estado == 'rechazado_supervisor' %}Rechazado por Supervisor
    {% elif r.estado == 'rechazado_pm' %}Rechazado por PM
    {% else %}{{ r.estado|default:"‚Äî" }}{% endif %}
  </div>
</td>

          <td class="p-2 text-right">$ {{ r.monto_tecnico|formato_clp }} CLP</td>
        </tr>

       <!-- Detalle simple -->
<tr id="det-{{ forloop.counter }}" class="hidden detail-row">
  <td class="p-0"></td>
  <td colspan="7" class="bg-gray-50 p-3">
    <div class="text-xs text-gray-700">
      <b>Detalle:</b>
      <div class="mt-1 whitespace-pre-line">{{ r.detalle_tarea|default:"‚Äî" }}</div>
    </div>
  </td>
</tr>
        {% empty %}
        <tr><td colspan="8" class="p-4 text-center text-gray-500">No tienes producci√≥n aprobada.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Paginaci√≥n -->
  <div class="mt-4 flex items-center justify-between text-sm">
    <form method="get" class="flex items-center gap-2">
      <label for="cantidad" class="text-sm">Mostrar:</label>
      <select name="cantidad" id="cantidad" class="border rounded px-2 py-1">
        <option value="5"   {% if cantidad == '5' %}selected{% endif %}>5</option>
    <option value="10"  {% if cantidad == '10' %}selected{% endif %}>10</option>
    <option value="20"  {% if cantidad == '20' %}selected{% endif %}>20</option>
    <option value="50" {% if cantidad == '50' %}selected{% endif %}>50</option>
    <option value="100" {% if cantidad == '100' %}selected{% endif %}>100</option>
      </select>
      <input type="hidden" name="id_claro" value="{{ id_claro }}">
      <input type="hidden" name="mes_produccion" value="{{ mes_produccion }}">
    </form>

   <div class="mt-2 flex justify-center text-sm">
    <span>P√°gina {{ pagina.number }} de {{ pagina.paginator.num_pages }}</span>
</div>

    <div></div>
  </div>
</div>

<!-- Interacciones -->
<script>
  // Toggle detalle
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-toggle');
    if(!btn) return;
    const id = btn.getAttribute('data-target');
    const row = document.getElementById(id);
    const chev = btn.querySelector('.chev');
    const open = !row.classList.contains('hidden');
    row.classList.toggle('hidden');
    if (chev) chev.style.transform = open ? 'rotate(0deg)' : 'rotate(90deg)';
    btn.setAttribute('aria-expanded', (!open).toString());
  });

  // Filtros autom√°ticos (debounce)
  (function(){
    const form = document.getElementById('filtros'); if(!form) return;
    let t = null;
    form.querySelectorAll('input[type="text"]').forEach(el=>{
      el.addEventListener('input', ()=>{
        clearTimeout(t);
        t = setTimeout(()=> form.submit(), 450);
      });
    });
  })();

  // Auto-submit al cambiar "Mostrar"
  document.getElementById('cantidad')?.addEventListener('change', function(){
    this.form.submit();
  });
</script>

<script>
(function () {
  // Panel de columnas
  const panel = document.getElementById('columnToggles');
  if (!panel) return;

  // Tabla asociada: usa la que tenga data-columns-table
  const table =
    document.querySelector('[data-columns-table]') ||
    document.querySelector('table');
  if (!table) return;

  // Clave para recordar las columnas por vista/tabla
  const tableId = table.dataset.columnsTable || location.pathname;
  const STORAGE_KEY = 'cols:' + tableId;

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return {};
      const obj = JSON.parse(raw);
      return obj && typeof obj === 'object' ? obj : {};
    } catch (e) {
      return {};
    }
  }

  function saveState(state) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    } catch (e) {}
  }

  function applyVisibility() {
    const state = loadState(); // {0: true, 1: false, ...}

    // Encabezados
    const theadCells = table.querySelectorAll('thead tr th');
    theadCells.forEach((th, idx) => {
      const visible = state[idx] !== false; // por defecto visible
      th.style.display = visible ? '' : 'none';
    });

    // Celdas
       // Celdas
    table.querySelectorAll('tbody tr').forEach((tr) => {
      const isDetail = tr.classList.contains('detail-row');
      const tds = tr.querySelectorAll('td');

      tds.forEach((td, idx) => {
        // No aplicamos el hide por columna en las filas de detalle
        if (isDetail) {
          td.style.display = '';
          return;
        }

        const visible = state[idx] !== false; // por defecto visible
        td.style.display = visible ? '' : 'none';
      });
    });
    // Sincronizar checkboxes + master
    const checks = panel.querySelectorAll('.col-toggle');
    const master = panel.querySelector('#col-toggle-all');
    let allOn = true;

    checks.forEach((cb) => {
      const idx = parseInt(cb.dataset.col || '0', 10);
      const visible = state[idx] !== false;
      cb.checked = visible;
      if (!visible) allOn = false;
    });

    if (master) {
      master.checked = allOn;
    }
  }

  function bindToggles() {
    const checks = panel.querySelectorAll('.col-toggle');
    const master = panel.querySelector('#col-toggle-all');

    // Individuales
    checks.forEach((cb) => {
      cb.addEventListener('change', () => {
        const idx = parseInt(cb.dataset.col || '0', 10);
        const state = loadState();
        state[idx] = cb.checked;
        saveState(state);
        applyVisibility();
      });
    });

    // Master "Show all columns"
    if (master) {
      master.addEventListener('change', () => {
        const val = master.checked;
        const state = loadState();

        checks.forEach((cb) => {
          const idx = parseInt(cb.dataset.col || '0', 10);
          cb.checked = val;
          state[idx] = val;
        });

        saveState(state);
        applyVisibility();
      });
    }
  }

  // Cerrar el <details> al hacer clic fuera
  function bindOutsideClickToClose() {
    const details = panel.closest('details');
    if (!details) return;

    document.addEventListener('click', (e) => {
      if (!details.open) return;
      if (details.contains(e.target)) return;
      details.open = false;
    });
  }

  // Inicializar
  bindToggles();
  applyVisibility();
  bindOutsideClickToClose();
})();
</script>
{% endblock %}
