{% extends "dashboard_admin/base.html" %}
{% load humanize l10n %}


{% block title %}Revisión fotográfica{% endblock %}

{% block dashboard_content %}

{% with s=servicio %}
<div class="max-w-7xl mx-auto bg-white p-6 rounded-2xl shadow mt-6">

  <!-- Encabezado -->
  <div class="mb-4">
    <h1 class="text-2xl font-bold">
      🔎 Revisión — DU{{ s.du|default:"—" }} / {{ s.id_claro|default:"—" }}
    </h1>
    <div class="mt-1 text-sm text-gray-600 flex flex-wrap gap-x-4 gap-y-1 items-center">
      <span>Región: <b>{{ s.region|default:"—" }}</b></span>
      <span>Mes prod.: <b>{{ s.mes_produccion|default:"—" }}</b></span>
      <span>ID NEW: <b>{{ s.id_new|default:"—" }}</b></span>

      <span class="ml-auto mr-1 font-semibold text-gray-700">Estado:</span>
      <span class="inline-flex items-center px-2 py-0.5 rounded
        {% if s.estado == 'aprobado_supervisor' %} bg-green-100 text-green-800
        {% elif s.estado == 'rechazado_supervisor' %} bg-red-100 text-red-800
        {% elif s.estado == 'en_revision_supervisor' %} bg-amber-100 text-amber-800
        {% elif s.estado == 'en_progreso' %} bg-blue-100 text-blue-800
        {% else %} bg-gray-100 text-gray-800{% endif %}">
        {{ s.estado|default:"—" }}
      </span>
    </div>
  </div>

  <!-- Acciones -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
    <div class="flex flex-wrap gap-2">
      <a href="{% url 'operaciones:listar_servicios_supervisor' %}"
         class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded shadow inline-flex items-center gap-1">
        ⬅️ Volver
      </a>


{% if s.estado == 'en_progreso' or s.estado == 'en_revision_supervisor' or s.estado == 'rechazado_supervisor' %}
  <a href="{% url 'operaciones:generar_reporte_parcial_proyecto' s.id %}"
     class="inline-flex items-center px-4 py-2 rounded shadow bg-indigo-600 hover:bg-indigo-700 text-white">
    📸 Reporte parcial
  </a>

  <a href="{% url 'operaciones:generar_acta_preview' s.id %}"
     class="inline-flex items-center px-4 py-2 rounded shadow bg-emerald-600 hover:bg-emerald-700 text-white">
    🧾 Acta (PDF)
  </a>
{% endif %}

  
    </div>

    {% if can_review %}
      <div class="flex items-center gap-2">
        <form method="post" action=".">
          {% csrf_token %}
          <input type="hidden" name="accion" value="aprobar">
          <button type="submit"
                  class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow">
            ✅ Aprobar & generar reporte
          </button>
        </form>

        <button type="button"
                onclick="toggleRejectModal(true)"
                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded shadow">
          ❌ Rechazar
        </button>
      </div>
    {% else %}
      <div class="text-sm text-gray-500">
        Este proyecto aún no está listo para revisión del supervisor.
      </div>
    {% endif %}
  </div>

 
{% if reporte_listo %}
  {% if reporte_url or acta_url %}
    <div class="mb-6 p-3 rounded bg-blue-50 text-blue-800 text-sm flex items-center justify-between">
      <div>📄 Archivos generados para este proyecto.</div>
      <div class="flex gap-3">
        {% if reporte_url %}
          <a href="{{ reporte_url }}" target="_blank" rel="noopener" download
             class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700">Descargar reporte</a>
        {% endif %}
        {% if acta_url %}
          <a href="{{ acta_url }}" target="_blank" rel="noopener" download
             class="px-3 py-1.5 rounded bg-emerald-600 text-white hover:bg-emerald-700">Descargar acta</a>
        {% endif %}
      </div>
    </div>
  {% endif %}
{% endif %}

  <!-- Técnicos -->
  <div class="mb-4">
    <h2 class="text-sm font-semibold text-gray-800 mb-2">Técnicos</h2>
    <div class="flex flex-wrap gap-2">
      {% for asig, _evs in evidencias_por_asig %}
        <span class="inline-flex items-center gap-2 px-2 py-1 rounded bg-gray-50 border">
          {{ asig.tecnico.get_full_name|default:asig.tecnico.username }}
        </span>
      {% empty %}
        <span class="text-gray-500 text-sm">No hay técnicos asignados.</span>
      {% endfor %}
    </div>
  </div>

  <!-- Evidencias por técnico -->
  {% for asig, evs in evidencias_por_asig %}
    <section class="mb-8">
      <div class="flex items-baseline justify-between">
        <h3 class="text-lg font-semibold">
          👷 {{ asig.tecnico.get_full_name|default:asig.tecnico.username }}
        </h3>
        <div class="text-xs text-gray-500">
          Aceptado: {{ asig.aceptado_en|date:"Y-m-d H:i"|default:"—" }} ·
          Finalizado: {{ asig.finalizado_en|date:"Y-m-d H:i"|default:"—" }}
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 max-h-[70vh] overflow-auto mt-2">
     {# ...dentro del grid de evidencias... #}
{% for ev in evs %}
  <figure class="border rounded p-2 relative">
    <div class="relative rounded overflow-hidden bg-black/5">
 {% if ev.lat and ev.lng %}
  <div class="absolute top-2 left-2 z-10">
    <a target="_blank"
       href="https://www.google.com/maps?q={{ ev.lat|unlocalize }},{{ ev.lng|unlocalize }}"
       class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-emerald-600/90 text-white text-[11px] shadow">
      📍 {{ ev.lat|floatformat:5|unlocalize }}, {{ ev.lng|floatformat:5|unlocalize }}
    </a>
    {% if ev.gps_accuracy_m %}
      <span class="ml-1 px-2 py-0.5 rounded-full bg-black/60 text-white text-[10px]">
        ± {{ ev.gps_accuracy_m|floatformat:0|unlocalize }} m
      </span>
    {% endif %}
  </div>
{% endif %}


  {# Imagen completa (sin recorte) + click para abrir en pestaña nueva #}
  <a href="{{ ev.imagen.url }}" target="_blank" rel="noopener"
     class="block group">
    <div class="w-full max-h-96 grid place-items-center p-2">
      <img src="{{ ev.imagen.url }}"
           alt="Foto"
           loading="lazy"
           class="max-w-full max-h-96 h-auto w-auto object-contain rounded
                  transition-transform group-hover:scale-[1.01] cursor-zoom-in" />
    </div>
  </a>

  {# Botón X / candado tal cual lo tenías #}
  {% if request.user.is_superuser or request.user.es_supervisor %}
    {% if s.estado == 'en_revision_supervisor' or s.estado == 'en_progreso' or s.estado == 'rechazado_supervisor' %}
      <button type="button"
              class="absolute top-2 right-2 z-30 w-8 h-8 rounded-full flex items-center justify-center
                     bg-red-600/90 hover:bg-red-700 text-white text-sm shadow"
              title="Eliminar esta foto"
              data-delete
              data-action="{% url 'operaciones:fotos_borrar_evidencia_supervisor' ev.id %}">
        ✕
      </button>
    {% else %}
      <span class="absolute top-2 right-2 z-20 w-8 h-8 rounded-full bg-gray-300 text-white text-sm grid place-items-center"
            title="Bloqueado">🔒</span>
    {% endif %}
  {% else %}
    <span class="absolute top-2 right-2 z-20 w-8 h-8 rounded-full bg-gray-300 text-white text-sm grid place-items-center"
          title="Bloqueado">🔒</span>
  {% endif %}
</div>

    <figcaption class="text-xs mt-1">
      <div class="font-medium">{{ ev.requisito.titulo|default:ev.titulo_manual|default:"Extra" }}</div>
      <div>🕒 {{ ev.client_taken_at|default:ev.tomada_en|date:"Y-m-d H:i" }}</div>
      <div class="text-gray-600">
  {% if ev.lat and ev.lng %}
    📍 {{ ev.lat|floatformat:5|unlocalize }}, {{ ev.lng|floatformat:5|unlocalize }}
    <a class="ml-1 text-blue-600 hover:underline" target="_blank"
       href="https://www.google.com/maps?q={{ ev.lat|unlocalize }},{{ ev.lng|unlocalize }}">
      Abrir mapa
    </a>
    {% if ev.gps_accuracy_m %}
      <span class="ml-1 text-gray-400">± {{ ev.gps_accuracy_m|floatformat:0|unlocalize }} m</span>
    {% endif %}
  {% else %}
    <span class="text-gray-400">📍 Sin GPS</span>
  {% endif %}
</div>
      {% if ev.nota %}<div class="text-gray-600">{{ ev.nota }}</div>{% endif %}
    </figcaption>
  </figure>
{% empty %}
  <div class="text-gray-500 text-sm">Este técnico aún no tiene fotos.</div>
{% endfor %}

      </div>
    </section>
  {% empty %}
    <div class="text-gray-500">No hay evidencias para mostrar.</div>
  {% endfor %}

  <p class="mt-4 text-xs text-gray-500">
    El reporte fotográfico es <b>único por proyecto</b> y se genera/actualiza al aprobar el supervisor.
  </p>
</div>

<!-- Modal de Rechazo (centrado) -->
<div id="reject-modal" class="fixed inset-0 z-50 hidden">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/40" onclick="toggleRejectModal(false)" aria-hidden="true"></div>

  <!-- Contenedor centrado -->
  <div class="relative h-full w-full flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6">
      <div class="flex items-start justify-between">
        <h3 class="text-lg font-semibold text-red-600">Rechazar proyecto</h3>
        <button type="button" class="text-gray-400 hover:text-gray-600" onclick="toggleRejectModal(false)">✕</button>
      </div>

      <form method="post" action="." class="mt-4">
        {% csrf_token %}
        <input type="hidden" name="accion" value="rechazar">
        <label class="block text-sm font-medium text-gray-700">Motivo</label>
        <textarea name="comentario" rows="4" class="w-full border rounded-lg p-2 mt-1"
                  placeholder="Ingrese el motivo del rechazo..." required></textarea>

        <div class="mt-5 flex justify-end gap-2">
          <button type="button"
                  onclick="toggleRejectModal(false)"
                  class="px-4 py-2 rounded bg-gray-100 hover:bg-gray-200">Cancelar</button>
          <button type="submit"
                  class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Rechazar</button>
        </div>
      </form>
    </div>
  </div>
</div>  {# ← ESTE CIERRE FALTABA EN TU CÓDIGO #}

<!-- Modal eliminar evidencia (supervisor) -->
<div id="delete-modal" class="fixed inset-0 z-50 hidden">
  <!-- Backdrop -->
  <div id="delete-backdrop" class="absolute inset-0 bg-black/40" aria-hidden="true"></div>

  <!-- Contenedor centrado -->
  <div class="relative h-full w-full flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6">
      <div class="flex items-start justify-between">
        <h3 class="text-lg font-semibold text-red-600">Eliminar foto</h3>
        <button type="button" class="text-gray-400 hover:text-gray-600" id="delete-close">✕</button>
      </div>

      <p class="mt-1 text-sm text-gray-600">¿Seguro que deseas eliminar esta foto? Esta acción no se puede deshacer.</p>

      <form id="delete-form" method="post" class="mt-4">
        {% csrf_token %}
        <div class="flex justify-end gap-2">
          <button type="button" id="delete-cancel"
                  class="px-4 py-2 rounded bg-gray-100 hover:bg-gray-200">Cancelar</button>
          <button type="submit"
                  class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Eliminar</button>
       </div>
      </form>
    </div>
  </div>
</div>
{% endwith %}


<script>
  // Modal Eliminar
  document.addEventListener('DOMContentLoaded', function () {
    const modal    = document.getElementById('delete-modal');
    const form     = document.getElementById('delete-form');
    const backdrop = document.getElementById('delete-backdrop');
    const cancel   = document.getElementById('delete-cancel');
    const closeBtn = document.getElementById('delete-close');

    function openModal(actionUrl) {
      if (!form) return;
      form.setAttribute('action', actionUrl);
      modal.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
    }
    function closeModal() {
      modal.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      if (form) form.removeAttribute('action');
    }

    // Delegación: cualquier botón con data-delete abre el modal
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('[data-delete]');
      if (!btn) return;
      e.preventDefault();
      const actionUrl = btn.getAttribute('data-action');
      if (actionUrl) openModal(actionUrl);
    });

    [backdrop, cancel, closeBtn].forEach(function (el) {
      if (el) el.addEventListener('click', closeModal);
    });
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') closeModal();
    });
  });

  // Modal Rechazo (tal cual lo tenías)
  function toggleRejectModal(show) {
    const m = document.getElementById('reject-modal');
    if (!m) return;
    if (show) {
      m.classList.remove('hidden');
      setTimeout(() => {
        const ta = m.querySelector('textarea[name="comentario"]');
        if (ta) ta.focus();
      }, 50);
      document.body.classList.add('overflow-hidden');
    } else {
      m.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
    }
  }
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') toggleRejectModal(false);
  });
</script><!-- JS modal: abrir/cerrar, ESC y click afuera -->

{% endblock %}
