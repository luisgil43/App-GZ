{% extends "dashboard/base.html" %}
{% load widget_tweaks %}

{% block title %}Editar Rendici√≥n{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow mt-6">
  <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">‚úèÔ∏è Editar Rendici√≥n</h2>

  {% if form.errors %}
    <div class="bg-red-100 text-red-700 p-3 rounded mb-4">
      <ul class="list-disc pl-5">
        {% for field, errors in form.errors.items %}
          {% if field != '__all__' %}
            <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
          {% endif %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li><strong>General:</strong> {{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form id="form-editar-rendicion" method="post" enctype="multipart/form-data" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
    {% csrf_token %}

    <div>
      <label class="block text-sm font-medium text-gray-700">Proyecto:</label>
      {{ form.proyecto|add_class:"w-full border rounded-xl px-3 py-2" }}
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">Tipo rendici√≥n:</label>
      {{ form.tipo|add_class:"w-full border rounded-xl px-3 py-2" }}
    </div>

    {# ====== BLOQUE FLOTA (nuevo) ====== #}
    <div id="bloque-flota-editar" class="sm:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Veh√≠culo asignado:</label>
        {{ form.vehiculo_flota|add_class:"w-full border rounded-xl px-3 py-2" }}
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Tipo de servicio:</label>
        {{ form.tipo_servicio_flota|add_class:"w-full border rounded-xl px-3 py-2" }}
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Hora del servicio:</label>
        {{ form.hora_servicio_flota|add_class:"w-full border rounded-xl px-3 py-2" }}
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Kilometraje del servicio:</label>
        {{ form.kilometraje_servicio_flota|add_class:"w-full border rounded-xl px-3 py-2" }}
        <p class="text-xs text-gray-500 mt-1 italic">
          Se valida considerando la fecha real del gasto.
        </p>
        <p id="kmFlotaHelpEdit" class="text-sm mt-1 hidden"></p>
      </div>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">Fecha real del gasto:</label>
      {{ form.fecha_transaccion|add_class:"w-full border rounded-xl px-3 py-2" }}
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">RUT Factura:</label>
      {{ form.rut_factura|add_class:"w-full border rounded-xl px-3 py-2" }}
      <small id="razon_social_edit" class="text-xs text-gray-600 italic"></small>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">Tipo de Documento:</label>
      {{ form.tipo_doc|add_class:"w-full border rounded-xl px-3 py-2" }}
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">N√∫mero de Documento:</label>
      {{ form.numero_doc|add_class:"w-full border rounded-xl px-3 py-2" }}
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">Monto:</label>
      {{ form.cargos|add_class:"w-full border rounded-xl px-3 py-2" }}
    </div>

    {# Si el form no tiene este campo, puedes quitar este bloque #}
    {% if form.numero_transferencia %}
    <div>
      <label class="block text-sm font-medium text-gray-700">N¬∞ Transferencia:</label>
      {{ form.numero_transferencia|add_class:"w-full border rounded-xl px-3 py-2" }}
    </div>
    {% endif %}

    <div class="sm:col-span-2">
      <label class="block text-sm font-medium text-gray-700">Observaciones:</label>
      {{ form.observaciones|add_class:"w-full border rounded-xl px-3 py-2" }}
    </div>

    <div class="sm:col-span-2">
      <label class="block text-sm font-medium text-gray-700">Comprobante:</label>

      {% if form.instance.comprobante %}
        <p class="mb-2 text-sm text-gray-600">
          Archivo actual:
          <a href="{{ form.instance.comprobante.url }}" target="_blank" class="text-blue-600 underline">Ver comprobante</a>
        </p>
      {% endif %}

      <div class="flex gap-2">
        <label class="flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full shadow cursor-pointer">
          üì∑ Tomar foto
          <input type="file" id="comprobante_foto_edit" name="comprobante_foto" accept="image/*" capture="environment" class="hidden" />
        </label>

        <label class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-full shadow cursor-pointer">
          üìÑ Subir archivo
          <input type="file" id="comprobante_archivo_edit" name="comprobante_archivo" accept="application/pdf,image/*" class="hidden" />
        </label>
      </div>

      <span id="nombre_comprobante_edit" class="text-sm text-gray-600 italic mt-1 block"></span>
      <img id="preview_comprobante_edit" class="mt-2 max-h-40 rounded shadow hidden">

      <p class="text-xs text-gray-500 mt-1">Sube un nuevo archivo solo si deseas reemplazar el actual.</p>
    </div>

    <div class="sm:col-span-2 flex justify-between gap-2 mt-4">
      <a href="{% url 'operaciones:mis_rendiciones' %}"
         class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-full">Cancelar</a>

      <button type="submit"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-full">
        Guardar Cambios
      </button>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // === Preview nombre/imagen comprobante (editar) ===
  const archivoInput = document.getElementById("comprobante_archivo_edit");
  const fotoInput = document.getElementById("comprobante_foto_edit");
  const nombreSpan = document.getElementById("nombre_comprobante_edit");
  const preview = document.getElementById("preview_comprobante_edit");

  function mostrarArchivo(input) {
    if (!input || !input.files || input.files.length === 0) return;

    const archivo = input.files[0];
    nombreSpan.textContent = "Archivo seleccionado: " + archivo.name;

    if (archivo.type.startsWith("image/")) {
      const reader = new FileReader();
      reader.onload = function (e) {
        preview.src = e.target.result;
        preview.classList.remove("hidden");
      };
      reader.readAsDataURL(archivo);
    } else {
      preview.classList.add("hidden");
      preview.src = "";
    }
  }

  if (archivoInput) archivoInput.addEventListener("change", function () { mostrarArchivo(this); });
  if (fotoInput) fotoInput.addEventListener("change", function () { mostrarArchivo(this); });

  // === Formateo RUT (editar) ===
  const rutInput = document.getElementById("id_rut_factura");
  if (rutInput) {
    rutInput.addEventListener("input", function () {
      let v = this.value.replace(/\./g, '').replace(/-/g, '').replace(/\s/g, '');
      if (v.length > 1) {
        this.value = v.slice(0, -1).replace(/\B(?=(\d{3})+(?!\d))/g, ".") + '-' + v.slice(-1);
      }
    });
  }

  // === Mostrar/Ocultar bloque flota seg√∫n tipo ===
  const tipoRendicion = document.getElementById("id_tipo");
  const bloqueFlota = document.getElementById("bloque-flota-editar");

  function esTipoServicios() {
    if (!tipoRendicion) return false;
    const txt = (tipoRendicion.options[tipoRendicion.selectedIndex]?.text || "").toLowerCase();
    return txt.includes("servicio");
  }

  function toggleBloqueFlota() {
    if (!bloqueFlota) return;
    if (esTipoServicios()) {
      bloqueFlota.classList.remove("hidden");
    } else {
      bloqueFlota.classList.add("hidden");
    }
  }

  if (tipoRendicion) {
    tipoRendicion.addEventListener("change", toggleBloqueFlota);
    toggleBloqueFlota();
  }

  // === Validaci√≥n KM flota en vivo (editar) ===
  const vehiculoInput = document.getElementById("id_vehiculo_flota");
  const fechaInput = document.getElementById("id_fecha_transaccion"); // <- fecha real del gasto
  const horaInput = document.getElementById("id_hora_servicio_flota");
  const kmInput = document.getElementById("id_kilometraje_servicio_flota");
  const kmHelp = document.getElementById("kmFlotaHelpEdit");

  function resetKmUI() {
    if (!kmInput || !kmHelp) return;
    kmInput.classList.remove("border-red-500", "border-green-500");
    kmHelp.classList.add("hidden");
    kmHelp.classList.remove("text-red-600", "text-green-600");
    kmHelp.innerHTML = "";
  }

  async function validarKmFlotaEdit() {
    if (!vehiculoInput || !fechaInput || !horaInput || !kmInput || !kmHelp) return;
    if (!esTipoServicios()) { resetKmUI(); return; }

    const vehiculo = vehiculoInput.value;
    const fecha = fechaInput.value;
    const hora = horaInput.value;
    const km = kmInput.value;

    if (!vehiculo) { resetKmUI(); return; }

    const params = new URLSearchParams({
      vehiculo_id: vehiculo,
      fecha: fecha || "",
      hora: hora || "",
      km: km || ""
    });

    try {
      const resp = await fetch(`{% url 'operaciones:validar_km_servicio_flota_ajax' %}?${params.toString()}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });
      const data = await resp.json();

      if (!resp.ok) {
        kmInput.classList.add("border-red-500");
        kmHelp.classList.remove("hidden");
        kmHelp.classList.add("text-red-600");
        kmHelp.innerHTML = data.msg || "No se pudo validar el kilometraje.";
        return;
      }

      // Falta info para validar todav√≠a
      if (data.skip) {
        resetKmUI();

        if (data.ultimo && (fecha || hora || km)) {
          kmHelp.classList.remove("hidden");
          kmHelp.classList.add("text-gray-500");
          kmHelp.innerHTML = `√öltimo registrado: <strong>${data.ultimo.km}</strong> (${data.ultimo.fecha} ${data.ultimo.hora})`;
        }
        return;
      }

      if (data.ok) {
        kmInput.classList.remove("border-red-500");
        kmInput.classList.add("border-green-500");

        kmHelp.classList.remove("hidden");
        kmHelp.classList.remove("text-red-600");
        kmHelp.classList.add("text-green-600");

        let extra = "";
        if (data.ultimo) {
          extra = ` <span class="text-gray-500">(√öltimo: ${data.ultimo.km} - ${data.ultimo.fecha} ${data.ultimo.hora})</span>`;
        }

        kmHelp.innerHTML = `Kilometraje v√°lido.${extra}`;
      } else {
        kmInput.classList.remove("border-green-500");
        kmInput.classList.add("border-red-500");

        kmHelp.classList.remove("hidden");
        kmHelp.classList.remove("text-green-600");
        kmHelp.classList.add("text-red-600");

        // Mensaje orientado a acci√≥n (como pediste)
        const editUrl = "{% url 'operaciones:editar_rendicion' rendicion.pk %}";
        kmHelp.innerHTML = `
          ${data.msg || "Kilometraje inv√°lido."}
          <br>
          <span class="font-medium">Edita el anterior o modifica la hora del servicio.</span>
          <a href="${editUrl}" class="underline ml-1">Presiona aqu√≠ para editar</a>.
        `;
      }
    } catch (e) {
      kmInput.classList.add("border-red-500");
      kmHelp.classList.remove("hidden");
      kmHelp.classList.add("text-red-600");
      kmHelp.innerHTML = "Error validando el kilometraje.";
    }
  }

  [vehiculoInput, fechaInput, horaInput, kmInput].forEach(el => {
    if (el) el.addEventListener("input", validarKmFlotaEdit);
    if (el && el.tagName === "SELECT") el.addEventListener("change", validarKmFlotaEdit);
  });

  // === Validaci√≥n RUT si es Factura (editar) ===
  const form = document.getElementById("form-editar-rendicion");
  const tipoDoc = document.getElementById("id_tipo_doc");
  const razonSocial = document.getElementById("razon_social_edit");
  const submitBtn = form ? form.querySelector('button[type="submit"]') : null;

  if (!form || !rutInput || !tipoDoc) return;

  let isSubmitting = false;

  function validarRutAjax(rut) {
    return fetch("{% url 'operaciones:validar_rut_ajax' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({ rut: rut })
    }).then(r => r.json());
  }

  form.addEventListener("submit", function (e) {
    if (isSubmitting) {
      e.preventDefault();
      return false;
    }

    const tipo = (tipoDoc.value || "").toLowerCase();
    const rut = (rutInput.value || "").trim();

    isSubmitting = true;
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = (tipo === "factura") ? "Validando..." : "Guardando...";
      submitBtn.classList.add("opacity-60", "cursor-not-allowed");
    }

    if (tipo !== "factura") return true;

    e.preventDefault();

    if (razonSocial) {
      razonSocial.textContent = "Validando RUT...";
      razonSocial.classList.remove("text-green-600", "text-red-600");
      razonSocial.classList.add("text-gray-600");
    }

    validarRutAjax(rut)
      .then(data => {
        if (!data.ok) {
          if (razonSocial) {
            razonSocial.textContent = data.error || "RUT inv√°lido.";
            razonSocial.classList.remove("text-green-600", "text-gray-600");
            razonSocial.classList.add("text-red-600");
          }
          isSubmitting = false;
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = "Guardar Cambios";
            submitBtn.classList.remove("opacity-60", "cursor-not-allowed");
          }
        } else {
          if (razonSocial) {
            razonSocial.textContent = "‚úî " + (data.mensaje || "RUT v√°lido");
            razonSocial.classList.remove("text-red-600", "text-gray-600");
            razonSocial.classList.add("text-green-600");
          }
          form.submit();
        }
      })
      .catch(() => {
        if (razonSocial) {
          razonSocial.textContent = "Error validando el RUT en el SII.";
          razonSocial.classList.remove("text-green-600", "text-gray-600");
          razonSocial.classList.add("text-red-600");
        }
        isSubmitting = false;
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "Guardar Cambios";
          submitBtn.classList.remove("opacity-60", "cursor-not-allowed");
        }
      });
  });
});
</script>
{% endblock %}