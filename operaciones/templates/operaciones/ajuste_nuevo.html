{% extends "dashboard_admin/base.html" %}
{% load humanize %}

{% block title %}{% if modo == "edit" %}Editar ajuste{% else %}Nuevo ajuste{% endif %}{% endblock %}

{% block dashboard_content %}
<div class="max-w-3xl mx-auto bg-white p-6 rounded-2xl shadow mt-6">

  {# ====== CSS para modales sobrepuestos (no interfiere con nada existente) ====== #}
  <style>
    .modal-overlay{
      position: fixed;
      inset: 0;
      z-index: 9999;        /* MUY por encima de todo */
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,.5);
    }
    .modal-overlay.is-open{ display:flex; }
    .modal-card{
      max-width: 28rem;
      width: 100%;
      background: #fff;
      border-radius: 0.75rem;
      padding: 1.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,.2);
    }
    .no-scroll{ overflow:hidden; height:100dvh; }

    /* Compatibilidad con el estilo de "Mis Cotizaciones" */
    [id^="modal-"] {
      position: fixed;
      inset: 0;
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
  </style>

  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-bold">
      {% if modo == "edit" %}✏️ Editar ajuste{% else %}➕ Crear ajuste{% endif %}
    </h1>
    <a href="{% url 'operaciones:produccion_admin' %}"
       class="rounded-full px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm">← Volver</a>
  </div>

  <p class="text-sm text-gray-600 mb-4">
    Genera un <b>Bono</b>, <b>Adelanto</b> o <b>Descuento</b> para uno o más técnicos.
  </p>

  <form id="ajuste-form"
        class="space-y-4"
        method="post"
        action="{% if modo == 'edit' %}{% url 'operaciones:editar_ajuste' initial.id %}{% else %}{% url 'operaciones:crear_ajuste' %}{% endif %}">
    {% csrf_token %}

    {# el backend espera `mes_texto` en formato 'Mes Año' #}
    <input type="hidden" id="ajuste_mes_texto" name="mes_texto" value="{% if modo == 'edit' %}{{ initial.mes_texto }}{% endif %}" required>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="md:col-span-2">
        <label class="block text-sm font-medium">Tipo</label>
        <select name="tipo" class="w-full border rounded-xl px-3 py-2" required>
          <option value="ajuste_bono"      {% if modo == 'edit' and initial.tipo == 'ajuste_bono' %}selected{% endif %}>Bono</option>
          <option value="ajuste_adelanto"  {% if modo == 'edit' and initial.tipo == 'ajuste_adelanto' %}selected{% endif %}>Adelanto</option>
          <option value="ajuste_descuento" {% if modo == 'edit' and initial.tipo == 'ajuste_descuento' %}selected{% endif %}>Descuento</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium">Mes producción o descuento</label>
        <input id="ajuste_mes_picker" type="month" class="w-full border rounded-xl px-3 py-2"
               value="{% if modo == 'edit' %}{{ initial.mes_yyyy_mm }}{% endif %}" required>
      </div>

      <div>
        <label class="block text-sm font-medium">Monto (CLP)</label>
        <input name="monto" type="number" step="0.01" min="0" class="w-full border rounded-xl px-3 py-2"
               value="{% if modo == 'edit' %}{{ initial.monto }}{% endif %}" required>
        <p class="text-xs text-gray-500 mt-1">
          Para <b>Descuento</b> el sistema aplicará el signo negativo automáticamente.
        </p>
      </div>

      <div class="md:col-span-2">
        <label class="block text-sm font-medium">Observación / Detalle</label>
        <textarea name="detalle" class="w-full border rounded-xl px-3 py-2" rows="3"
                  placeholder="Motivo del ajuste" required>{% if modo == 'edit' %}{{ initial.detalle }}{% endif %}</textarea>
      </div>

      <div class="md:col-span-2">
        <label class="block text-sm font-medium">Asignados (uno o más)</label>

        <input id="filtro-usuarios" type="text"
               class="w-full border rounded-xl px-3 py-2 mb-2"
               placeholder="Buscar técnico por nombre o usuario…">

        <div id="ajuste_asignados_wrap"
             class="border rounded-xl p-2 max-h-64 overflow-auto space-y-1">
          <label class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 rounded px-1 py-1">
            <input type="checkbox" id="chk-all-usuarios">
            <span class="text-sm font-medium">Seleccionar todo</span>
          </label>

          {% for u in usuarios %}
            <label class="flex items-center gap-2 usuario-item cursor-pointer hover:bg-gray-50 rounded px-1 py-1">
              <input type="checkbox" name="asignados" value="{{ u.id }}"
                     {% if modo == 'edit' and u.id in initial.asignados_ids %}checked{% endif %}>
              <span class="text-sm">{{ u.get_full_name|default:u.username }}</span>
            </label>
          {% endfor %}
        </div>

        <p class="text-xs text-gray-500 mt-1">
          {% if modo == 'edit' %}
            Se actualizará el ajuste para los usuarios marcados.
          {% else %}
            Se creará un registro separado por cada usuario seleccionado.
          {% endif %}
        </p>
      </div>
    </div>

    <div class="flex justify-end gap-2 pt-2">
      <a href="{% url 'operaciones:produccion_admin' %}"
         class="px-4 py-2 rounded bg-gray-200">Cancelar</a>
      <button type="submit" class="px-4 py-2 rounded bg-amber-600 text-white">
        {% if modo == 'edit' %}Guardar cambios{% else %}Crear ajuste{% endif %}
      </button>
    </div>
  </form>
</div>

<script>
  // ===== Helpers Mes Año (sin pisar valores de edición) =====
  (function(){
    const MONTHS_ES = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    const picker = document.getElementById('ajuste_mes_picker');
    const hidden = document.getElementById('ajuste_mes_texto');

    function toLabel(yyyyMm){
      if(!/^\d{4}-\d{2}$/.test(yyyyMm)) return "";
      const [y,m]=yyyyMm.split("-");
      const i=parseInt(m,10)-1;
      return (MONTHS_ES[i]||"")+" "+y;
    }
    function initDefault(){
      if(!picker || !hidden) return;
      // solo setear por defecto si no viene valor pre-cargado (modo 'nuevo')
      if (!picker.value) {
        const now=new Date();
        const y=now.getFullYear(), m=String(now.getMonth()+1).padStart(2,"0");
        picker.value=`${y}-${m}`;
      }
      if (!hidden.value) hidden.value=toLabel(picker.value);
    }
    document.addEventListener('DOMContentLoaded', initDefault);
    picker?.addEventListener('change', ()=>{ hidden.value = toLabel(picker.value); });
  })();

  // ===== Buscador + seleccionar todo =====
  (function(){
    const wrap  = document.getElementById('ajuste_asignados_wrap');
    const input = document.getElementById('filtro-usuarios');
    const master= document.getElementById('chk-all-usuarios');
    const items = Array.from(wrap.querySelectorAll('.usuario-item'));

    function eachBox() {
      return Array.from(wrap.querySelectorAll('.usuario-item input[type="checkbox"]'));
    }
    function updateMaster() {
      const boxes = eachBox();
      const visible = boxes.filter(cb => cb.closest('.usuario-item').style.display !== 'none');
      const allChecked = visible.length > 0 && visible.every(cb => cb.checked);
      const someChecked = visible.some(cb => cb.checked);
      master.checked = allChecked;
      master.indeterminate = !allChecked && someChecked;
    }
    function setAllOnVisible(checked) {
      eachBox().forEach(cb => {
        const row = cb.closest('.usuario-item');
        if (row.style.display === 'none') return;
        cb.checked = checked;
      });
      updateMaster();
    }
    master?.addEventListener('change', () => setAllOnVisible(master.checked));
    input?.addEventListener('input', () => {
      const q = input.value.trim().toLowerCase();
      items.forEach(li => {
        const show = li.textContent.toLowerCase().includes(q);
        li.style.display = show ? '' : 'none';
      });
      updateMaster();
    });
    wrap.addEventListener('change', (e) => {
      if (e.target.matches('.usuario-item input[type="checkbox"]')) updateMaster();
    });
    updateMaster();
  })();

  // ===== Submit: usa la URL del form (crear o editar) =====
  function getCookie(name){const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');return v? v.pop() : '';}
  const CSRF = getCookie('csrftoken');

  document.getElementById('ajuste-form')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const form = e.currentTarget;
    const fd = new FormData(form);

    // Asignados múltiples → checkboxes marcados
    const checks = document.querySelectorAll('#ajuste_asignados_wrap input[name="asignados"]:checked');
    const users  = Array.from(checks).map(c => c.value);
    if (!users.length) { alert('Selecciona al menos un usuario.'); return; }
    fd.delete('asignados'); users.forEach(u => fd.append('asignados', u));

    try{
      const resp = await fetch(form.action, {
        method:'POST',
        headers:{ 'X-CSRFToken': CSRF, 'X-Requested-With':'XMLHttpRequest', 'Accept':'application/json' },
        body: fd
      });

      // Ambos endpoints pueden devolver redirect clásico; toleramos HTML o JSON
      const ct = resp.headers.get('Content-Type') || '';
      if (ct.includes('application/json')) {
        const data = await resp.json();
        if(!resp.ok || (data.ok === false)) throw new Error((data && data.error) || 'Error guardando ajuste');
      } else if (!resp.ok) {
        throw new Error('Error guardando ajuste');
      }

      // Redirige a la lista con flash
      const to = new URL("{% url 'operaciones:produccion_admin' %}", window.location.origin);
      to.searchParams.set('flash', '{% if modo == "edit" %}ajuste_edit_ok{% else %}ajuste_ok{% endif %}');
      window.location.href = to.toString();

    }catch(err){
      console.error(err);
      const to = new URL("{% url 'operaciones:produccion_admin' %}", window.location.origin);
      to.searchParams.set('flash', '{% if modo == "edit" %}ajuste_edit_err{% else %}ajuste_err{% endif %}');
      window.location.href = to.toString();
    }
  });

  // ===== Utilidades de modal con PORTAL a <body> (soluciona clipping en iOS) =====

  // Guardamos el contenedor original para poder devolver el modal a su sitio
  function __ensureAnchor(modal){
    if (!modal.dataset.anchorId){
      const anchor = document.createElement('span');
      anchor.style.display = 'none';
      anchor.id = 'anchor-' + (modal.id || ('m-' + Math.random().toString(36).slice(2)));
      modal.after(anchor);
      modal.dataset.anchorId = anchor.id;
    }
  }
  function __portalToBody(modal){
    __ensureAnchor(modal);
    if (modal.parentElement !== document.body){
      document.body.appendChild(modal);
    }
    // Asegura overlay y z-index alto
    modal.style.position = 'fixed';
    modal.style.inset = '0';
    modal.style.zIndex = '9999';
  }
  function __restoreFromPortal(modal){
    const anchorId = modal.dataset.anchorId;
    const anchor = anchorId ? document.getElementById(anchorId) : null;
    if (anchor){
      anchor.after(modal);
      // opcional: no removemos el anchor para futuras aperturas
    }
  }

  // Versión compatible con tus modales "Mis Cotizaciones" (toggling de 'hidden')
  function abrirModal(id){
    const el = document.getElementById(id);
    if(!el) return;
    __portalToBody(el);
    el.classList.remove('hidden');
    document.documentElement.classList.add('no-scroll');
    document.body.classList.add('no-scroll');
  }
  function cerrarModal(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.add('hidden');
    __restoreFromPortal(el);
    document.documentElement.classList.remove('no-scroll');
    document.body.classList.remove('no-scroll');
  }

  // También mantenemos API openModal/closeModal por si los usas en otras vistas
  function openModal(id){
    const m = document.getElementById(id);
    if(!m) return;
    __portalToBody(m);
    m.classList.add('is-open');
    document.documentElement.classList.add('no-scroll');
    document.body.classList.add('no-scroll');
  }
  function closeModal(id){
    const m = document.getElementById(id);
    if(!m) return;
    m.classList.remove('is-open');
    __restoreFromPortal(m);
    document.documentElement.classList.remove('no-scroll');
    document.body.classList.remove('no-scroll');
  }

  // Cerrar tocando fuera (funciona para ambos estilos)
  document.addEventListener('click', (e) => {
    // Caso estilo "Mis Cotizaciones"
    const modalA = e.target.closest('[id^="modal-"]');
    if (modalA && e.target === modalA) {
      modalA.classList.add('hidden');
      __restoreFromPortal(modalA);
      document.documentElement.classList.remove('no-scroll');
      document.body.classList.remove('no-scroll');
      return;
    }
    // Caso .modal-overlay
    const modalB = e.target.closest('.modal-overlay.is-open');
    if (modalB && e.target === modalB) {
      modalB.classList.remove('is-open');
      __restoreFromPortal(modalB);
      document.documentElement.classList.remove('no-scroll');
      document.body.classList.remove('no-scroll');
    }
  });

  // Cerrar con Escape (para ambos estilos)
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape'){
      document.querySelectorAll('[id^="modal-"]:not(.hidden)')
        .forEach(m => { m.classList.add('hidden'); __restoreFromPortal(m); });
      document.querySelectorAll('.modal-overlay.is-open')
        .forEach(m => { m.classList.remove('is-open'); __restoreFromPortal(m); });
      document.documentElement.classList.remove('no-scroll');
      document.body.classList.remove('no-scroll');
    }
  });
</script>

{% endblock %}
